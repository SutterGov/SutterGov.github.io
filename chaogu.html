<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨ç‰¹è¯åˆ¸äº¤æ˜“æ‰€ - å®æ—¶äº¤æ˜“ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&family=Roboto+Mono:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            overflow-x: hidden;
        }
        
        .mono { font-family: 'Roboto Mono', monospace; }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        
        .stock-up { color: #ef4444; }
        .stock-down { color: #22c55e; }
        .stock-flat { color: #94a3b8; }
        
        .neon-border {
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.5), 
                        0 0 20px rgba(59, 130, 246, 0.3);
        }
        
        .ticker-wrap {
            width: 100%;
            overflow: hidden;
            background: linear-gradient(90deg, #1e293b 0%, #0f172a 100%);
            border-left: 4px solid #f59e0b;
        }
        
        .ticker {
            display: inline-block;
            white-space: nowrap;
            padding-right: 100%;
            animation: ticker 30s linear infinite;
        }
        
        @keyframes ticker {
            0% { transform: translate3d(0, 0, 0); }
            100% { transform: translate3d(-100%, 0, 0); }
        }
        
        .news-flash {
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.1) 0%, transparent 100%);
            border-left: 3px solid #f59e0b;
        }
        
        .btn-trade {
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
        }
        
        .btn-buy {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.4);
        }
        
        .btn-buy:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px -2px rgba(220, 38, 38, 0.6);
        }
        
        .btn-sell {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            box-shadow: 0 4px 6px -1px rgba(22, 163, 74, 0.4);
        }
        
        .btn-sell:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px -2px rgba(22, 163, 74, 0.6);
        }
        
        .glow-text {
            text-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.9) 100%);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        tr:hover td {
            background-color: rgba(59, 130, 246, 0.1);
            transition: background-color 0.2s;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
            height: 100%;
            transition: width 1s linear;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
        }
        
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(22, 163, 74, 0); }
        }
        
        .flash-red { animation: pulse-red 1s; }
        .flash-green { animation: pulse-green 1s; }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
        }
        
        .report-paper {
            background: #fafaf9;
            color: #1c1917;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Responsive adjustments for report */
        @media (max-width: 768px) {
            .report-paper {
                width: 95%;
                padding: 1rem;
                font-size: 0.875rem;
            }
        }
        
        /* Mini chart canvas styling */
        .mini-chart {
            width: 100px;
            height: 30px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="glass-panel sticky top-0 z-40 border-b border-slate-700">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <div class="text-3xl font-black text-amber-500 glow-text tracking-tighter">
                    SSE<span class="text-sm text-slate-400 font-normal ml-2">è¨ç‰¹è¯åˆ¸äº¤æ˜“æ‰€</span>
                </div>
                <div class="hidden md:flex items-center space-x-2 text-sm text-slate-400">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span>å¸‚åœºäº¤æ˜“ä¸­</span>
                </div>
            </div>
            
            <div class="flex items-center space-x-6">
                <div class="text-right">
                    <div class="text-xs text-slate-400 uppercase tracking-wider">å‰©ä½™æ—¶é—´</div>
                    <div class="text-2xl font-bold mono text-amber-400" id="timer">10:00</div>
                </div>
                <div class="h-8 w-px bg-slate-600"></div>
                <div class="text-right">
                    <div class="text-xs text-slate-400 uppercase tracking-wider">å¯ç”¨èµ„é‡‘</div>
                    <div class="text-2xl font-bold mono text-emerald-400" id="cashDisplay">â‚²100,000.00</div>
                </div>
                <div class="text-right hidden sm:block">
                    <div class="text-xs text-slate-400 uppercase tracking-wider">æ€»èµ„äº§</div>
                    <div class="text-2xl font-bold mono text-blue-400" id="totalAsset">â‚²100,000.00</div>
                </div>
            </div>
        </div>
    </header>

    <!-- News Ticker -->
    <div class="ticker-wrap py-3 border-b border-slate-700 bg-slate-900/50">
        <div class="container mx-auto px-4 flex items-center">
            <span class="text-amber-500 font-bold mr-4 text-sm uppercase tracking-wider whitespace-nowrap">ğŸ“° çªå‘æ–°é—»</span>
            <div class="overflow-hidden flex-1 relative h-6">
                <div id="newsContainer" class="absolute w-full transition-all duration-500">
                    <p class="text-sm text-slate-300 truncate" id="currentNews">æ¬¢è¿æ¥åˆ°è¨ç‰¹è¯åˆ¸äº¤æ˜“æ‰€ï¼Œæ­£åœ¨ç­‰å¾…å¼€å¸‚...</p>
                </div>
            </div>
            <div class="ml-4 text-xs text-slate-500 mono" id="eventCountdown"></div>
        </div>
    </div>

    <!-- Upcoming Events Preview -->
    <div id="previewBar" class="hidden bg-amber-900/30 border-b border-amber-600/30 px-4 py-2">
        <div class="container mx-auto flex items-center text-sm">
            <span class="text-amber-500 font-bold mr-2">â±ï¸ å³å°†å‘ç”Ÿ (5s):</span>
            <span id="previewText" class="text-amber-200 italic"></span>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 container mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Stock List -->
        <div class="lg:col-span-2 space-y-6">
            <div class="glass-panel rounded-lg p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-slate-200 flex items-center">
                        <span class="w-1 h-6 bg-blue-500 rounded-full mr-3"></span>
                        å¸‚åœºè¡Œæƒ…
                    </h2>
                    <div class="flex space-x-2 text-xs">
                        <span class="flex items-center"><span class="w-3 h-3 bg-red-600 rounded-sm mr-1"></span>å›½ä¼</span>
                        <span class="flex items-center"><span class="w-3 h-3 bg-blue-600 rounded-sm mr-1"></span>ç§ä¼</span>
                        <span class="flex items-center"><span class="w-3 h-3 bg-amber-600 rounded-sm mr-1"></span>åœ°æ–¹å›½è¥</span>
                        <span class="flex items-center"><span class="w-3 h-3 bg-purple-600 rounded-sm mr-1"></span>å…šäº§</span>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-slate-400 border-b border-slate-700 text-xs uppercase tracking-wider">
                                <th class="text-left py-3 px-2">è‚¡ç¥¨åç§°/ä»£ç </th>
                                <th class="text-left py-3 px-2">èµ°åŠ¿</th>
                                <th class="text-right py-3 px-2">ç°ä»·</th>
                                <th class="text-right py-3 px-2">æ¶¨è·Œ</th>
                                <th class="text-right py-3 px-2">æˆäº¤é‡</th>
                                <th class="text-center py-3 px-2">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody" class="mono">
                            <!-- Generated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Chart Area -->
            <div class="glass-panel rounded-lg p-4 h-64 flex items-center justify-center border border-slate-700/50 bg-slate-900/30">
                <div class="text-center text-slate-500">
                    <div class="text-4xl mb-2">ğŸ“Š</div>
                    <p>å®æ—¶è¡Œæƒ…å›¾è¡¨</p>
                    <p class="text-xs mt-2">äº¤æ˜“æ´»è·ƒä¸­...</p>
                </div>
            </div>
        </div>

        <!-- Portfolio -->
        <div class="space-y-6">
            <div class="glass-panel rounded-lg p-4">
                <h2 class="text-lg font-bold text-slate-200 mb-4 flex items-center">
                    <span class="w-1 h-6 bg-emerald-500 rounded-full mr-3"></span>
                    æˆ‘çš„æŒä»“
                </h2>
                
                <div id="emptyPortfolio" class="text-center py-8 text-slate-500">
                    <div class="text-3xl mb-2">ğŸ“­</div>
                    <p class="text-sm">æš‚æ— æŒä»“</p>
                    <p class="text-xs mt-1">ç‚¹å‡»"ä¹°å…¥"å¼€å§‹äº¤æ˜“</p>
                </div>
                
                <div id="portfolioList" class="space-y-3 hidden">
                    <!-- Generated by JS -->
                </div>
                
                <div class="mt-4 pt-4 border-t border-slate-700">
                    <div class="flex justify-between text-sm mb-2">
                        <span class="text-slate-400">æµ®åŠ¨ç›ˆäº</span>
                        <span class="mono font-bold" id="floatingPnL">â‚²0.00</span>
                    </div>
                    <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
                        <div id="pnlBar" class="progress-bar w-1/2"></div>
                    </div>
                </div>
            </div>

            <!-- Trade History -->
            <div class="glass-panel rounded-lg p-4 max-h-64 overflow-y-auto">
                <h2 class="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wider">è¿‘æœŸæˆäº¤</h2>
                <div id="tradeHistory" class="space-y-2 text-xs mono">
                    <div class="text-slate-600 italic">ç­‰å¾…ç¬¬ä¸€ç¬”äº¤æ˜“...</div>
                </div>
            </div>
            
            <!-- Control Panel -->
            <div class="glass-panel rounded-lg p-4 border-2 border-amber-500/30">
                <h2 class="text-sm font-bold text-amber-500 mb-3 uppercase tracking-wider">äº¤æ˜“æ§åˆ¶</h2>
                <div class="space-y-3">
                    <button id="startBtn" onclick="startGame()" class="w-full py-3 bg-gradient-to-r from-amber-600 to-amber-700 hover:from-amber-500 hover:to-amber-600 text-white font-bold rounded-lg transition-all shadow-lg shadow-amber-900/50">
                        â–¶ å¼€å§‹äº¤æ˜“ (10åˆ†é’Ÿ)
                    </button>
                    <button id="stopBtn" onclick="stopGame()" disabled class="w-full py-3 bg-slate-700 text-slate-500 font-bold rounded-lg cursor-not-allowed transition-all">
                        â¹ åœæ­¢å¹¶ç”ŸæˆæŠ¥å‘Š
                    </button>
                </div>
                <div class="mt-3 text-xs text-slate-500 text-center">
                    ç‚¹å‡»å¼€å§‹åæ— æ³•æš‚åœï¼Œè¯·è°¨æ…æ“ä½œ
                </div>
            </div>
        </div>
    </main>

    <!-- Report Modal - ä¿®æ”¹ä¸ºè‡ªé€‚åº”ç‰ˆæœ¬ -->
    <div id="reportModal" class="fixed inset-0 z-50 hidden modal-overlay flex items-center justify-center p-2 md:p-4">
        <div class="report-paper w-full max-w-3xl rounded-lg p-4 md:p-8 relative overflow-y-auto" style="max-height: 95vh;">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-amber-600 via-amber-400 to-amber-600"></div>
            
            <div id="reportContent" class="w-full">
                <div class="text-center mb-4 md:mb-6 border-b-2 border-slate-200 pb-4">
                    <h1 class="text-2xl md:text-3xl font-black text-slate-800 mb-1">è¨ç‰¹è¯åˆ¸äº¤æ˜“æ‰€</h1>
                    <p class="text-slate-600 text-xs md:text-sm uppercase tracking-widest">äº¤æ˜“ç»“ç®—æŠ¥å‘Š</p>
                    <div class="mt-2 text-xs text-slate-500 mono">Report ID: <span id="reportId">SSE-2024-888888</span></div>
                </div>

                <div class="grid grid-cols-2 gap-2 md:gap-4 mb-4 md:mb-6 text-xs md:text-sm">
                    <div>
                        <span class="text-slate-500">ç”¨æˆ·å:</span>
                        <span class="font-bold text-slate-800 ml-1 md:ml-2 block md:inline" id="reportUsername">æœªå‘½åäº¤æ˜“å‘˜</span>
                    </div>
                    <div class="md:text-right">
                        <span class="text-slate-500">äº¤æ˜“æ—¶é•¿:</span>
                        <span class="font-bold text-slate-800 ml-1 md:ml-2" id="reportDuration">10:00</span>
                    </div>
                    <div>
                        <span class="text-slate-500">åˆå§‹èµ„é‡‘:</span>
                        <span class="font-bold text-slate-800 ml-1 md:ml-2">â‚²100,000.00</span>
                    </div>
                    <div class="md:text-right">
                        <span class="text-slate-500">æœ€ç»ˆèµ„äº§:</span>
                        <span class="font-bold text-lg md:text-2xl text-amber-600 ml-1 md:ml-2 block md:inline" id="reportFinal">â‚²0.00</span>
                    </div>
                </div>

                <div class="bg-slate-50 rounded-lg p-3 md:p-4 mb-4 md:mb-6 border border-slate-200">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-2">
                        <span class="font-bold text-slate-700 mb-1 md:mb-0">æ€»ç›ˆäº</span>
                        <span class="text-xl md:text-2xl font-black mono" id="reportPnL">+â‚²0.00</span>
                    </div>
                    <div class="flex flex-col md:flex-row justify-between text-xs text-slate-500 gap-1 md:gap-0">
                        <span>æ”¶ç›Šç‡: <span id="reportReturn">0.00%</span></span>
                        <span>æˆäº¤ç¬”æ•°: <span id="reportTrades">0</span></span>
                    </div>
                </div>

                <div class="mb-4">
                    <h3 class="font-bold text-slate-800 mb-2 md:mb-3 border-l-4 border-amber-500 pl-2 md:pl-3 text-sm md:text-base">è¯¦ç»†äº¤æ˜“è®°å½•</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs md:text-xs">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr>
                                    <th class="py-2 px-1 md:px-2 text-left whitespace-nowrap">æ—¶é—´</th>
                                    <th class="py-2 px-1 md:px-2 text-left">è‚¡ç¥¨</th>
                                    <th class="py-2 px-1 md:px-2 text-right whitespace-nowrap">ç±»å‹</th>
                                    <th class="py-2 px-1 md:px-2 text-right">æ•°é‡</th>
                                    <th class="py-2 px-1 md:px-2 text-right whitespace-nowrap">ä»·æ ¼</th>
                                    <th class="py-2 px-1 md:px-2 text-right whitespace-nowrap">é‡‘é¢</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody" class="mono text-slate-700">
                                <!-- Generated -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="text-center text-xs text-slate-400 mt-4 md:mt-8 pt-4 border-t border-slate-200">
                    <p>è¨ç‰¹å›½å®¶é‡‘èç›‘ç®¡å±€ç›‘åˆ¶ | æœ¬æŠ¥å‘Šä»…ä½œæ¨¡æ‹Ÿäº¤æ˜“å‚è€ƒ</p>
                    <p class="mt-1">Generated by Satir Securities Exchange Simulation System</p>
                </div>
            </div>

            <div class="mt-4 md:mt-6 flex flex-col md:flex-row gap-3 sticky bottom-0 bg-inherit pt-2 pb-2 md:pb-0 border-t md:border-0 border-slate-200">
                <input type="text" id="usernameInput" placeholder="è¾“å…¥æ‚¨çš„ç”¨æˆ·å" class="flex-1 px-3 md:px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-amber-500 text-slate-800 text-sm md:text-base w-full">
                <div class="flex gap-2">
                    <button onclick="downloadReport()" class="flex-1 md:flex-none px-4 md:px-6 py-2 bg-amber-600 hover:bg-amber-700 text-white font-bold rounded-lg transition-colors flex items-center justify-center gap-2 text-sm md:text-base whitespace-nowrap">
                        <span>ğŸ“¥</span> ä¸‹è½½æŠ¥å‘Š
                    </button>
                    <button onclick="closeModal()" class="px-3 md:px-4 py-2 border border-slate-300 hover:bg-slate-100 text-slate-600 rounded-lg transition-colors text-sm md:text-base">
                        å…³é—­
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Trade Modal -->
    <div id="tradeModal" class="fixed inset-0 z-50 hidden modal-overlay flex items-center justify-center p-4">
        <div class="bg-slate-800 border border-slate-600 rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-center" id="tradeTitle">ä¹°å…¥è‚¡ç¥¨</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-slate-400 mb-1">è‚¡ç¥¨</label>
                    <div class="text-lg font-bold text-amber-400" id="tradeStockName">--</div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">å½“å‰ä»·æ ¼</label>
                        <div class="text-xl mono" id="tradePrice">--</div>
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">å¯ç”¨èµ„é‡‘</label>
                        <div class="text-xl mono text-emerald-400" id="tradeAvailable">--</div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-slate-400 mb-1">äº¤æ˜“æ•°é‡</label>
                    <input type="number" id="tradeAmount" min="1" value="100" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white focus:border-blue-500 focus:outline-none mono">
                    <div class="flex justify-between mt-1 text-xs text-slate-500">
                        <button onclick="setMaxAmount()" class="hover:text-blue-400">å…¨éƒ¨ä¹°å…¥</button>
                        <span id="maxShares">æœ€å¤šå¯ä¹°: 0è‚¡</span>
                    </div>
                </div>
                <div class="pt-4 border-t border-slate-700 flex gap-3">
                    <button onclick="confirmTrade()" class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors" id="confirmTradeBtn">ç¡®è®¤ä¹°å…¥</button>
                    <button onclick="closeTradeModal()" class="px-4 py-3 border border-slate-600 hover:bg-slate-700 text-slate-300 rounded-lg transition-colors">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            isRunning: false,
            startTime: null,
            timeRemaining: 600,
            cash: 100000,
            portfolio: {}, // {stockId: {quantity, avgCost}}
            trades: [],
            events: [],
            currentEvent: null,
            stockPrices: {},
            priceHistory: {}
        };

        // Stock Definitions
        const stocks = [
            { id: 'SRAIL', name: 'è¨ç‰¹å›½å®¶é“è·¯é›†å›¢', fullname: 'è¨ç‰¹å›½å®¶é“è·¯é›†å›¢ï¼ˆå›½é“ï¼‰', type: 'å›½ä¼', sector: 'åŸºå»º', basePrice: 45.50, volatility: 0.02 },
            { id: 'SSTEL', name: 'è¨ç‰¹å›½å®¶é’¢é“é›†å›¢', fullname: 'è¨ç‰¹å›½å®¶é’¢é“é›†å›¢ï¼ˆå›½é’¢ï¼‰', type: 'å›½ä¼', sector: 'å·¥ä¸š', basePrice: 28.80, volatility: 0.025 },
            { id: 'PML', name: 'å¸•æ¢…æ‹‰é›†å›¢', fullname: 'å¸•æ¢…æ‹‰é›†å›¢ï¼ˆè´¸æ˜“å’Œæˆ¿åœ°äº§ï¼‰', type: 'ç§ä¼', sector: 'è´¸æ˜“', basePrice: 62.30, volatility: 0.03 },
            { id: 'KIR', name: 'åŸºå°”é›†å›¢', fullname: 'åŸºå°”é›†å›¢ï¼ˆè´¸æ˜“å’Œæˆ¿åœ°äº§ï¼‰', type: 'ç§ä¼', sector: 'è´¸æ˜“', basePrice: 55.00, volatility: 0.028 },
            { id: 'GENO', name: 'å‡†å°†åŸæ²¹æ°”é›†å›¢', fullname: 'å‡†å°†åŸæ²¹æ°”é›†å›¢ï¼ˆé”¡è¨æ‹‰çœåœ°æ–¹å›½è¥ï¼‰', type: 'åœ°æ–¹å›½è¥', sector: 'èƒ½æº', basePrice: 38.90, volatility: 0.035 },
            { id: 'MSLM', name: 'ç©†æ–¯æ—é›†å›¢', fullname: 'ç©†æ–¯æ—é›†å›¢ï¼ˆæŸ¯è¥¿æ¯”çœåœ°æ–¹å›½è¥ï¼‰', type: 'åœ°æ–¹å›½è¥', sector: 'ç»¼åˆ', basePrice: 42.50, volatility: 0.022 },
            { id: 'SUPB', name: 'è¶…çº§å°æµ·æ¹¾é›†å›¢', fullname: 'è¶…çº§å°æµ·æ¹¾é›†å›¢ï¼ˆäº”æœˆèŠ±å…šå…šäº§ï¼‰', type: 'å…šäº§', sector: 'ç§‘æŠ€', basePrice: 128.00, volatility: 0.04 },
            { id: 'EHP', name: 'ä¸œé«˜åœ°å†œäº§é›†å›¢', fullname: 'ä¸œé«˜åœ°å†œäº§é›†å›¢ï¼ˆä¸œé«˜åœ°çœåœ°æ–¹å›½è¥ï¼‰', type: 'åœ°æ–¹å›½è¥', sector: 'å†œä¸š', basePrice: 18.60, volatility: 0.018 },
            { id: 'GALT', name: 'é“¶æ²³æ‰˜æ‹‰æ–¯', fullname: 'é“¶æ²³æ‰˜æ‹‰æ–¯ï¼ˆç»¼åˆï¼‰', type: 'ç§ä¼', sector: 'ç»¼åˆ', basePrice: 89.40, volatility: 0.032 },
            { id: 'LIQ', name: 'åˆ©å‹¤ä¼¯é›†å›¢', fullname: 'åˆ©å‹¤ä¼¯é›†å›¢ï¼ˆå®¡è®¡å’Œå¸æ³•ï¼‰', type: 'ç§ä¼', sector: 'æœåŠ¡', basePrice: 35.20, volatility: 0.015 },
            { id: 'MECH', name: 'æœºæ¢°é©å‘½é›†å›¢', fullname: 'æœºæ¢°é©å‘½é›†å›¢ï¼ˆæœºæ¢°åˆ¶é€ ã€ç§‘æŠ€ï¼‰', type: 'ç§ä¼', sector: 'ç§‘æŠ€', basePrice: 76.80, volatility: 0.038 },
            { id: 'SNWD', name: 'å—æ°´åŒ—è°ƒé›†å›¢', fullname: 'å—æ°´åŒ—è°ƒé›†å›¢ï¼ˆæ°´åˆ©ï¼‰', type: 'å›½ä¼', sector: 'åŸºå»º', basePrice: 22.40, volatility: 0.012 },
            { id: 'HRSE', name: 'è¨ç‰¹èµ›é©¬ä¼šé›†å›¢', fullname: 'è¨ç‰¹èµ›é©¬ä¼šé›†å›¢ï¼ˆèµ›é©¬ä½“è‚²å¨±ä¹ï¼‰', type: 'ç§ä¼', sector: 'å¨±ä¹', basePrice: 15.80, volatility: 0.05 },
            { id: 'SSF', name: 'æ–¯å¡æ‹‰å°”ä¸»æƒåŸºé‡‘', fullname: 'æ–¯å¡æ‹‰å°”ä¸»æƒåŸºé‡‘ï¼ˆæ–¯å¡æ‹‰å°”çœåœ°æ–¹å›½è¥ï¼‰', type: 'åœ°æ–¹å›½è¥', sector: 'é‡‘è', basePrice: 95.00, volatility: 0.02 }
        ];

        // 60 Random Events
        const eventTemplates = [
            // æ”¿ç­–ç±» - å›½ä¼åˆ©å¥½
            { title: "å›½å®¶åŸºå»ºåˆºæ¿€è®¡åˆ’", desc: "è¨ç‰¹æ”¿åºœå®£å¸ƒå¯åŠ¨5å¹´10ä¸‡äº¿åŸºå»ºè®¡åˆ’ï¼Œé‡ç‚¹æŠ•èµ„é“è·¯å’Œæ°´åˆ©", effect: { type: ['å›½ä¼'], value: 0.05 }, duration: 20 },
            { title: "å¤®ä¼æ”¹é©æ·±åŒ–", desc: "å›½å®¶æ¨åŠ¨å›½æœ‰ä¼ä¸šæ··åˆæ‰€æœ‰åˆ¶æ”¹é©ï¼Œæå‡ç»è¥æ•ˆç‡", effect: { type: ['å›½ä¼'], value: 0.04 }, duration: 15 },
            { title: "å¤®è¡Œé™æ¯25åŸºç‚¹", desc: "è¨ç‰¹å›½å®¶é“¶è¡Œä¸‹è°ƒåŸºå‡†åˆ©ç‡ï¼Œå¸‚åœºæµåŠ¨æ€§å……è£•", effect: { type: ['all'], value: 0.03 }, duration: 25 },
            { title: "ç¯ä¿æ”¿ç­–æ”¶ç´§", desc: "æ–°çš„ç¢³æ’æ”¾æ ‡å‡†å‡ºå°ï¼Œé«˜è€—èƒ½ä¼ä¸šæˆæœ¬ä¸Šå‡", effect: { type: ['å›½ä¼', 'åœ°æ–¹å›½è¥'], value: -0.03, sector: ['å·¥ä¸š', 'èƒ½æº'] }, duration: 20 },
            
            // åœ°æ–¹æ”¿ç­–
            { title: "é”¡è¨æ‹‰çœå‘ç°æ–°æ²¹ç”°", desc: "å‡†å°†åŸé™„è¿‘å‘ç°å¤§å‹é¡µå²©æ²¹å‚¨å¤‡", effect: { type: ['åœ°æ–¹å›½è¥'], stock: ['GENO'], value: 0.08 }, duration: 30 },
            { title: "æŸ¯è¥¿æ¯”çœè´¸æ˜“åå®š", desc: "ç©†æ–¯æ—é›†å›¢è·å¾—è·¨å¢ƒè´¸æ˜“ç‹¬å®¶ç»è¥æƒ", effect: { type: ['åœ°æ–¹å›½è¥'], stock: ['MSLM'], value: 0.06 }, duration: 25 },
            { title: "ä¸œé«˜åœ°å†œä¸šè¡¥è´´", desc: "çœæ”¿åºœå¢åŠ å°éº¦ç§æ¤è¡¥è´´30%", effect: { type: ['åœ°æ–¹å›½è¥'], stock: ['EHP'], value: 0.05 }, duration: 20 },
            { title: "æ–¯å¡æ‹‰å°”é‡‘èåˆ›æ–°", desc: "çœé™…é‡‘èä¸­å¿ƒåœ°ä½ç¡®ç«‹ï¼Œæ”¿ç­–æ”¯æŒåŠ›åº¦åŠ å¤§", effect: { type: ['åœ°æ–¹å›½è¥'], stock: ['SSF'], value: 0.04 }, duration: 18 },
            
            // å…šäº§ç‰¹æ®Š
            { title: "äº”æœˆèŠ±å…šä»£è¡¨å¤§ä¼š", desc: "å…šäº§ä¼ä¸šè·å¾—æ–°ä¸€è½®æ³¨èµ„ï¼Œç§‘æŠ€åˆ›æ–°åŸºé‡‘æˆç«‹", effect: { type: ['å…šäº§'], value: 0.06 }, duration: 22 },
            { title: "å…šçºªæ•´é£è¿åŠ¨", desc: "å…šäº§ä¼ä¸šé¢ä¸´æ›´ä¸¥æ ¼çš„å®¡è®¡å’Œç›‘ç®¡", effect: { type: ['å…šäº§'], value: -0.04 }, duration: 15 },
            
            // å›½é™…ç¯å¢ƒ
            { title: "å›½é™…è´¸æ˜“åå®šç­¾ç½²", desc: "è¨ç‰¹ä¸é‚»å›½ç­¾ç½²è‡ªç”±è´¸æ˜“åå®šï¼Œå…³ç¨å¤§å¹…é™ä½", effect: { sector: ['è´¸æ˜“'], value: 0.05 }, duration: 25 },
            { title: "å…¨çƒé‡‘èå±æœºé¢„è­¦", desc: "å›½é™…è´§å¸åŸºé‡‘ç»„ç»‡ä¸‹è°ƒå…¨çƒå¢é•¿é¢„æœŸ", effect: { type: ['all'], value: -0.04 }, duration: 20 },
            { title: "åˆ¶è£å¨èƒ", desc: "æµ·å¤–å¸‚åœºè€ƒè™‘å¯¹è¨ç‰¹å®æ–½æŠ€æœ¯å°é”", effect: { sector: ['ç§‘æŠ€'], value: -0.05 }, duration: 18 },
            { title: "èƒ½æºä»·æ ¼ä¸Šæ¶¨", desc: "å›½é™…æ²¹ä»·çªç ´æ¯æ¡¶100ç¾å…ƒ", effect: { sector: ['èƒ½æº'], value: 0.06 }, duration: 25 },
            { title: "ç²®é£Ÿå±æœº", desc: "å…¨çƒç²®é£ŸçŸ­ç¼ºå¯¼è‡´å†œäº§å“ä»·æ ¼é£™å‡", effect: { sector: ['å†œä¸š'], value: 0.07 }, duration: 28 },
            { title: "æˆ˜äº‰é˜´äº‘", desc: "è¾¹å¢ƒç´§å¼ å±€åŠ¿å‡çº§ï¼Œå›½é˜²å¼€æ”¯é¢„æœŸå¢åŠ ", effect: { sector: ['å·¥ä¸š'], value: 0.04 }, duration: 22 },
            
            // è¡Œä¸šç‰¹å®š
            { title: "é«˜é“æŠ€æœ¯çªç ´", desc: "å›½é“é›†å›¢æŒæ¡æ–°ä¸€ä»£ç£æ‚¬æµ®æŠ€æœ¯", effect: { stock: ['SRAIL'], value: 0.06 }, duration: 20 },
            { title: "é’¢é“äº§èƒ½è¿‡å‰©", desc: "å…¨å›½é’¢é“åº“å­˜åˆ›5å¹´æ–°é«˜ï¼Œä»·æ ¼ä¸‹è·Œ", effect: { stock: ['SSTEL'], value: -0.05 }, duration: 25 },
            { title: "æˆ¿åœ°äº§æ³¡æ²«ç ´è£‚", desc: "ä¸€çº¿åŸå¸‚æˆ¿ä»·è¿ç»­ä¸‰æœˆä¸‹è·Œï¼Œæˆ¿ä¼å€ºåŠ¡å±æœº", effect: { sector: ['è´¸æ˜“'], value: -0.06 }, duration: 30 },
            { title: "çŸ³æ²¹ç®¡é“æ³„æ¼", desc: "å‡†å°†åŸä¸»è¦ç®¡é“å‘ç”Ÿæ³„æ¼äº‹æ•…ï¼Œåœäº§æ£€ä¿®", effect: { stock: ['GENO'], value: -0.07 }, duration: 15 },
            { title: "åŒºå—é“¾é©å‘½", desc: "å…šäº§ä¼ä¸šå®£å¸ƒé‡‡ç”¨åŒºå—é“¾æŠ€æœ¯æ”¹é€ ä¾›åº”é“¾", effect: { stock: ['SUPB'], value: 0.08 }, duration: 20 },
            { title: "å¹²æ—±é¢„è­¦", desc: "ä¸œé«˜åœ°çœé­é‡ç½•è§æ—±ç¾ï¼Œå†œä½œç‰©å‡äº§", effect: { stock: ['EHP'], value: -0.06 }, duration: 25 },
            { title: "åå„æ–­è°ƒæŸ¥", desc: "é“¶æ²³æ‰˜æ‹‰æ–¯æ¶‰å«Œå„æ–­è¢«è°ƒæŸ¥ç»„è¿›é©»", effect: { stock: ['GALT'], value: -0.05 }, duration: 20 },
            { title: "å¸æ³•æ”¹é©æ³•æ¡ˆ", desc: "æ–°å¢å®¡è®¡éœ€æ±‚çˆ†å‘ï¼Œåˆ©å‹¤ä¼¯è®¢å•é¥±æ»¡", effect: { stock: ['LIQ'], value: 0.05 }, duration: 18 },
            { title: "AIæŠ€æœ¯çªç ´", desc: "æœºæ¢°é©å‘½é›†å›¢å‘å¸ƒæ–°ä¸€ä»£å·¥ä¸šæœºå™¨äºº", effect: { stock: ['MECH'], value: 0.07 }, duration: 24 },
            { title: "æ´ªæ¶ç¾å®³", desc: "å—æ°´åŒ—è°ƒå·¥ç¨‹å‘æŒ¥é˜²æ´ªæ•ˆç›Šï¼Œè·é¢å¤–æ‹¨æ¬¾", effect: { stock: ['SNWD'], value: 0.04 }, duration: 20 },
            { title: "èµ›é©¬ä¸‘é—»", desc: "è¨ç‰¹èµ›é©¬ä¼šè¢«æ›ç¦è¯ä¸‘é—»ï¼Œè‚¡ä»·å¤§è·Œ", effect: { stock: ['HRSE'], value: -0.08 }, duration: 30 },
            { title: "ä¸»æƒè´¢å¯ŒåŸºé‡‘æ‰©å¼ ", desc: "æ–¯å¡æ‹‰å°”åŸºé‡‘æ”¶è´­æµ·å¤–ä¼˜è´¨èµ„äº§", effect: { stock: ['SSF'], value: 0.05 }, duration: 22 },
            
            // ç¤¾ä¼šäº‹ä»¶
            { title: "å¤§ç½¢å·¥", desc: "å…¨å›½é“è·¯å·¥äººç½¢å·¥ä¸‰å¤©ï¼Œè¿è¾“ä¸­æ–­", effect: { stock: ['SRAIL'], value: -0.05 }, duration: 18 },
            { title: "ç–«æƒ…çˆ†å‘", desc: "æ–°å‹æµæ„Ÿä¼ æ’­ï¼Œå…¨å›½è¿›å…¥é˜²ç–«çŠ¶æ€", effect: { type: ['all'], value: -0.03 }, duration: 25 },
            { title: "ææ€–è¢­å‡»", desc: "é¦–éƒ½å‘ç”Ÿçˆ†ç‚¸äº‹ä»¶ï¼Œå¸‚åœºææ…Œ", effect: { type: ['all'], value: -0.05 }, duration: 15 },
            { title: "å›½åº†é˜…å…µ", desc: "å›½å®¶å®åŠ›å±•ç¤ºææŒ¯æ°‘ä¼—ä¿¡å¿ƒ", effect: { type: ['å›½ä¼'], value: 0.03 }, duration: 20 },
            { title: "é¢†å¯¼äººæ›´è¿­", desc: "æ–°ä¸€å±Šæ”¿åºœå¼ºè°ƒå¸‚åœºåŒ–æ”¹é©", effect: { type: ['ç§ä¼'], value: 0.04 }, duration: 25 },
            
            // ä¼ä¸šç‰¹å®š
            { title: "å¸•æ¢…æ‹‰é›†å›¢å¹¶è´­", desc: "æ”¶è´­ç«äº‰å¯¹æ‰‹ï¼Œå¸‚åœºä»½é¢æå‡", effect: { stock: ['PML'], value: 0.05 }, duration: 20 },
            { title: "åŸºå°”é›†å›¢å€ºåŠ¡è¿çº¦", desc: "æ— æ³•æŒ‰æœŸå¿è¿˜å€ºåˆ¸ï¼Œä¿¡ç”¨è¯„çº§ä¸‹è°ƒ", effect: { stock: ['KIR'], value: -0.08 }, duration: 28 },
            { title: "æŠ€æœ¯æ³„å¯†", desc: "æœºæ¢°é©å‘½æ ¸å¿ƒå›¾çº¸è¢«ç«äº‰å¯¹æ‰‹çªƒå–", effect: { stock: ['MECH'], value: -0.06 }, duration: 22 },
            { title: "é‡å¤§åˆåŒ", desc: "é“¶æ²³æ‰˜æ‹‰æ–¯ä¸­æ ‡æµ·å¤–åŸºå»ºé¡¹ç›®", effect: { stock: ['GALT'], value: 0.06 }, duration: 25 },
            { title: "åˆ†çº¢é¢„æ¡ˆ", desc: "å¤šå®¶ä¼ä¸šå®£å¸ƒé«˜åˆ†çº¢é€è½¬æ–¹æ¡ˆ", effect: { type: ['all'], value: 0.02 }, duration: 15 },
            
            // é»‘å¤©é¹…
            { title: "åœ°éœ‡è¢­å‡»ä¸œé«˜åœ°", desc: "7çº§åœ°éœ‡æ‘§æ¯ä¸»è¦å†œä¸šåŸºç¡€è®¾æ–½", effect: { stock: ['EHP'], value: -0.12 }, duration: 35 },
            { title: "çŸ³æ²¹å›½æœ‰åŒ–æ³•æ¡ˆ", desc: "è®®ä¼šè®¨è®ºèƒ½æºè¡Œä¸šå›½æœ‰åŒ–ï¼Œç§ä¼ææ…Œ", effect: { type: ['ç§ä¼'], sector: ['èƒ½æº'], value: -0.08 }, duration: 30 },
            { title: "è´§å¸è´¬å€¼", desc: "è¥¿æ ¼å°”åŸºå…ƒå…‘ç¾å…ƒæ±‡ç‡æš´è·Œ10%", effect: { type: ['all'], value: -0.05 }, duration: 25 },
            { title: "å¤–æ˜Ÿæ¥è§¦", desc: "å¤©æ–‡å­¦å®¶ç¡®è®¤æ”¶åˆ°å¤–æ˜Ÿä¿¡å·ï¼Œç§‘æŠ€è‚¡æš´æ¶¨", effect: { sector: ['ç§‘æŠ€'], value: 0.10 }, duration: 40 },
            { title: "å°¤é‡Œå¡æ—¶åˆ»", desc: "å›½é’¢å®éªŒå®¤å‘ç°å®¤æ¸©è¶…å¯¼ææ–™", effect: { stock: ['SSTEL'], value: 0.15 }, duration: 35 },
            
            // è¡¥å……äº‹ä»¶å‡‘å¤Ÿ60ä¸ª
            { title: "ç¨æ”¶ä¼˜æƒ ", desc: "åˆ¶é€ ä¸šå¢å€¼ç¨ç‡ä¸‹è°ƒ2ä¸ªç™¾åˆ†ç‚¹", effect: { sector: ['å·¥ä¸š', 'ç§‘æŠ€'], value: 0.04 }, duration: 20 },
            { title: "åˆ©ç‡å¸‚åœºåŒ–", desc: "å­˜æ¬¾åˆ©ç‡ä¸Šé™æ”¾å¼€ï¼Œé“¶è¡Œè‚¡å—ç›Š", effect: { type: ['åœ°æ–¹å›½è¥'], stock: ['SSF'], value: 0.04 }, duration: 22 },
            { title: "å…»è€é‡‘å…¥å¸‚", desc: "ç¤¾ä¿åŸºé‡‘è·å‡†æŠ•èµ„è‚¡å¸‚ï¼Œé•¿æœŸèµ„é‡‘å…¥åœº", effect: { type: ['all'], value: 0.03 }, duration: 25 },
            { title: "QFIIæ‰©å®¹", desc: "å¤–èµ„æŒè‚¡æ¯”ä¾‹ä¸Šé™æé«˜", effect: { type: ['ç§ä¼'], value: 0.04 }, duration: 20 },
            { title: "æˆ¿åœ°äº§è°ƒæ§", desc: "é™è´­é™è´·æ”¿ç­–å†å‡çº§", effect: { sector: ['è´¸æ˜“'], value: -0.04 }, duration: 25 },
            { title: "æ–°èƒ½æºè¡¥è´´é€€å¡", desc: "ç”µåŠ¨æ±½è½¦è¡¥è´´é€å¹´é€’å‡", effect: { sector: ['ç§‘æŠ€'], value: -0.03 }, duration: 18 },
            { title: "5Gå•†ç”¨ç‰Œç…§", desc: "è¶…å°æµ·æ¹¾é›†å›¢è·å¾—5Gè¿è¥è®¸å¯", effect: { stock: ['SUPB'], value: 0.07 }, duration: 24 },
            { title: "é“è·¯ç¥¨ä»·æ”¹é©", desc: "å›½é“è·å¾—è‡ªä¸»å®šä»·æƒ", effect: { stock: ['SRAIL'], value: 0.04 }, duration: 20 },
            { title: "å®¡è®¡é£æš´", desc: "è´¢æ”¿éƒ¨ä¸¥æŸ¥å¤®ä¼è´¦ç›®", effect: { type: ['å›½ä¼'], value: -0.03 }, duration: 22 },
            { title: "å†œæ‘ç”µå•†çˆ†å‘", desc: "å†œäº§å“ä¸Šè¡Œæ¸ é“æ‰“é€š", effect: { stock: ['EHP'], value: 0.05 }, duration: 25 },
            { title: "èµ›é©¬åšå½©åˆæ³•åŒ–", desc: "è¨ç‰¹èµ›é©¬ä¼šè·å¾—åšå½©ç‰Œç…§", effect: { stock: ['HRSE'], value: 0.12 }, duration: 30 },
            { title: "æ°´åˆ©æŠ•èµ„åŠ ç ", desc: "å›½å®¶é˜²æ±›æŠ—æ—±æ€»æŒ‡æŒ¥éƒ¨è¿½åŠ é¢„ç®—", effect: { stock: ['SNWD'], value: 0.06 }, duration: 23 },
            { title: "é’¢é“é™äº§", desc: "å†¬å­£ç¯ä¿é™äº§ä»¤å‘å¸ƒ", effect: { stock: ['SSTEL'], value: 0.05 }, duration: 28 },
            { title: "è´¸æ˜“æˆ˜åœç«", desc: "åŒæ–¹åŒæ„æš‚åœåŠ å¾æ–°å…³ç¨", effect: { sector: ['è´¸æ˜“'], value: 0.06 }, duration: 26 },
            { title: "æ•°æ®æ³„éœ²", desc: "è¶…çº§å°æµ·æ¹¾é›†å›¢ç”¨æˆ·æ•°æ®è¢«ç›—", effect: { stock: ['SUPB'], value: -0.06 }, duration: 20 },
            { title: "ä¸»æƒè¯„çº§ä¸Šè°ƒ", desc: "æ ‡æ™®ä¸Šè°ƒè¨ç‰¹ä¿¡ç”¨è¯„çº§è‡³AA-", effect: { type: ['all'], value: 0.03 }, duration: 22 },
            { title: "èµ„æœ¬å¤–æµ", desc: "å¤–æ±‡å‚¨å¤‡è¿ç»­ä¸‰æœˆä¸‹é™", effect: { type: ['all'], value: -0.04 }, duration: 25 },
            { title: "èŠ¯ç‰‡ç¦è¿", desc: "é«˜ç«¯èŠ¯ç‰‡è¿›å£å—é™ï¼Œç§‘æŠ€ä¼ä¸šå—æŒ«", effect: { sector: ['ç§‘æŠ€'], value: -0.05 }, duration: 28 },
            { title: "é»„é‡‘ä»·æ ¼ä¸Šæ¶¨", desc: "é¿é™©æƒ…ç»ªå‡æ¸©ï¼Œä¸»æƒåŸºé‡‘å—ç›Š", effect: { stock: ['SSF'], value: 0.04 }, duration: 20 },
            { title: "åŒ»ç–—æ”¹é©", desc: "åŒ»ä¿è¦†ç›–èŒƒå›´æ‰©å¤§ï¼ŒæœåŠ¡ä¸šå—ç›Š", effect: { sector: ['æœåŠ¡'], value: 0.03 }, duration: 18 }
        ];

        let timerInterval;
        let priceInterval;
        let eventInterval;
        let upcomingEvent = null;

        function init() {
            stocks.forEach(stock => {
                gameState.stockPrices[stock.id] = stock.basePrice;
                gameState.priceHistory[stock.id] = [stock.basePrice];
                gameState.portfolio[stock.id] = { quantity: 0, avgCost: 0 };
            });
            renderStocks();
            updateDisplay();
        }

        function drawMiniChart(canvasId, data) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width = 100;
            const height = canvas.height = 30;
            
            ctx.clearRect(0, 0, width, height);
            
            if (data.length < 2) return;
            
            const min = Math.min(...data);
            const max = Math.max(...data);
            const range = max - min || 1;
            
            const getX = (i) => (i / (data.length - 1)) * width;
            const getY = (val) => height - ((val - min) / range) * height;
            
            // Determine color based on trend
            const startPrice = data[0];
            const endPrice = data[data.length - 1];
            const color = endPrice >= startPrice ? '#ef4444' : '#22c55e';
            
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            
            data.forEach((price, i) => {
                const x = getX(i);
                const y = getY(price);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            
            ctx.stroke();
            
            // Fill gradient
            ctx.lineTo(width, height);
            ctx.lineTo(0, height);
            ctx.closePath();
            
            const gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, color + '40'); // 25% opacity
            gradient.addColorStop(1, color + '00'); // 0% opacity
            ctx.fillStyle = gradient;
            ctx.fill();
        }

        function renderStocks() {
            const tbody = document.getElementById('stockTableBody');
            tbody.innerHTML = '';
            
            stocks.forEach(stock => {
                const price = gameState.stockPrices[stock.id];
                const change = ((price - stock.basePrice) / stock.basePrice * 100).toFixed(2);
                const changeClass = change > 0 ? 'stock-up' : change < 0 ? 'stock-down' : 'stock-flat';
                const typeColor = stock.type === 'å›½ä¼' ? 'bg-red-600' : 
                                 stock.type === 'ç§ä¼' ? 'bg-blue-600' : 
                                 stock.type === 'å…šäº§' ? 'bg-purple-600' : 'bg-amber-600';
                
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-800 transition-colors';
                row.innerHTML = `
                    <td class="py-3 px-2">
                        <div class="flex items-center">
                            <span class="w-2 h-2 rounded-full ${typeColor} mr-2"></span>
                            <div>
                                <div class="font-bold text-slate-200">${stock.name}</div>
                                <div class="text-xs text-slate-500">${stock.id} | ${stock.type}</div>
                            </div>
                        </div>
                    </td>
                    <td class="py-3 px-2">
                        <canvas id="chart-${stock.id}" class="mini-chart" width="100" height="30"></canvas>
                    </td>
                    <td class="py-3 px-2 text-right font-bold mono text-lg">â‚²${price.toFixed(2)}</td>
                    <td class="py-3 px-2 text-right mono ${changeClass}">${change > 0 ? '+' : ''}${change}%</td>
                    <td class="py-3 px-2 text-right text-xs text-slate-400">${(Math.random()*10000+1000).toFixed(0)}</td>
                    <td class="py-3 px-2 text-center">
                        <button onclick="openTrade('${stock.id}', 'buy')" class="btn-trade btn-buy px-3 py-1 rounded text-xs mr-1">ä¹°å…¥</button>
                        <button onclick="openTrade('${stock.id}', 'sell')" class="btn-trade btn-sell px-3 py-1 rounded text-xs">å–å‡º</button>
                    </td>
                `;
                tbody.appendChild(row);
                
                // Draw chart immediately after adding to DOM
                setTimeout(() => drawMiniChart(`chart-${stock.id}`, gameState.priceHistory[stock.id]), 0);
            });
        }

        function startGame() {
            if (gameState.isRunning) return;
            
            gameState.isRunning = true;
            gameState.startTime = Date.now();
            gameState.timeRemaining = 600;
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').classList.add('opacity-50', 'cursor-not-allowed');
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('stopBtn').classList.remove('bg-slate-700', 'text-slate-500', 'cursor-not-allowed');
            document.getElementById('stopBtn').classList.add('bg-red-600', 'hover:bg-red-700', 'text-white');
            
            // Timer
            timerInterval = setInterval(() => {
                gameState.timeRemaining--;
                updateTimer();
                if (gameState.timeRemaining <= 0) stopGame();
            }, 1000);
            
            // Price updates every 2s
            priceInterval = setInterval(updatePrices, 2000);
            
            // Events every 10s (with 5s preview)
            eventInterval = setInterval(scheduleEvent, 10000);
            scheduleEvent(); // First event immediately
            
            addNews("äº¤æ˜“å¼€å§‹ï¼å¸‚åœºå¼€ç›˜ï¼Œç¥ä½ å¥½è¿ï¼ğŸš€", "system");
        }

        function scheduleEvent() {
            if (!gameState.isRunning) return;
            
            // Select random event
            const event = {...eventTemplates[Math.floor(Math.random() * eventTemplates.length)]};
            upcomingEvent = event;
            
            // Show preview
            document.getElementById('previewBar').classList.remove('hidden');
            document.getElementById('previewText').textContent = `[ä¼ é—»] ${event.title}`;
            document.getElementById('eventCountdown').textContent = '5s';
            
            let countdown = 5;
            const countdownInt = setInterval(() => {
                countdown--;
                document.getElementById('eventCountdown').textContent = countdown + 's';
                if (countdown <= 0) {
                    clearInterval(countdownInt);
                    triggerEvent(event);
                }
            }, 1000);
        }

        function triggerEvent(event) {
            document.getElementById('previewBar').classList.add('hidden');
            document.getElementById('eventCountdown').textContent = '';
            
            addNews(`ã€çªå‘ã€‘${event.title}: ${event.desc}`, "event");
            
            // Apply effect
            gameState.events.push({
                ...event,
                endTime: Date.now() + event.duration * 1000
            });
            
            // Visual feedback
            const newsContainer = document.getElementById('newsContainer');
            newsContainer.classList.add(event.effect.value > 0 ? 'flash-green' : 'flash-red');
            setTimeout(() => newsContainer.classList.remove('flash-green', 'flash-red'), 1000);
        }

        function updatePrices() {
            stocks.forEach(stock => {
                let price = gameState.stockPrices[stock.id];
                let change = 1 + (Math.random() - 0.5) * stock.volatility;
                
                // Apply active events
                gameState.events = gameState.events.filter(e => e.endTime > Date.now());
                gameState.events.forEach(event => {
                    let applies = false;
                    if (event.effect.type && event.effect.type.includes('all')) applies = true;
                    if (event.effect.type && event.effect.type.includes(stock.type)) applies = true;
                    if (event.effect.sector && event.effect.sector.includes(stock.sector)) applies = true;
                    if (event.effect.stock && event.effect.stock.includes(stock.id)) applies = true;
                    
                    if (applies) {
                        change *= (1 + event.effect.value * 0.1); // Dampen the effect
                    }
                });
                
                price *= change;
                price = Math.max(price, stock.basePrice * 0.3); // Floor at 30% of base
                gameState.stockPrices[stock.id] = price;
                gameState.priceHistory[stock.id].push(price);
            });
            
            renderStocks();
            updatePortfolio();
            updateDisplay();
        }

        function addNews(text, type) {
            const div = document.getElementById('currentNews');
            div.style.opacity = 0;
            setTimeout(() => {
                div.textContent = text;
                div.style.opacity = 1;
            }, 200);
        }

        function updateTimer() {
            const m = Math.floor(gameState.timeRemaining / 60).toString().padStart(2, '0');
            const s = (gameState.timeRemaining % 60).toString().padStart(2, '0');
            document.getElementById('timer').textContent = `${m}:${s}`;
        }

        function updateDisplay() {
            document.getElementById('cashDisplay').textContent = 'â‚²' + gameState.cash.toLocaleString('en-US', {minimumFractionDigits: 2});
            
            let total = gameState.cash;
            stocks.forEach(stock => {
                const pos = gameState.portfolio[stock.id];
                if (pos.quantity > 0) {
                    total += pos.quantity * gameState.stockPrices[stock.id];
                }
            });
            document.getElementById('totalAsset').textContent = 'â‚²' + total.toLocaleString('en-US', {minimumFractionDigits: 2});
        }

        function updatePortfolio() {
            const container = document.getElementById('portfolioList');
            const emptyMsg = document.getElementById('emptyPortfolio');
            let hasPosition = false;
            let totalPnL = 0;
            
            container.innerHTML = '';
            
            stocks.forEach(stock => {
                const pos = gameState.portfolio[stock.id];
                if (pos.quantity > 0) {
                    hasPosition = true;
                    const currentPrice = gameState.stockPrices[stock.id];
                    const marketValue = pos.quantity * currentPrice;
                    const costBasis = pos.quantity * pos.avgCost;
                    const pnl = marketValue - costBasis;
                    totalPnL += pnl;
                    
                    const pnlClass = pnl >= 0 ? 'text-red-500' : 'text-green-500';
                    
                    const div = document.createElement('div');
                    div.className = 'bg-slate-800/50 rounded p-3 border border-slate-700 flex justify-between items-center';
                    div.innerHTML = `
                        <div>
                            <div class="font-bold text-sm">${stock.name}</div>
                            <div class="text-xs text-slate-500 mono">${pos.quantity}è‚¡ Ã— â‚²${pos.avgCost.toFixed(2)}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold mono">â‚²${marketValue.toFixed(2)}</div>
                            <div class="text-xs mono ${pnlClass}">${pnl >= 0 ? '+' : ''}â‚²${pnl.toFixed(2)}</div>
                        </div>
                    `;
                    container.appendChild(div);
                }
            });
            
            if (hasPosition) {
                container.classList.remove('hidden');
                emptyMsg.classList.add('hidden');
            }
            
            const pnlDisplay = document.getElementById('floatingPnL');
            pnlDisplay.textContent = (totalPnL >= 0 ? '+' : '') + 'â‚²' + totalPnL.toLocaleString('en-US', {minimumFractionDigits: 2});
            pnlDisplay.className = 'mono font-bold ' + (totalPnL >= 0 ? 'text-red-500' : 'text-green-500');
            
            // Update PnL bar
            const maxPnL = 50000; // Scale reference
            const percentage = Math.max(0, Math.min(100, (totalPnL + maxPnL) / (2 * maxPnL) * 100));
            document.getElementById('pnlBar').style.width = percentage + '%';
            document.getElementById('pnlBar').className = 'progress-bar ' + (totalPnL >= 0 ? '' : 'bg-gradient-to-r from-gray-600 to-red-600');
        }

        // Trade Modal Logic
        let currentTrade = null;

        function openTrade(stockId, action) {
            if (!gameState.isRunning && gameState.trades.length === 0) {
                alert('è¯·å…ˆç‚¹å‡»"å¼€å§‹äº¤æ˜“"æŒ‰é’®');
                return;
            }
            
            const stock = stocks.find(s => s.id === stockId);
            const price = gameState.stockPrices[stockId];
            
            currentTrade = { stock, action, price };
            
            document.getElementById('tradeTitle').textContent = action === 'buy' ? 'ä¹°å…¥è‚¡ç¥¨' : 'å–å‡ºè‚¡ç¥¨';
            document.getElementById('tradeStockName').textContent = stock.name;
            document.getElementById('tradePrice').textContent = 'â‚²' + price.toFixed(2);
            document.getElementById('tradeAvailable').textContent = 'â‚²' + gameState.cash.toFixed(2);
            document.getElementById('confirmTradeBtn').textContent = action === 'buy' ? 'ç¡®è®¤ä¹°å…¥' : 'ç¡®è®¤å–å‡º';
            document.getElementById('confirmTradeBtn').className = action === 'buy' ? 
                'flex-1 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-colors' :
                'flex-1 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition-colors';
            
            // Calculate max
            const max = action === 'buy' ? Math.floor(gameState.cash / price) : gameState.portfolio[stockId].quantity;
            document.getElementById('maxShares').textContent = `æœ€å¤§å¯${action === 'buy' ? 'ä¹°' : 'å–'}: ${max}è‚¡`;
            document.getElementById('tradeAmount').value = Math.min(100, max);
            document.getElementById('tradeAmount').max = max;
            
            document.getElementById('tradeModal').classList.remove('hidden');
        }

        function setMaxAmount() {
            const max = currentTrade.action === 'buy' ? 
                Math.floor(gameState.cash / currentTrade.price) : 
                gameState.portfolio[currentTrade.stock.id].quantity;
            document.getElementById('tradeAmount').value = max;
        }

        function confirmTrade() {
            const amount = parseInt(document.getElementById('tradeAmount').value);
            if (!amount || amount <= 0) return;
            
            const { stock, action, price } = currentTrade;
            const total = amount * price;
            
            if (action === 'buy') {
                if (total > gameState.cash) {
                    alert('èµ„é‡‘ä¸è¶³');
                    return;
                }
                
                gameState.cash -= total;
                const pos = gameState.portfolio[stock.id];
                const newTotalCost = pos.quantity * pos.avgCost + total;
                pos.quantity += amount;
                pos.avgCost = newTotalCost / pos.quantity;
                
                logTrade('ä¹°å…¥', stock, amount, price, total);
            } else {
                if (amount > gameState.portfolio[stock.id].quantity) {
                    alert('æŒä»“ä¸è¶³');
                    return;
                }
                
                gameState.cash += total;
                gameState.portfolio[stock.id].quantity -= amount;
                
                logTrade('å–å‡º', stock, amount, price, total);
            }
            
            closeTradeModal();
            updatePortfolio();
            updateDisplay();
        }

        function logTrade(type, stock, amount, price, total) {
            const time = new Date().toLocaleTimeString('zh-CN');
            gameState.trades.push({ time, type, stock: stock.name, amount, price, total });
            
            const history = document.getElementById('tradeHistory');
            if (gameState.trades.length === 1) history.innerHTML = '';
            
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center py-2 border-b border-slate-800/50 ' + (type === 'ä¹°å…¥' ? 'text-red-400' : 'text-green-400');
            div.innerHTML = `
                <span>${time}</span>
                <span class="font-bold">${type}</span>
                <span>${stock.name}</span>
                <span>${amount}è‚¡</span>
                <span class="font-bold">â‚²${price.toFixed(2)}</span>
            `;
            history.insertBefore(div, history.firstChild);
        }

        function closeTradeModal() {
            document.getElementById('tradeModal').classList.add('hidden');
            currentTrade = null;
        }

        function stopGame() {
            if (!gameState.isRunning) return;
            
            clearInterval(timerInterval);
            clearInterval(priceInterval);
            clearInterval(eventInterval);
            
            gameState.isRunning = false;
            
            showReport();
        }

        function showReport() {
            const modal = document.getElementById('reportModal');
            modal.classList.remove('hidden');
            
            // Calculate final stats
            let finalAsset = gameState.cash;
            stocks.forEach(stock => {
                const pos = gameState.portfolio[stock.id];
                if (pos.quantity > 0) {
                    finalAsset += pos.quantity * gameState.stockPrices[stock.id];
                }
            });
            
            const pnl = finalAsset - 100000;
            const returnRate = (pnl / 100000 * 100).toFixed(2);
            
            document.getElementById('reportDuration').textContent = document.getElementById('timer').textContent;
            document.getElementById('reportFinal').textContent = 'â‚²' + finalAsset.toLocaleString('en-US', {minimumFractionDigits: 2});
            
            const pnlEl = document.getElementById('reportPnL');
            pnlEl.textContent = (pnl >= 0 ? '+' : '') + 'â‚²' + pnl.toLocaleString('en-US', {minimumFractionDigits: 2});
            pnlEl.className = 'text-2xl font-black mono ' + (pnl >= 0 ? 'text-red-600' : 'text-green-600');
            
            document.getElementById('reportReturn').textContent = (pnl >= 0 ? '+' : '') + returnRate + '%';
            document.getElementById('reportTrades').textContent = gameState.trades.length;
            document.getElementById('reportId').textContent = 'SSE-' + new Date().getFullYear() + '-' + Math.floor(100000 + Math.random() * 899999);
            
            // Fill trade table
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = '';
            gameState.trades.forEach(trade => {
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-100';
                row.innerHTML = `
                    <td class="py-2 px-1 md:px-2 whitespace-nowrap">${trade.time}</td>
                    <td class="py-2 px-1 md:px-2 font-bold">${trade.stock}</td>
                    <td class="py-2 px-1 md:px-2 text-right ${trade.type === 'ä¹°å…¥' ? 'text-red-600' : 'text-green-600'} whitespace-nowrap">${trade.type}</td>
                    <td class="py-2 px-1 md:px-2 text-right">${trade.amount}</td>
                    <td class="py-2 px-1 md:px-2 text-right">â‚²${trade.price.toFixed(2)}</td>
                    <td class="py-2 px-1 md:px-2 text-right font-bold">â‚²${trade.total.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
            
            if (gameState.trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="py-4 text-center text-slate-400 italic">æœ¬å‘¨æœŸæ— äº¤æ˜“è®°å½•</td></tr>';
            }
        }

        function downloadReport() {
            const username = document.getElementById('usernameInput').value || 'åŒ¿åäº¤æ˜“å‘˜';
            document.getElementById('reportUsername').textContent = username;
            
            const reportContent = document.getElementById('reportContent');
            
            html2canvas(reportContent, {
                scale: 2,
                backgroundColor: '#fafaf9',
                logging: false
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `è¨ç‰¹è¯åˆ¸äº¤æ˜“æŠ¥å‘Š_${username}_${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function closeModal() {
            document.getElementById('reportModal').classList.add('hidden');
        }

        // Initialize
        init();
    </script>
</body>
</html>
