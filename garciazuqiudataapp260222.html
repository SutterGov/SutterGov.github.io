<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>加西亚足球APP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#1e3a5f',
                        accent: '#c9a227',
                        dark: { bg: '#121212', surface: '#1e1e1e', border: '#2c2c2c' }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        * { scrollbar-width: none !important; -ms-overflow-style: none !important; }
        *::-webkit-scrollbar { display: none !important; width: 0 !important; height: 0 !important; }
        html, body { font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        body { scrollbar-width: none; -ms-overflow-style: none; }
        body::-webkit-scrollbar { display: none; }
        .news-card { transition: all 0.2s ease; }
        .news-card:active { transform: scale(0.98); opacity: 0.9; }
        .tag-active { position: relative; }
        .tag-active::after { content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 20px; height: 3px; background-color: #10b981; border-radius: 2px; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .bottom-nav-item { transition: all 0.2s; }
        .bottom-nav-item.active { color: #10b981; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .pull-refresh { position: absolute; top: -60px; left: 0; right: 0; height: 60px; display: flex; align-items: center; justify-content: center; transition: transform 0.3s; }
        .pull-refresh-spinner { width: 24px; height: 24px; border: 2px solid #e5e7eb; border-top-color: #10b981; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .refresh-toast { position: fixed; top: 100px; left: 50%; transform: translateX(-50%) translateY(-100px); background: rgba(16, 185, 129, 0.95); color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; opacity: 0; transition: all 0.3s; z-index: 100; pointer-events: none; }
        .refresh-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .scroll-container { overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none; }
        .scroll-container::-webkit-scrollbar { display: none; }
        .team-header { background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%); }
        .team-logo-large { filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
        .stat-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
        .player-card { transition: all 0.2s; }
        .player-card:active { transform: scale(0.98); }
        .position-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
        .position-gk { background: #fbbf24; color: #92400e; }
        .position-df { background: #3b82f6; color: white; }
        .position-mf { background: #10b981; color: white; }
        .position-fw { background: #ef4444; color: white; }
        .rating-badge { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-weight: bold; }
        .tab-active { color: #10b981; border-bottom: 2px solid #10b981; }
        .team-logo-container { display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .team-logo-container img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .team-logo-list { width: 64px; height: 64px; flex-shrink: 0; }
        .team-logo-detail { width: 80px; height: 80px; flex-shrink: 0; }
        .team-logo-small { width: 20px; height: 20px; flex-shrink: 0; }
        .team-logo-match { width: 40px; height: 40px; flex-shrink: 0; }
        .news-team-tag { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; font-size: 11px; color: #10b981; cursor: pointer; transition: all 0.2s; }
        .news-team-tag:hover { background: rgba(16, 185, 129, 0.2); }
        .news-team-tag img { width: 16px; height: 16px; object-fit: contain; }
        .financial-warning { background: linear-gradient(90deg, #fef2f2 0%, #fee2e2 100%); border-left: 4px solid #ef4444; color: #dc2626; padding: 10px 16px; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
        .dark .financial-warning { background: linear-gradient(90deg, #450a0a 0%, #7f1d1d 100%); color: #fca5a5; }
        .article-page { transform: translateX(100%); transition: transform 0.3s ease-out; }
        .article-page.show { transform: translateX(0); }
        .search-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .search-overlay.show { opacity: 1; visibility: visible; }
        .search-page { position: fixed; inset: 0; background: #f3f4f6; z-index: 101; transform: translateY(100%); transition: transform 0.3s ease; display: flex; flex-direction: column; }
        .dark .search-page { background: #121212; }
        .search-page.show { transform: translateY(0); }
        .search-header { background: white; padding: 12px 16px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #e5e7eb; }
        .dark .search-header { background: #1e1e1e; border-color: #2c2c2c; }
        .search-input-wrapper { flex: 1; position: relative; }
        .search-input { width: 100%; background: #f3f4f6; border: none; border-radius: 20px; padding: 10px 40px 10px 16px; font-size: 15px; outline: none; transition: all 0.2s; }
        .dark .search-input { background: #2c2c2c; color: white; }
        .search-input:focus { background: #e5e7eb; }
        .search-clear { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; border-radius: 50%; background: #9ca3af; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transition: opacity 0.2s; font-size: 12px; }
        .search-clear.show { opacity: 1; }
        .search-cancel { color: #6b7280; font-size: 15px; padding: 4px 8px; cursor: pointer; }
        .search-tabs { display: flex; background: white; border-bottom: 1px solid #e5e7eb; padding: 0 16px; }
        .dark .search-tabs { background: #1e1e1e; border-color: #2c2c2c; }
        .search-tab { padding: 12px 16px; font-size: 14px; color: #6b7280; cursor: pointer; position: relative; font-weight: 500; }
        .dark .search-tab { color: #9ca3af; }
        .search-tab.active { color: #10b981; }
        .search-tab.active::after { content: ''; position: absolute; bottom: 0; left: 16px; right: 16px; height: 2px; background: #10b981; border-radius: 2px; }
        .search-content { flex: 1; overflow-y: auto; padding: 16px; }
        .search-section-title { font-size: 13px; color: #9ca3af; margin-bottom: 12px; font-weight: 500; }
        .search-history-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f3f4f6; cursor: pointer; }
        .dark .search-history-item { border-color: #2c2c2c; }
        .search-result-item { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px; }
        .dark .search-result-item { background: #1e1e1e; }
        .search-result-item:active { transform: scale(0.98); opacity: 0.8; }
        .search-hot-item { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; background: white; border-radius: 20px; margin: 0 8px 8px 0; font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .dark .search-hot-item { background: #1e1e1e; }
        .search-hot-item:active { background: #10b981; color: white; }
        .search-highlight { color: #10b981; font-weight: 600; }
        .data-section { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .dark .data-section { background: #1e1e1e; }
        .data-section-title { font-size: 14px; font-weight: bold; color: #374151; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e5e7eb; }
        .dark .data-section-title { color: #e5e7eb; border-color: #374151; }
        .ranking-chart-container { width: 100%; height: 200px; position: relative; }
        .ranking-chart-container canvas { width: 100% !important; height: 100% !important; }
        .scorer-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6; }
        .dark .scorer-item { border-color: #374151; }
        .scorer-item:last-child { border-bottom: none; }
        .honor-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; }
        .honor-badge { background: #fbbf24; color: #92400e; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .honor-badge.second { background: #9ca3af; color: #1f2937; }
        .honor-badge.third { background: #b45309; color: white; }
        .change-text { line-height: 1.6; color: #4b5563; }
        .dark .change-text { color: #9ca3af; }
        
        .match-page-container { background: #f5f5f5; min-height: 100vh; }
        .dark .match-page-container { background: #121212; }
        .match-date-header { 
            background: #e8e8e8; 
            padding: 8px 16px; 
            font-size: 13px; 
            color: #666; 
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .dark .match-date-header { background: #1e1e1e; color: #999; }
        .match-card { 
            background: white; 
            margin: 8px 12px; 
            border-radius: 12px; 
            padding: 16px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .dark .match-card { background: #1e1e1e; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .match-league-tag { 
            display: inline-block; 
            background: #10b981; 
            color: white; 
            padding: 2px 8px; 
            border-radius: 4px; 
            font-size: 11px; 
            font-weight: 600;
            margin-bottom: 12px;
        }
        .match-teams-row { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
        }
        .match-team-info { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            flex: 1;
        }
        .match-team-info.home { align-items: flex-end; padding-right: 16px; }
        .match-team-info.away { align-items: flex-start; padding-left: 16px; }
        .match-team-logo { 
            width: 48px; 
            height: 48px; 
            object-fit: contain; 
            margin-bottom: 8px;
        }
        .match-team-name { 
            font-size: 14px; 
            font-weight: 600; 
            color: #1f2937;
            text-align: center;
        }
        .dark .match-team-name { color: #f3f4f6; }
        .match-score-section { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-width: 80px;
        }
        .match-score { 
            font-size: 28px; 
            font-weight: bold; 
            color: #1f2937;
            font-family: 'Arial', sans-serif;
        }
        .dark .match-score { color: #f3f4f6; }
        .match-status-text { 
            font-size: 12px; 
            color: #999; 
            margin-top: 4px;
        }
        .match-status-live { color: #ef4444; font-weight: 600; }
        .match-round-info { 
            text-align: center; 
            font-size: 12px; 
            color: #999; 
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
        }
        .dark .match-round-info { color: #666; border-color: #2c2c2c; }
        
        .schedule-month-header { 
            background: #f3f4f6; 
            padding: 8px 16px; 
            font-size: 14px; 
            font-weight: 600; 
            color: #6b7280; 
            position: sticky; 
            top: 0; 
            z-index: 10;
        }
        .dark .schedule-month-header { background: #1e1e1e; color: #9ca3af; }
        .schedule-item { 
            background: white; 
            padding: 16px; 
            border-bottom: 1px solid #f3f4f6; 
            display: flex; 
            align-items: center; 
        }
        .dark .schedule-item { background: #1e1e1e; border-color: #2c2c2c; }
        .schedule-date { 
            width: 60px; 
            text-align: center; 
            flex-shrink: 0; 
        }
        .schedule-date-day { 
            font-size: 24px; 
            font-weight: bold; 
            color: #1f2937; 
            line-height: 1; 
        }
        .dark .schedule-date-day { color: #f3f4f6; }
        .schedule-date-week { 
            font-size: 12px; 
            color: #9ca3af; 
            margin-top: 2px; 
        }
        .schedule-info { 
            flex: 1; 
            padding: 0 12px; 
        }
        .schedule-league { 
            font-size: 12px; 
            color: #10b981; 
            margin-bottom: 4px; 
            font-weight: 500;
        }
        .schedule-teams { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        .schedule-team { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            flex: 1; 
        }
        .schedule-team.home { justify-content: flex-end; }
        .schedule-team.away { justify-content: flex-start; }
        .schedule-team-name { 
            font-size: 14px; 
            font-weight: 500; 
            color: #1f2937; 
        }
        .dark .schedule-team-name { color: #f3f4f6; }
        .schedule-score { 
            font-size: 18px; 
            font-weight: bold; 
            color: #1f2937; 
            min-width: 60px; 
            text-align: center; 
        }
        .dark .schedule-score { color: #f3f4f6; }
        .schedule-result { 
            font-size: 12px; 
            padding: 2px 8px; 
            border-radius: 4px; 
            font-weight: 500; 
        }
        .result-win { background: #dcfce7; color: #166534; }
        .dark .result-win { background: #166534; color: #dcfce7; }
        .result-draw { background: #f3f4f6; color: #6b7280; }
        .dark .result-draw { background: #374151; color: #9ca3af; }
        .result-loss { background: #fee2e2; color: #dc2626; }
        .dark .result-loss { background: #7f1d1d; color: #fca5a5; }
        .result-upcoming { color: #9ca3af; }
        
        .pagination { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 16px; 
            padding: 16px; 
        }
        .pagination-btn { 
            padding: 8px 16px; 
            background: #10b981; 
            color: white; 
            border-radius: 8px; 
            font-size: 14px; 
            cursor: pointer; 
            border: none; 
        }
        .pagination-btn:disabled { 
            background: #9ca3af; 
            cursor: not-allowed; 
        }
        .pagination-info { 
            font-size: 14px; 
            color: #6b7280; 
        }
        .dark .pagination-info { color: #9ca3af; }

        .db-nav-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        .dark .db-nav-card {
            background: #1e1e1e;
        }
        .db-nav-card:active {
            transform: scale(0.98);
        }
        .db-nav-card.searchfm {
            border-color: #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(16, 185, 129, 0.1) 100%);
        }
        .db-nav-card.kdocs {
            border-color: #3b82f6;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(59, 130, 246, 0.1) 100%);
        }
        .db-nav-card.fminside {
            border-color: #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, rgba(245, 158, 11, 0.1) 100%);
        }
        .db-nav-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 16px;
        }
        .db-nav-card.searchfm .db-nav-icon {
            background: #10b981;
            color: white;
        }
        .db-nav-card.kdocs .db-nav-icon {
            background: #3b82f6;
            color: white;
        }
        .db-nav-card.fminside .db-nav-icon {
            background: #f59e0b;
            color: white;
        }
        .db-nav-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #1f2937;
        }
        .dark .db-nav-title {
            color: #f3f4f6;
        }
        .db-nav-desc {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.5;
        }
        .dark .db-nav-desc {
            color: #9ca3af;
        }
        .db-nav-arrow {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            font-size: 20px;
        }
        .db-nav-header {
            padding: 20px 16px;
            text-align: center;
        }
        .db-nav-header h2 {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }
        .dark .db-nav-header h2 {
            color: #f3f4f6;
        }
        .db-nav-header p {
            font-size: 14px;
            color: #6b7280;
        }
        .dark .db-nav-header p {
            color: #9ca3af;
        }

        .coach-list-item {
            background: white;
            margin: 8px 12px;
            padding: 16px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .dark .coach-list-item {
            background: #1e1e1e;
        }
        .coach-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #6b7280;
            flex-shrink: 0;
        }
        .dark .coach-avatar {
            background: #2c2c2c;
            color: #9ca3af;
        }
        .coach-info { flex: 1; }
        .coach-name { font-size: 16px; font-weight: 600; color: #1f2937; margin-bottom: 4px; }
        .dark .coach-name { color: #f3f4f6; }
        .coach-record { font-size: 13px; color: #6b7280; }
        .dark .coach-record { color: #9ca3af; }
        .coach-duration { 
            text-align: right; 
            font-size: 13px; 
            color: #6b7280;
        }
        .dark .coach-duration { color: #9ca3af; }
        .coach-current { color: #10b981; font-weight: 600; }
        
        .honor-wall {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 16px;
        }
        .honor-tile {
            background: white;
            border-radius: 12px;
            padding: 16px 8px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .dark .honor-tile {
            background: #1e1e1e;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .honor-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        .honor-count {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 4px;
        }
        .dark .honor-count { color: #f3f4f6; }
        .honor-name {
            font-size: 12px;
            color: #6b7280;
        }
        .dark .honor-name { color: #9ca3af; }
        
        .match-filter-bar {
            background: white;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            overflow-x: auto;
            position: sticky;
            top: 0;
            z-index: 20;
        }
        .dark .match-filter-bar {
            background: #1e1e1e;
            border-color: #2c2c2c;
        }
        .match-filter-select {
            flex: 1;
            min-width: 100px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            font-size: 14px;
            outline: none;
            cursor: pointer;
        }
        .dark .match-filter-select {
            background: #2c2c2c;
            border-color: #374151;
            color: white;
        }
        
        .match-league-tabs {
            display: flex;
            overflow-x: auto;
            padding: 0 12px;
            gap: 16px;
            background: white;
        }
        .dark .match-league-tabs {
            background: #1e1e1e;
        }
        .match-league-tab {
            padding: 12px 4px;
            font-size: 14px;
            color: #6b7280;
            cursor: pointer;
            white-space: nowrap;
            position: relative;
            font-weight: 500;
        }
        .dark .match-league-tab {
            color: #9ca3af;
        }
        .match-league-tab.active {
            color: #10b981;
        }
        .match-league-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #10b981;
            border-radius: 2px;
        }
        
        .season-selector {
            padding: 12px 16px;
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }
        .dark .season-selector {
            background: #1e1e1e;
            border-color: #2c2c2c;
        }
        .season-dropdown {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            font-size: 14px;
            outline: none;
        }
        .dark .season-dropdown {
            background: #2c2c2c;
            border-color: #374151;
            color: white;
        }

        .special-player-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin: 8px 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }
        .dark .special-player-card {
            background: #1e1e1e;
        }
        .special-player-card.free-agent { border-left-color: #10b981; }
        .special-player-card.retired { border-left-color: #6b7280; }
        .special-player-card.transferred { border-left-color: #f59e0b; }
        .special-player-card:active { transform: scale(0.98); }
        .special-player-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .special-player-card.free-agent .special-player-icon { background: #d1fae5; color: #059669; }
        .special-player-card.retired .special-player-icon { background: #f3f4f6; color: #4b5563; }
        .special-player-card.transferred .special-player-icon { background: #fef3c7; color: #d97706; }
        .special-player-info { flex: 1; }
        .special-player-title { font-size: 16px; font-weight: 600; color: #1f2937; margin-bottom: 2px; }
        .dark .special-player-title { color: #f3f4f6; }
        .special-player-count { font-size: 13px; color: #6b7280; }
        .dark .special-player-count { color: #9ca3af; }
        
        .pk-page { transform: translateX(100%); transition: transform 0.3s ease-out; }
        .pk-page.show { transform: translateX(0); }
        .pk-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%);
            color: white;
            padding: 16px;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .pk-vs-badge {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid rgba(255,255,255,0.3);
        }
        .pk-player-header {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        .pk-player-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: bold;
        }
        .pk-comparison-row {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            background: white;
        }
        .dark .pk-comparison-row {
            background: #1e1e1e;
            border-color: #2c2c2c;
        }
        .pk-comparison-row:last-child { border-bottom: none; }
        .pk-stat-name {
            width: 80px;
            text-align: center;
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
        }
        .dark .pk-stat-name { color: #9ca3af; }
        .pk-stat-bar-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .pk-stat-value {
            min-width: 36px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
        }
        .pk-stat-bar {
            flex: 1;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .dark .pk-stat-bar { background: #374151; }
        .pk-stat-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .pk-stat-bar-fill.left { background: #3b82f6; }
        .pk-stat-bar-fill.right { background: #ef4444; }
        .pk-winner { color: #10b981; font-weight: bold; }
        .pk-loser { color: #6b7280; }
        .pk-equal { color: #f59e0b; }
        
        .pk-select-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 80;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            display: flex;
            align-items: flex-end;
        }
        .pk-select-modal.show {
            opacity: 1;
            visibility: visible;
        }
        .pk-select-content {
            background: white;
            width: 100%;
            max-height: 80vh;
            border-radius: 20px 20px 0 0;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .dark .pk-select-content {
            background: #1e1e1e;
        }
        .pk-select-modal.show .pk-select-content {
            transform: translateY(0);
        }
        .pk-select-header {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .dark .pk-select-header { border-color: #2c2c2c; }
        .pk-select-list {
            overflow-y: auto;
            flex: 1;
            padding: 8px 0;
        }
        .pk-select-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .pk-select-item:active { background: #f3f4f6; }
        .dark .pk-select-item:active { background: #2c2c2c; }
        .pk-select-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #6b7280;
        }
        .pk-btn-float {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            cursor: pointer;
            z-index: 30;
            transition: all 0.2s;
        }
        .pk-btn-float:active { transform: scale(0.95); }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .dark .info-row {
            border-color: #374151;
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-label {
            color: #6b7280;
            font-size: 14px;
        }
        .dark .info-label {
            color: #9ca3af;
        }
        .info-value {
            font-weight: 600;
            color: #1f2937;
            font-size: 14px;
            text-align: right;
        }
        .dark .info-value {
            color: #f3f4f6;
        }
        .youth-rank-box {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            margin-top: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .youth-rank-label {
            font-size: 14px;
            opacity: 0.9;
        }
        .youth-rank-value {
            font-size: 20px;
            font-weight: bold;
        }
        
        .error-toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: rgba(239, 68, 68, 0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
            pointer-events: none;
            max-width: 80%;
            text-align: center;
        }
        .error-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* 转会页面样式 */
        .transfer-container {
            background: white;
            min-height: 100vh;
            padding-bottom: 80px;
        }
        .dark .transfer-container {
            background: #121212;
        }
        .transfer-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%);
            color: white;
            padding: 20px 16px;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .transfer-iframe {
            width: 100%;
            height: calc(100vh - 140px);
            border: none;
        }
        .transfer-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        /* 广场页面样式 - 新版推特风格 */
        .square-container {
            background: white;
            min-height: 100vh;
            padding-bottom: 80px;
        }
        .dark .square-container {
            background: #000;
        }
        .square-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .dark .square-header {
            background: rgba(0, 0, 0, 0.9);
            border-color: #2c2c2c;
        }
        .square-title {
            font-size: 17px;
            font-weight: 700;
            color: #0f1419;
            letter-spacing: -0.5px;
        }
        .dark .square-title {
            color: #e7e9ea;
        }
        .square-user-menu {
            position: relative;
        }
        .square-user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }
        .dark .square-user-avatar {
            border-color: #2c2c2c;
        }
        .square-user-avatar:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        .square-login-btn {
            background: #0f1419;
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .square-login-btn:hover {
            background: #272c30;
        }
        .dark .square-login-btn {
            background: #e7e9ea;
            color: #0f1419;
        }
        .dark .square-login-btn:hover {
            background: #d6d9db;
        }
        .square-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s;
            z-index: 60;
            border: 1px solid #e5e7eb;
        }
        .dark .square-menu-dropdown {
            background: #000;
            border-color: #2c2c2c;
            box-shadow: 0 4px 20px rgba(255,255,255,0.1);
        }
        .square-menu-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .square-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: #0f1419;
        }
        .dark .square-menu-item {
            color: #e7e9ea;
        }
        .square-menu-item:first-child {
            border-radius: 12px 12px 0 0;
        }
        .square-menu-item:last-child {
            border-radius: 0 0 12px 12px;
        }
        .square-menu-item:hover {
            background: #f7f9f9;
        }
        .dark .square-menu-item:hover {
            background: #16181c;
        }
        .square-menu-item.danger {
            color: #f4212e;
        }
        .square-menu-item i {
            width: 20px;
            text-align: center;
            color: #536471;
        }
        .dark .square-menu-item i {
            color: #71767b;
        }
        .square-menu-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 4px 0;
        }
        .dark .square-menu-divider {
            background: #2c2c2c;
        }
        
        /* 下拉刷新样式 */
        .square-pull-refresh {
            position: absolute;
            top: -60px;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s;
            z-index: 40;
        }
        .square-pull-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #e5e7eb;
            border-top-color: #1d9bf0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .dark .square-pull-spinner {
            border-color: #333;
            border-top-color: #1d9bf0;
        }
        .square-pull-text {
            color: #536471;
            font-size: 14px;
            margin-left: 8px;
        }
        
        .square-post-input {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px;
            display: flex;
            gap: 12px;
        }
        .dark .square-post-input {
            background: #000;
            border-color: #2c2c2c;
        }
        .square-post-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        .square-input-area {
            flex: 1;
        }
        .square-textarea {
            width: 100%;
            border: none;
            outline: none;
            resize: none;
            font-size: 17px;
            line-height: 1.5;
            min-height: 80px;
            background: transparent;
            color: #0f1419;
            font-family: inherit;
        }
        .dark .square-textarea {
            color: #e7e9ea;
        }
        .square-textarea::placeholder {
            color: #536471;
        }
        .dark .square-textarea::placeholder {
            color: #71767b;
        }
        .square-post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #eff3f4;
        }
        .dark .square-post-actions {
            border-color: #2c2c2c;
        }
        .square-media-btns {
            display: flex;
            gap: 16px;
        }
        .square-media-btn {
            color: #1d9bf0;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            transition: all 0.2s;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .square-media-btn:hover {
            background: rgba(29, 155, 240, 0.1);
        }
        .square-post-submit {
            background: #1d9bf0;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 1;
        }
        .square-post-submit:disabled {
            opacity: 0.5;
            cursor: default;
        }
        .square-post-submit:hover:not(:disabled) {
            background: #1a8cd8;
        }
        .square-feed {
            background: white;
            min-height: calc(100vh - 200px);
            position: relative;
        }
        .dark .square-feed {
            background: #000;
        }
        .square-post {
            background: white;
            padding: 12px 16px;
            border-bottom: 1px solid #eff3f4;
            cursor: pointer;
            transition: background 0.2s;
        }
        .dark .square-post {
            background: #000;
            border-color: #2c2c2c;
        }
        .square-post:hover {
            background: #f7f9f9;
        }
        .dark .square-post:hover {
            background: #080808;
        }
        .square-post-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 4px;
        }
        .square-post-user {
            display: flex;
            gap: 12px;
        }
        .square-post-avatar-small {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            flex-shrink: 0;
        }
        .square-post-info {
            flex: 1;
            min-width: 0;
        }
        .square-post-name-row {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }
        .square-post-username {
            font-weight: 700;
            color: #0f1419;
            font-size: 15px;
            cursor: pointer;
        }
        .dark .square-post-username {
            color: #e7e9ea;
        }
        .square-post-username:hover {
            text-decoration: underline;
        }
        .square-post-handle {
            color: #536471;
            font-size: 15px;
        }
        .dark .square-post-handle {
            color: #71767b;
        }
        .square-post-dot {
            color: #536471;
            font-size: 15px;
        }
        .dark .square-post-dot {
            color: #71767b;
        }
        .square-post-time {
            color: #536471;
            font-size: 15px;
            cursor: pointer;
        }
        .dark .square-post-time {
            color: #71767b;
        }
        .square-post-time:hover {
            text-decoration: underline;
        }
        .square-post-content {
            color: #0f1419;
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 12px;
            word-wrap: break-word;
        }
        .dark .square-post-content {
            color: #e7e9ea;
        }
        .square-post-images {
            display: grid;
            gap: 2px;
            margin-bottom: 12px;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #cfd9de;
        }
        .dark .square-post-images {
            border-color: #2c2c2c;
        }
        .square-post-images.grid-1 {
            grid-template-columns: 1fr;
        }
        .square-post-images.grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }
        .square-post-images.grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }
        .square-post-images.grid-4 {
            grid-template-columns: repeat(2, 1fr);
        }
        .square-post-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            cursor: pointer;
        }
        .square-post-actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 425px;
        }
        .square-action-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #536471;
            font-size: 13px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
            background: transparent;
            border: none;
            outline: none;
        }
        .dark .square-action-btn {
            color: #71767b;
        }
        .square-action-btn:hover {
            background: rgba(29, 155, 240, 0.1);
            color: #1d9bf0;
        }
        .square-action-btn.comment:hover {
            background: rgba(29, 155, 240, 0.1);
            color: #1d9bf0;
        }
        .square-action-btn.repost:hover {
            background: rgba(0, 186, 124, 0.1);
            color: #00ba7c;
        }
        .square-action-btn.like:hover {
            background: rgba(249, 24, 128, 0.1);
            color: #f91880;
        }
        .square-action-btn.share:hover {
            background: rgba(29, 155, 240, 0.1);
            color: #1d9bf0;
        }
        .square-action-btn.liked {
            color: #f91880;
        }
        .square-action-btn.liked:hover {
            background: rgba(249, 24, 128, 0.1);
        }
        .square-action-count {
            font-size: 13px;
            min-width: 16px;
            text-align: center;
        }
        
        /* 登录模态框 */
        .login-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .login-modal.show {
            opacity: 1;
            visibility: visible;
        }
        .login-content {
            background: white;
            width: 100%;
            max-width: 400px;
            border-radius: 20px;
            padding: 24px;
            transform: scale(0.9);
            transition: transform 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }
        .dark .login-content {
            background: #000;
            border: 1px solid #2c2c2c;
        }
        .login-modal.show .login-content {
            transform: scale(1);
        }
        .login-title {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            color: #0f1419;
        }
        .dark .login-title {
            color: #e7e9ea;
        }
        .login-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #cfd9de;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 16px;
            outline: none;
            transition: all 0.2s;
            text-transform: uppercase;
        }
        .dark .login-input {
            background: #000;
            border-color: #333;
            color: #e7e9ea;
        }
        .login-input:focus {
            border-color: #1d9bf0;
            box-shadow: 0 0 0 1px #1d9bf0;
        }
        .login-btn {
            width: 100%;
            padding: 14px;
            background: #0f1419;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .login-btn:hover {
            background: #272c30;
        }
        .dark .login-btn {
            background: #e7e9ea;
            color: #0f1419;
        }
        .dark .login-btn:hover {
            background: #d6d9db;
        }
        .login-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #536471;
        }
        .dark .login-close {
            background: rgba(255,255,255,0.1);
            color: #71767b;
        }
        /* Token输入框 */
        .token-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px dashed #cfd9de;
        }
        .dark .token-section {
            border-color: #333;
        }
        .token-label {
            font-size: 12px;
            color: #536471;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .dark .token-label {
            color: #71767b;
        }
        .token-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #cfd9de;
            border-radius: 8px;
            font-size: 13px;
            outline: none;
            font-family: monospace;
        }
        .dark .token-input {
            background: #000;
            border-color: #333;
            color: #e7e9ea;
        }
        .user-type-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 4px;
            font-weight: 500;
            vertical-align: middle;
        }
        .user-type-team {
            background: #dbeafe;
            color: #1e40af;
        }
        .dark .user-type-team {
            background: #1e3a8a;
            color: #93c5fd;
        }
        .user-type-personal {
            background: #fce7f3;
            color: #be185d;
        }
        .dark .user-type-personal {
            background: #831843;
            color: #fbcfe8;
        }
        .user-type-media {
            background: #fef3c7;
            color: #92400e;
        }
        .dark .user-type-media {
            background: #78350f;
            color: #fde68a;
        }
        /* 用户主页 */
        .profile-page {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 60;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }
        .dark .profile-page {
            background: #000;
        }
        .profile-page.show {
            transform: translateX(0);
        }
        .profile-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .dark .profile-header {
            background: rgba(0, 0, 0, 0.9);
            border-color: #2c2c2c;
        }
        .profile-cover {
            height: 150px;
            background: linear-gradient(135deg, #1d9bf0 0%, #0d8ecf 100%);
            position: relative;
        }
        .profile-info {
            background: white;
            padding: 16px;
            margin-bottom: 1px;
        }
        .dark .profile-info {
            background: #000;
        }
        .profile-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid white;
            object-fit: cover;
            margin-top: -40px;
            position: relative;
            z-index: 1;
        }
        .dark .profile-avatar-large {
            border-color: #000;
        }
        .profile-name {
            font-size: 20px;
            font-weight: 800;
            color: #0f1419;
            margin-top: 8px;
        }
        .dark .profile-name {
            color: #e7e9ea;
        }
        .profile-handle {
            color: #536471;
            font-size: 15px;
            margin-top: 2px;
        }
        .dark .profile-handle {
            color: #71767b;
        }
        .profile-stats {
            display: flex;
            gap: 20px;
            margin-top: 16px;
        }
        .profile-stat {
            display: flex;
            gap: 4px;
            align-items: center;
            cursor: pointer;
        }
        .profile-stat:hover {
            text-decoration: underline;
        }
        .profile-stat-value {
            font-weight: 700;
            color: #0f1419;
            font-size: 14px;
        }
        .dark .profile-stat-value {
            color: #e7e9ea;
        }
        .profile-stat-label {
            color: #536471;
            font-size: 14px;
        }
        .dark .profile-stat-label {
            color: #71767b;
        }
        /* 评论模态框 */
        .comment-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 150;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            display: flex;
            align-items: flex-end;
        }
        .comment-modal.show {
            opacity: 1;
            visibility: visible;
        }
        .comment-content {
            background: white;
            width: 100%;
            max-height: 85vh;
            border-radius: 20px 20px 0 0;
            transform: translateY(100%);
            transition: transform 0.3s;
            display: flex;
            flex-direction: column;
        }
        .dark .comment-content {
            background: #000;
            border-top: 1px solid #2c2c2c;
        }
        .comment-modal.show .comment-content {
            transform: translateY(0);
        }
        .comment-header {
            padding: 16px;
            border-bottom: 1px solid #eff3f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dark .comment-header {
            border-color: #2c2c2c;
        }
        .comment-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        .comment-item {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        .comment-body {
            flex: 1;
        }
        .comment-username {
            font-weight: 700;
            font-size: 15px;
            color: #0f1419;
            margin-bottom: 2px;
        }
        .dark .comment-username {
            color: #e7e9ea;
        }
        .comment-text {
            font-size: 15px;
            color: #0f1419;
            line-height: 1.5;
            margin-top: 4px;
        }
        .dark .comment-text {
            color: #e7e9ea;
        }
        .comment-meta {
            font-size: 13px;
            color: #536471;
            margin-top: 2px;
        }
        .dark .comment-meta {
            color: #71767b;
        }
        .comment-input-area {
            padding: 16px;
            border-top: 1px solid #eff3f4;
            display: flex;
            gap: 12px;
            background: white;
        }
        .dark .comment-input-area {
            border-color: #2c2c2c;
            background: #000;
        }
        .comment-input-wrapper {
            flex: 1;
            position: relative;
        }
        .comment-input {
            width: 100%;
            border: 1px solid #cfd9de;
            border-radius: 20px;
            padding: 10px 16px;
            outline: none;
            font-size: 15px;
            background: transparent;
        }
        .dark .comment-input {
            border-color: #333;
            color: #e7e9ea;
        }
        .comment-submit {
            background: #1d9bf0;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            opacity: 1;
            transition: opacity 0.2s;
        }
        .comment-submit:disabled {
            opacity: 0.5;
        }
        .comment-submit:hover:not(:disabled) {
            background: #1a8cd8;
        }
        /* 图片预览 */
        .image-preview-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .image-preview-modal.show {
            opacity: 1;
            visibility: visible;
        }
        .image-preview-modal img {
            max-width: 95%;
            max-height: 90vh;
            object-fit: contain;
        }
        .image-preview-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 切换账号模态框 */
        .switch-account-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 210;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        .switch-account-modal.show {
            opacity: 1;
            visibility: visible;
        }
        .switch-account-content {
            background: white;
            width: 100%;
            max-height: 70vh;
            border-radius: 20px 20px 0 0;
            transform: translateY(100%);
            transition: transform 0.3s;
            padding-bottom: 20px;
        }
        .dark .switch-account-content {
            background: #000;
            border-top: 1px solid #2c2c2c;
        }
        .switch-account-modal.show .switch-account-content {
            transform: translateY(0);
        }
        .switch-account-header {
            padding: 16px;
            text-align: center;
            border-bottom: 1px solid #eff3f4;
            font-weight: 700;
            font-size: 16px;
        }
        .dark .switch-account-header {
            border-color: #2c2c2c;
        }
        .switch-account-list {
            overflow-y: auto;
            max-height: 50vh;
        }
        .switch-account-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .switch-account-item:hover {
            background: #f7f9f9;
        }
        .dark .switch-account-item:hover {
            background: #16181c;
        }
        .switch-account-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .switch-account-item.active {
            background: rgba(29, 155, 240, 0.1);
        }
        .switch-account-item.active .switch-account-name {
            color: #1d9bf0;
        }
        .switch-account-info {
            flex: 1;
        }
        .switch-account-name {
            font-weight: 700;
            color: #0f1419;
        }
        .dark .switch-account-name {
            color: #e7e9ea;
        }
        .switch-account-type {
            font-size: 13px;
            color: #536471;
        }
        .dark .switch-account-type {
            color: #71767b;
        }
        .switch-account-close {
            padding: 16px;
            text-align: center;
            color: #f4212e;
            font-weight: 700;
            cursor: pointer;
            border-top: 1px solid #eff3f4;
            margin-top: 8px;
        }
        .dark .switch-account-close {
            border-color: #2c2c2c;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-dark-bg text-gray-900 dark:text-gray-100 transition-colors duration-300 pb-16">
    <div id="refreshToast" class="refresh-toast"><i class="fas fa-check-circle mr-1"></i> 已更新</div>
    <div id="errorToast" class="error-toast"></div>
    
    <!-- 登录模态框 -->
    <div id="loginModal" class="login-modal" onclick="closeLoginModal(event)">
        <div class="login-content" onclick="event.stopPropagation()" style="position: relative;">
            <div class="login-close" onclick="closeLoginModal()"><i class="fas fa-times"></i></div>
            <h2 class="login-title">登录广场</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4 text-center">请输入您的登录码</p>
            <input type="text" id="loginCodeInput" class="login-input" placeholder="例如：XXXX" maxlength="20">
            
            <div class="token-section">
                <div class="token-label">
                    <i class="fab fa-github mr-1"></i> GitHub Token (用于发帖和评论)
                </div>
                <input type="password" id="githubTokenInput" class="token-input" placeholder="ghp_xxxxxxxxxxxx">
                <p class="text-xs text-gray-400 mt-2">Token 仅存储在本地，用于调用 GitHub API 发布内容</p>
            </div>
            
            <button class="login-btn" onclick="handleLogin()">登录</button>
            
            <div class="mt-4 text-xs text-gray-400 text-center">
                <p>可用测试账号：</p>
                <p class="mt-1">XXXX</p>
            </div>
        </div>
    </div>

    <!-- 切换账号模态框 -->
    <div id="switchAccountModal" class="switch-account-modal" onclick="closeSwitchAccountModal(event)">
        <div class="switch-account-content" onclick="event.stopPropagation()">
            <div class="switch-account-header">切换媒体账号</div>
            <div class="switch-account-list" id="switchAccountList">
                <!-- 动态生成账号列表 -->
            </div>
            <div class="switch-account-close" onclick="closeSwitchAccountModal()">取消</div>
        </div>
    </div>

    <!-- 评论模态框 -->
    <div id="commentModal" class="comment-modal" onclick="closeCommentModal(event)">
        <div class="comment-content" onclick="event.stopPropagation()">
            <div class="comment-header">
                <h3 class="font-bold text-lg dark:text-gray-100">评论</h3>
                <button onclick="closeCommentModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="commentList" class="comment-list">
                <!-- 评论列表 -->
            </div>
            <div class="comment-input-area">
                <input type="text" id="commentInput" class="comment-input" placeholder="写下你的评论..." onkeypress="handleCommentKeypress(event)">
                <button class="comment-submit" onclick="submitComment()">发送</button>
            </div>
        </div>
    </div>

    <!-- 图片预览 -->
    <div id="imagePreviewModal" class="image-preview-modal" onclick="closeImagePreview()">
        <div class="image-preview-close" onclick="closeImagePreview()"><i class="fas fa-times"></i></div>
        <img id="previewImage" src="" alt="预览">
    </div>

    <!-- 用户主页 -->
    <div id="profilePage" class="profile-page scroll-container">
        <div class="profile-header">
            <button onclick="closeProfilePage()" class="w-10 h-10 flex items-center justify-center -ml-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                <i class="fas fa-arrow-left text-gray-600 dark:text-gray-300 text-xl"></i>
            </button>
            <div class="flex-1">
                <span class="font-bold text-lg dark:text-gray-100 block" id="profileUsername">用户主页</span>
                <span class="text-sm text-gray-500 dark:text-gray-400" id="profilePostCount">0 帖子</span>
            </div>
        </div>
        <div class="profile-cover"></div>
        <div class="profile-info">
            <img id="profileAvatar" src="" alt="" class="profile-avatar-large">
            <div class="flex justify-between items-start mt-2">
                <div>
                    <h1 id="profileName" class="profile-name"></h1>
                    <div id="profileHandle" class="profile-handle"></div>
                    <div class="flex items-center gap-2 mt-1">
                        <span id="profileType" class="user-type-badge"></span>
                        <span id="profileJoinDate" class="text-sm text-gray-500 dark:text-gray-400"></span>
                    </div>
                </div>
            </div>
            <div class="profile-stats">
                <div class="profile-stat">
                    <span id="profileFollowing" class="profile-stat-value">0</span>
                    <span class="profile-stat-label">正在关注</span>
                </div>
                <div class="profile-stat">
                    <span id="profileFollowers" class="profile-stat-value">0</span>
                    <span class="profile-stat-label">关注者</span>
                </div>
            </div>
        </div>
        <div id="profilePostsList" class="square-feed" style="min-height: calc(100vh - 400px);">
            <!-- 用户帖子列表 -->
        </div>
    </div>

    <div id="searchOverlay" class="search-overlay" onclick="closeSearch()"></div>
    <div id="searchPage" class="search-page">
        <div class="search-header">
            <div class="search-input-wrapper">
                <input type="text" id="searchInput" class="search-input" placeholder="搜索球队、球员、新闻、广场..." oninput="handleSearchInput(this.value)" onkeyup="handleSearchKeyup(event)">
                <div id="searchClear" class="search-clear" onclick="clearSearch()"><i class="fas fa-times"></i></div>
            </div>
            <div class="search-cancel" onclick="closeSearch()">取消</div>
        </div>
        <div class="search-tabs">
            <div class="search-tab active" onclick="switchSearchTab('all')" data-tab="all">综合</div>
            <div class="search-tab" onclick="switchSearchTab('team')" data-tab="team">球队</div>
            <div class="search-tab" onclick="switchSearchTab('player')" data-tab="player">球员</div>
            <div class="search-tab" onclick="switchSearchTab('news')" data-tab="news">新闻</div>
            <div class="search-tab" onclick="switchSearchTab('square')" data-tab="square">广场</div>
        </div>
        <div id="searchContent" class="search-content"></div>
    </div>

    <div class="sticky top-0 z-50 bg-white dark:bg-dark-surface border-b border-gray-200 dark:border-dark-border transition-colors duration-300" id="mainHeader">
        <div class="flex justify-between items-center px-4 py-1 text-xs text-gray-500 dark:text-gray-400">
            <span id="clock">16:10</span>
            <div class="flex items-center gap-1">
                <span id="syncStatus" class="text-gray-400 dark:text-gray-500 text-[10px] mr-2">等待刷新</span>
                <span>5G</span><i class="fas fa-signal"></i><i class="fas fa-wifi"></i><i class="fas fa-battery-full"></i>
            </div>
        </div>
        <div class="px-4 py-2 flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center overflow-hidden">
                <img src="https://suttergov.github.io/%E5%8D%81%E5%91%A8%E5%B9%B4%E7%BA%AA%E5%BF%B5.png" alt="avatar" class="w-full h-full object-cover">
            </div>
            <div class="flex-1 relative" onclick="openSearch()">
                <div class="w-full bg-gray-100 dark:bg-dark-border text-sm px-4 py-2 rounded-full flex items-center text-gray-400 cursor-pointer">
                    <i class="fas fa-search mr-2"></i><span>搜索球队、球员、新闻...</span>
                </div>
            </div>
            <button onclick="toggleTheme()" class="w-8 h-8 flex items-center justify-center text-gray-600 dark:text-gray-300">
                <i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:block text-yellow-400"></i>
            </button>
        </div>
        <div id="homeTabs" class="flex overflow-x-auto px-2 py-2 gap-6 text-sm font-medium border-t border-gray-100 dark:border-dark-border">
            <button onclick="filterByTag('all')" class="tag-btn tag-active text-emerald-600 dark:text-emerald-400 whitespace-nowrap px-2" data-tag="all">全部</button>
            <button onclick="filterByTag('match')" class="tag-btn text-gray-600 dark:text-gray-400 whitespace-nowrap px-2" data-tag="match">战报</button>
            <button onclick="filterByTag('transfer')" class="tag-btn text-gray-600 dark:text-gray-400 whitespace-nowrap px-2" data-tag="transfer">转会</button>
            <button onclick="filterByTag('official')" class="tag-btn text-gray-600 dark:text-gray-400 whitespace-nowrap px-2" data-tag="official">公告</button>
            <button onclick="filterByTag('analysis')" class="tag-btn text-gray-600 dark:text-gray-400 whitespace-nowrap px-2" data-tag="analysis">分析</button>
        </div>
    </div>

    <div id="refreshContainer" class="relative">
        <div id="pullIndicator" class="pull-refresh">
            <div id="pullSpinner" class="pull-refresh-spinner hidden"></div>
            <div id="pullText" class="text-gray-500 dark:text-gray-400 text-sm"><i class="fas fa-arrow-down mr-1"></i> 下拉刷新</div>
        </div>
        <main id="newsFeed" class="divide-y divide-gray-200 dark:divide-dark-border min-h-[60vh] scroll-container"></main>
        
        <!-- 转会页面（原积分榜位置） -->
        <div id="transferPage" class="hidden min-h-[60vh] scroll-container bg-gray-100 dark:bg-dark-bg">
            <div class="transfer-header">
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <i class="fas fa-exchange-alt"></i>
                    转会市场
                </h1>
                <p class="text-sm opacity-80 mt-1">球员转会申报与查询系统</p>
            </div>
            <div class="transfer-container">
                <iframe id="transferIframe" class="transfer-iframe" src="https://suttergov.github.io/transfermarkt.html" title="转会市场"></iframe>
            </div>
        </div>
        
        <div id="dataPage" class="hidden min-h-[60vh] scroll-container bg-gray-100 dark:bg-dark-bg">
            <div class="db-nav-header">
                <h2>球员数据库</h2>
                <p>选择以下外部数据库查询球员信息</p>
            </div>
            <div id="dataContent" class="pb-4">
                <div class="db-nav-card searchfm" onclick="openExternalDB('searchfm')">
                    <div class="db-nav-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="db-nav-title">搜猪网</div>
                    <div class="db-nav-desc">中文搜索球员FM能力，快速查找球员属性与潜力</div>
                    <i class="fas fa-chevron-right db-nav-arrow"></i>
                </div>
                
                <div class="db-nav-card kdocs" onclick="openExternalDB('kdocs')">
                    <div class="db-nav-icon">
                        <i class="fas fa-table"></i>
                    </div>
                    <div class="db-nav-title">FM26球员信息表</div>
                    <div class="db-nav-desc">包含十万球员信息的金山在线表格，数据全面详细</div>
                    <i class="fas fa-chevron-right db-nav-arrow"></i>
                </div>
                
                <div class="db-nav-card fminside" onclick="openExternalDB('fminside')">
                    <div class="db-nav-icon">
                        <i class="fas fa-globe"></i>
                    </div>
                    <div class="db-nav-title">FMINSIDE</div>
                    <div class="db-nav-desc">球员库数量最大的英文网站，适合查找海外球员</div>
                    <i class="fas fa-chevron-right db-nav-arrow"></i>
                </div>
            </div>
        </div>
        
        <div id="teamPage" class="hidden min-h-[60vh] scroll-container bg-gray-100 dark:bg-dark-bg">
            <div class="py-4">
                <div class="px-4 mb-3">
                    <h3 class="text-sm font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">特殊名单</h3>
                </div>
                <div class="special-player-card free-agent" onclick="showSpecialPlayers('free')">
                    <div class="special-player-icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="special-player-info">
                        <div class="special-player-title">自由球员</div>
                        <div class="special-player-count" id="freeAgentCount">加载中...</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 dark:text-gray-600"></i>
                </div>
                <div class="special-player-card retired" onclick="showSpecialPlayers('retired')">
                    <div class="special-player-icon">
                        <i class="fas fa-user-slash"></i>
                    </div>
                    <div class="special-player-info">
                        <div class="special-player-title">已退役球员</div>
                        <div class="special-player-count" id="retiredCount">加载中...</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 dark:text-gray-600"></i>
                </div>
                <div class="special-player-card transferred" onclick="showSpecialPlayers('transferred')">
                    <div class="special-player-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <div class="special-player-info">
                        <div class="special-player-title">已转出球员</div>
                        <div class="special-player-count" id="transferredCount">加载中...</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 dark:text-gray-600"></i>
                </div>
            </div>
            
            <div class="px-4 mb-3">
                <h3 class="text-sm font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">联赛球队</h3>
            </div>
            <div id="teamList" class="px-4 pb-4 grid grid-cols-1 gap-3"></div>
        </div>
        
        <!-- 广场页面（改造后的讨论区 - 推特风格） -->
        <div id="discussionPage" class="hidden min-h-[60vh] scroll-container bg-gray-100 dark:bg-dark-bg">
            <div class="square-container">
                <!-- 下拉刷新指示器 -->
                <div id="squarePullIndicator" class="square-pull-refresh">
                    <div class="square-pull-spinner hidden"></div>
                    <span class="square-pull-text">下拉刷新</span>
                </div>
                
                <div class="square-header">
                    <div class="square-title">广场</div>
                    <div id="squareUserSection" class="square-user-menu">
                        <button class="square-login-btn" onclick="openLoginModal()">登录</button>
                    </div>
                    <!-- 用户菜单下拉框 -->
                    <div id="userMenuDropdown" class="square-menu-dropdown">
                        <div class="square-menu-item" onclick="openUserProfileFromMenu()">
                            <i class="fas fa-user"></i>
                            <span>个人主页</span>
                        </div>
                        <div class="square-menu-item" onclick="showSwitchAccountModal()">
                            <i class="fas fa-exchange-alt"></i>
                            <span>切换账号</span>
                        </div>
                        <div class="square-menu-item" onclick="showTokenInput()">
                            <i class="fas fa-key"></i>
                            <span>重新输入Token</span>
                        </div>
                        <div class="square-menu-divider"></div>
                        <div class="square-menu-item danger" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>退出登录</span>
                        </div>
                    </div>
                </div>
                
                <!-- 发帖框（登录后显示） -->
                <div id="postInputSection" class="square-post-input hidden">
                    <img id="postUserAvatar" src="" alt="" class="square-post-avatar">
                    <div class="square-input-area">
                        <textarea id="postTextarea" class="square-textarea" placeholder="有什么新鲜事？" rows="3"></textarea>
                        <div id="imagePreviewContainer" class="flex gap-2 mt-2 flex-wrap"></div>
                        <div class="square-post-actions">
                            <div class="square-media-btns">
                                <label class="square-media-btn">
                                    <i class="far fa-image"></i>
                                    <input type="file" id="imageInput" accept="image/*" multiple class="hidden" onchange="handleImageSelect(event)">
                                </label>
                                <button class="square-media-btn" onclick="insertEmoji()">
                                    <i class="far fa-smile"></i>
                                </button>
                            </div>
                            <button class="square-post-submit" id="postSubmitBtn" onclick="submitPost()" disabled>发布</button>
                        </div>
                    </div>
                </div>
                
                <!-- 帖子流 -->
                <div id="squareFeed" class="square-feed" style="position: relative;">
                    <div class="p-8 text-center text-gray-400">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>加载中...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="specialPlayersPage" class="hidden fixed inset-0 z-50 bg-gray-100 dark:bg-dark-bg scroll-container">
            <div class="bg-white dark:bg-dark-surface border-b border-gray-200 dark:border-dark-border px-4 py-3 flex items-center sticky top-0 z-50">
                <button onclick="closeSpecialPlayersPage()" class="w-10 h-10 flex items-center justify-center -ml-2">
                    <i class="fas fa-arrow-left text-gray-600 dark:text-gray-300"></i>
                </button>
                <span class="font-medium ml-2 dark:text-gray-100" id="specialPlayersTitle">特殊球员</span>
            </div>
            <div id="specialPlayersList" class="p-4 space-y-3"></div>
        </div>
        
        <div id="teamDetailPage" class="hidden fixed inset-0 z-50 bg-gray-100 dark:bg-dark-bg scroll-container">
            <div class="team-header text-white relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-b from-transparent to-black/50"></div>
                <div class="relative z-10 flex items-center justify-between px-4 py-3">
                    <button onclick="backToTeamList()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/20 backdrop-blur"><i class="fas fa-arrow-left"></i></button>
                    <span class="font-medium">球队详情</span>
                    <button onclick="shareTeam()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/20 backdrop-blur"><i class="fas fa-share-alt"></i></button>
                </div>
                <div class="relative z-10 px-4 pb-6 pt-2">
                    <div class="flex items-center gap-4">
                        <div class="team-logo-container team-logo-detail bg-white/10 rounded-lg p-2">
                            <img id="teamDetailLogo" src="" alt="" class="team-logo-large">
                        </div>
                        <div class="flex-1">
                            <h1 id="teamDetailName" class="text-2xl font-bold mb-1"></h1>
                            <p id="teamDetailNameEn" class="text-sm opacity-80 mb-2"></p>
                            <div class="flex items-center gap-2 text-xs flex-wrap">
                                <span class="bg-white/20 px-2 py-1 rounded">加超联</span>
                                <span id="teamDetailCoach" class="bg-white/20 px-2 py-1 rounded"></span>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mt-4">
                        <div class="stat-card rounded-lg p-3 text-center"><div class="text-xs opacity-80">球队资金</div><div class="text-lg font-bold" id="teamDetailFunds"></div></div>
                        <div class="stat-card rounded-lg p-3 text-center"><div class="text-xs opacity-80">场均上座</div><div class="text-lg font-bold" id="teamDetailAttendance"></div></div>
                        <div class="stat-card rounded-lg p-3 text-center"><div class="text-xs opacity-80">上座率</div><div class="text-lg font-bold" id="teamDetailOccupancy"></div></div>
                        <div class="stat-card rounded-lg p-3 text-center"><div class="text-xs opacity-80">球场容量</div><div class="text-lg font-bold" id="teamDetailCapacity"></div></div>
                        <div class="stat-card rounded-lg p-3 text-center"><div class="text-xs opacity-80">球队总年薪</div><div class="text-lg font-bold" id="teamDetailWages"></div></div>
                        <div class="stat-card rounded-lg p-3 text-center"><div class="text-xs opacity-80">预计季末资金</div><div class="text-lg font-bold" id="teamDetailProjected"></div></div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mt-2">
                        <div class="stat-card rounded-lg p-3 text-center bg-emerald-500/20 border border-emerald-400/30">
                            <div class="text-xs opacity-80">平均CA</div>
                            <div class="text-lg font-bold" id="teamDetailAvgCA">--</div>
                        </div>
                        <div class="stat-card rounded-lg p-3 text-center bg-purple-500/20 border border-purple-400/30">
                            <div class="text-xs opacity-80">平均PA</div>
                            <div class="text-lg font-bold" id="teamDetailAvgPA">--</div>
                        </div>
                        <div class="stat-card rounded-lg p-3 text-center bg-blue-500/20 border border-blue-400/30">
                            <div class="text-xs opacity-80">平均年龄</div>
                            <div class="text-lg font-bold" id="teamDetailAvgAge">--</div>
                        </div>
                    </div>
                    <div id="financialWarning" class="hidden mt-3 rounded-lg financial-warning"><i class="fas fa-exclamation-triangle"></i><span>球队资金情况危险，可能无法通过准入</span></div>
                </div>
            </div>
            <div class="bg-white dark:bg-dark-surface border-b border-gray-200 dark:border-dark-border sticky top-0 z-40">
                <div class="flex">
                    <button onclick="switchTeamTab('squad')" class="team-tab flex-1 py-3 text-sm font-medium text-center tab-active" data-tab="squad">阵容</button>
                    <button onclick="switchTeamTab('stats')" class="team-tab flex-1 py-3 text-sm font-medium text-center text-gray-500 dark:text-gray-400" data-tab="stats">资料</button>
                    <button onclick="switchTeamTab('news')" class="team-tab flex-1 py-3 text-sm font-medium text-center text-gray-500 dark:text-gray-400" data-tab="news">动态</button>
                </div>
            </div>
            <div id="squadContent" class="p-4">
                <div class="mb-4">
                    <h3 class="text-sm font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wider">主教练</h3>
                    <div onclick="openCoachDetail()" class="bg-white dark:bg-dark-surface rounded-lg p-4 flex items-center justify-between shadow-sm cursor-pointer active:scale-95 transition-transform">
                        <div id="coachCard" class="flex-1"></div><i class="fas fa-chevron-right text-gray-400 dark:text-gray-500 ml-2"></i>
                    </div>
                </div>
                <div id="playersList"></div>
            </div>
            <div id="statsContent" class="hidden bg-gray-100 dark:bg-dark-bg min-h-full"></div>
            <div id="newsContent" class="hidden p-4"><div id="teamNewsList" class="space-y-3"></div></div>
        </div>
        
        <div id="coachDetailPage" class="hidden fixed inset-0 z-[60] bg-gray-100 dark:bg-dark-bg scroll-container">
            <div class="bg-white dark:bg-dark-surface border-b border-gray-200 dark:border-dark-border px-4 py-3 flex items-center sticky top-0 z-50">
                <button onclick="backToTeamDetailFromCoach()" class="w-10 h-10 flex items-center justify-center -ml-2"><i class="fas fa-arrow-left text-gray-600 dark:text-gray-300"></i></button>
                <span class="font-medium ml-2 dark:text-gray-100">教练组名单</span>
            </div>
            <div id="coachList" class="py-4"></div>
        </div>
        
        <div id="playerDetailPage" class="hidden fixed inset-0 z-[70] bg-gray-100 dark:bg-dark-bg scroll-container">
            <div class="relative bg-gradient-to-br from-emerald-600 to-emerald-800 text-white">
                <div class="flex items-center justify-between px-4 py-3">
                    <button onclick="backToTeamDetail()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/20 backdrop-blur"><i class="fas fa-arrow-left"></i></button>
                    <span class="font-medium">球员详情</span>
                    <div class="flex gap-2">
                        <button onclick="startPK()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/20 backdrop-blur" title="PK对比">
                            <i class="fas fa-bolt"></i>
                        </button>
                        <button onclick="sharePlayer()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/20 backdrop-blur"><i class="fas fa-share-alt"></i></button>
                    </div>
                </div>
                <div class="px-4 pb-6 flex items-end gap-4">
                    <div class="w-24 h-24 rounded-lg bg-white/20 flex items-center justify-center text-4xl font-bold"><span id="playerInitial"></span></div>
                    <div class="flex-1 pb-1">
                        <div class="flex items-center gap-2 mb-1"><span id="playerDetailPosition" class="position-badge"></span></div>
                        <h1 id="playerDetailName" class="text-2xl font-bold mb-1"></h1>
                        <p id="playerDetailTeam" class="text-sm opacity-80"></p>
                    </div>
                </div>
            </div>
            <div class="p-4 space-y-4">
                <div class="bg-white dark:bg-dark-surface rounded-lg p-4 shadow-sm">
                    <h3 class="font-bold mb-3 dark:text-gray-200">能力评估</h3>
                    <div class="flex items-center justify-center mb-4"><div class="w-24 h-24 rounded-full rating-badge flex items-center justify-center text-3xl" id="playerDetailRating"></div></div>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-dark-border"><span class="text-gray-500">当前能力(CA)</span><span class="font-bold" id="playerDetailCA"></span></div>
                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-dark-border"><span class="text-gray-500">潜力(PA)</span><span class="font-bold text-emerald-600" id="playerDetailPA"></span></div>
                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-dark-border"><span class="text-gray-500">年龄</span><span class="font-bold" id="playerDetailAge"></span></div>
                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-dark-border"><span class="text-gray-500">国籍</span><span class="font-bold" id="playerDetailNation"></span></div>
                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-dark-border"><span class="text-gray-500">身高</span><span class="font-bold" id="playerDetailHeight"></span></div>
                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-dark-border"><span class="text-gray-500">体重</span><span class="font-bold" id="playerDetailWeight"></span></div>
                    </div>
                </div>
                <div class="bg-white dark:bg-dark-surface rounded-lg p-4 shadow-sm"><h3 class="font-bold mb-3 dark:text-gray-200">可打位置</h3><div id="playerAllPositions" class="flex flex-wrap gap-2"></div></div>
                <div class="bg-white dark:bg-dark-surface rounded-lg p-4 shadow-sm">
                    <h3 class="font-bold mb-3 dark:text-gray-200">合同信息</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-dark-border"><span class="text-gray-500">所在球队</span><span class="font-bold" id="playerDetailTeam2"></span></div>
                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-dark-border"><span class="text-gray-500">合约到期</span><span class="font-bold" id="playerDetailContract"></span></div>
                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-dark-border"><span class="text-gray-500">年薪</span><span class="font-bold text-emerald-600" id="playerDetailWage"></span></div>
                        <div class="flex justify-between py-2"><span class="text-gray-500">违约金</span><span class="font-bold text-red-500" id="playerDetailClause"></span></div>
                    </div>
                </div>
                
                <!-- 球员详细信息（性格、强弱项） - 新增样式 -->
                <div id="playerExtraInfo" class="hidden bg-white dark:bg-dark-surface rounded-lg p-4 shadow-sm">
                    <!-- 性格 -->
                    <div id="playerPersonalitySection" class="mb-4 hidden">
                        <h3 class="font-bold mb-3 dark:text-gray-200 text-base">球员性格</h3>
                        <div id="playerPersonality" class="flex flex-wrap gap-2"></div>
                    </div>
                    
                    <!-- 技术特点/强项/弱项 -->
                    <div id="playerTraitsSection">
                        <h3 class="font-bold mb-3 dark:text-gray-200 text-base">技术特点</h3>
                        <div id="playerTraits" class="flex flex-wrap gap-2 mb-4"></div>
                        
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div>
                                <h4 class="text-sm font-bold text-red-500 mb-2 flex items-center gap-1">
                                    <i class="fas fa-plus-circle"></i> 强项
                                </h4>
                                <div id="playerStrengths" class="flex flex-wrap gap-2"></div>
                            </div>
                            <div>
                                <h4 class="text-sm font-bold text-blue-500 mb-2 flex items-center gap-1">
                                    <i class="fas fa-minus-circle"></i> 弱项
                                </h4>
                                <div id="playerWeaknesses" class="flex flex-wrap gap-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 伤病记录 - 新增 -->
                <div id="playerInjurySection" class="hidden bg-white dark:bg-dark-surface rounded-lg p-4 shadow-sm">
                    <h3 class="font-bold mb-3 dark:text-gray-200 text-base flex items-center gap-2">
                        <i class="fas fa-notes-medical text-red-500"></i> 伤病记录
                    </h3>
                    <div class="overflow-x-auto rounded-lg border border-gray-100 dark:border-gray-700">
                        <table class="w-full text-sm injury-table">
                            <thead>
                                <tr>
                                    <th class="px-3 py-2 text-left">伤病类型</th>
                                    <th class="px-3 py-2 text-center">休养时间</th>
                                    <th class="px-3 py-2 text-right">备注</th>
                                </tr>
                            </thead>
                            <tbody id="playerInjuryList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="pkSelectModal" class="pk-select-modal" onclick="closePKSelectModal(event)">
            <div class="pk-select-content" onclick="event.stopPropagation()">
                <div class="pk-select-header">
                    <span class="font-bold text-lg dark:text-gray-100">选择对比球员</span>
                    <button onclick="closePKSelectModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="p-4 bg-gray-50 dark:bg-gray-800 border-b dark:border-gray-700">
                    <input type="text" id="pkSearchInput" placeholder="搜索球员姓名..." class="w-full px-4 py-2 rounded-lg border dark:border-gray-600 dark:bg-gray-700 dark:text-white outline-none focus:border-emerald-500" oninput="filterPKPlayers(this.value)">
                </div>
                <div id="pkSelectList" class="pk-select-list"></div>
            </div>
        </div>
        
        <div id="pkResultPage" class="pk-page fixed inset-0 z-[80] bg-gray-100 dark:bg-dark-bg scroll-container">
            <div class="pk-header">
                <div class="flex items-center justify-between mb-4">
                    <button onclick="closePKResult()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/20 backdrop-blur">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <span class="font-medium">球员对比</span>
                    <button onclick="sharePKResult()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/20 backdrop-blur">
                        <i class="fas fa-share-alt"></i>
                    </button>
                </div>
                <div class="flex items-center justify-between">
                    <div class="pk-player-header" id="pkPlayer1Header"></div>
                    <div class="pk-vs-badge">VS</div>
                    <div class="pk-player-header flex-row-reverse text-right" id="pkPlayer2Header"></div>
                </div>
            </div>
            <div class="p-4 space-y-3" id="pkComparisonContent"></div>
        </div>
        
        <div id="articlePage" class="article-page fixed inset-0 z-50 bg-white dark:bg-dark-bg scroll-container">
            <div class="sticky top-0 bg-white/95 dark:bg-dark-surface/95 backdrop-blur border-b border-gray-200 dark:border-dark-border px-4 py-2 flex items-center justify-between">
                <button onclick="closeArticle()" class="w-8 h-8 flex items-center justify-center text-gray-600 dark:text-gray-300"><i class="fas fa-arrow-left text-lg"></i></button>
                <span class="font-medium text-sm dark:text-gray-200">加西亚足球APP</span>
                <button onclick="shareArticle()" class="w-8 h-8 flex items-center justify-center text-gray-600 dark:text-gray-300"><i class="fas fa-share-alt"></i></button>
            </div>
            <article id="articleContent" class="p-4"></article>
        </div>
    </div>
    <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-dark-surface border-t border-gray-200 dark:border-dark-border px-4 py-2 flex justify-between items-center z-40 transition-colors duration-300">
        <button onclick="switchTab('home')" class="bottom-nav-item active flex flex-col items-center gap-1 text-emerald-600 dark:text-emerald-400 flex-1" data-tab="home"><i class="fas fa-home text-xl"></i><span class="text-xs">首页</span></button>
        <button onclick="switchTab('team')" class="bottom-nav-item flex flex-col items-center gap-1 text-gray-400 dark:text-gray-500 flex-1" data-tab="team"><i class="fas fa-shield-alt text-xl"></i><span class="text-xs">球队</span></button>
        <button onclick="switchTab('transfer')" class="bottom-nav-item flex flex-col items-center gap-1 text-gray-400 dark:text-gray-500 flex-1" data-tab="transfer"><i class="fas fa-exchange-alt text-xl"></i><span class="text-xs">转会</span></button>
        <button onclick="switchTab('data')" class="bottom-nav-item flex flex-col items-center gap-1 text-gray-400 dark:text-gray-500 flex-1" data-tab="data"><i class="fas fa-database text-xl"></i><span class="text-xs">数据</span></button>
        <button onclick="switchTab('discussion')" class="bottom-nav-item flex flex-col items-center gap-1 text-gray-400 dark:text-gray-500 flex-1" data-tab="discussion"><i class="fas fa-comments text-xl"></i><span class="text-xs">广场</span></button>
    </nav>
    <script>
        const TEAM_LOGOS = {
            '南太平洋大学色温校区': 'https://suttergov.github.io/%E5%8D%97%E5%A4%AA%E5%A4%A7%E6%96%B0%E6%B3%B0.png',
            '三宝敦': 'https://suttergov.github.io/%E4%B8%89%E5%AE%9D%E6%95%A6.png',
            '东平雄鹰': 'https://suttergov.github.io/%E4%B8%9C%E5%B9%B3%E9%9B%84%E9%B9%B0.png',
            '伊丽莎白女王镇联合': 'https://suttergov.github.io/%E4%BC%8A%E4%B8%BD%E8%8E%8E%E7%99%BD%E8%81%94%E5%90%88.png',
            '泰克马联合': 'https://suttergov.github.io/%E4%BC%8A%E6%96%AF%E7%89%B9%E4%BC%8D%E5%BE%B7%E8%81%94%E5%90%88%E6%96%B02.png',
            '首都守护者': 'https://suttergov.github.io/%E5%93%88%E5%8D%A1%E6%8B%89%E6%89%98%E7%89%B9%E5%8D%A111.png',
            '哈贾丹太平洋人': 'https://suttergov.github.io/%E5%93%88%E8%B4%BE%E4%B8%B9%E5%A4%AA%E5%B9%B3%E6%B4%8B%E4%BA%BA.png',
            '坎布尔新吕伐登': 'https://suttergov.github.io/%E5%9D%8E%E5%B8%83%E5%B0%94%E6%96%B0%E5%90%95%E4%BC%90%E7%99%BB.png',
            '大同拜仁皇家加西亚': 'https://suttergov.github.io/%E5%A4%A7%E5%90%8C%E6%8B%9C%E4%BB%81%E7%9A%87%E5%AE%B6%E5%8A%A0%E8%A5%BF%E4%BA%9A.png',
            '奥顿兰富力': 'https://fclogo.top/_next/image?url=https%3A%2F%2Fcdn.sanity.io%2Fimages%2F11hmdf08%2Fproduction%2Feb9a55f184d71696f341ee3f8cd0a3bbcc0efc56-800x800.png%3Fw%3D800%26fm%3Dwebp%26q%3D80&w=828&q=75',
            '奥顿兰海鸥': 'https://suttergov.github.io/%E5%A5%A5%E9%A1%BF%E5%85%B0%E6%B5%B7%E6%B8%AF.png',
            '东木市职业': 'https://suttergov.github.io/%E5%AD%94%E6%81%A9%E5%BA%A6%E5%8D%A2FC.png',
            '安倍萨镇': 'https://suttergov.github.io/%E5%AE%89%E5%80%8D%E8%90%A8%E5%9F%8E.png',
            '拉阿纳': 'https://suttergov.github.io/%E6%8B%89%E9%98%BF%E7%BA%B3%E5%9F%8E%E5%B8%82%E7%AB%9E%E6%8A%80.png',
            '斯波托普城市': 'https://suttergov.github.io/%E6%96%AF%E6%B3%A2%E6%89%98%E6%99%AE%E5%9F%8E%E5%B8%82.png',
            '新吕伐登猫头鹰镇': 'https://suttergov.github.io/%E6%96%B0%E5%90%95%E4%BC%90%E7%99%BB%E7%8C%AB%E5%A4%B4%E9%B9%B0.png',
            '新南城': 'https://suttergov.github.io/%E6%96%B0%E6%B3%B0%E6%96%B03.png',
            '坎布尔新吕伐登B': 'https://free.boltp.com/2026/02/18/699491722d260.webp',
            '新达华哈海岸': 'https://suttergov.github.io/%E6%96%B0%E8%BE%BE%E5%8D%8E%E5%93%88%E6%B5%B7%E5%B2%B8.png',
            '泰克马职业': 'https://suttergov.github.io/%E6%B3%B0%E5%85%8B%E9%A9%AC%E8%81%8C%E4%B8%9A.png',
            '泰克马队': 'https://suttergov.github.io/%E6%B3%B0%E5%85%8B%E9%A9%AC%E9%98%9F.png',
            '瓦巴萨朱树鸦': 'https://suttergov.github.io/%E7%93%A6%E5%B7%B4%E8%90%A8%E6%9C%B1%E6%A0%91%E9%B8%A6.png',
            '新泰泰山': 'https://suttergov.github.io/%E7%93%A6%E5%B7%B4%E8%90%A8%E6%9C%B1%E8%89%BE%E5%A5%A5%E7%BA%B3%E5%B0%94.png',
            '皇家萨乌萨乌': 'https://suttergov.github.io/%E7%9A%87%E5%AE%B6%E8%90%A8%E4%B9%8C%E8%90%A8%E4%B9%8C.png',
            '穆拉哈西部': 'https://suttergov.github.io/%E7%A9%86%E6%8B%89%E5%93%88%E8%A5%BF%E9%83%A8.png',
            '色温岱州东岳': 'https://suttergov.github.io/%E8%89%B2%E6%B8%A9%E5%B2%B1%E5%B7%9E%E4%B8%9C%E5%B2%B3.png',
            '巴峰': 'https://suttergov.github.io/%E8%90%A8%E4%B9%8C%E8%90%A8%E4%B9%8C%E6%96%B0.png',
            '诺维奇港': 'https://suttergov.github.io/%E8%AF%BA%E7%BB%B4%E5%A5%87%E6%B8%AF%E6%96%B0.png',
            '北泰克马': 'https://suttergov.github.io/%E9%87%8C%E6%8B%89%E8%B5%AB%E9%A3%9E%E7%87%95.png',
            '阿尔特弗雷奇流浪者': 'https://suttergov.github.io/%E9%98%BF%E5%B0%94%E7%89%B9%E5%BC%97%E9%9B%B7%E5%A5%87%E6%B5%81%E6%B5%AA%E8%80%85.png',
            '马雷克青春之城': 'https://suttergov.github.io/%E9%A9%AC%E9%9B%B7%E5%85%8B%E6%96%B0.png',
            '哈克竞技': 'https://suttergov.github.io/%E5%93%88%E5%8D%A1%E6%8B%89%E6%89%98%E7%89%B9%E5%8D%A1.png',
            '比列竞技': 'https://suttergov.github.io/%E6%AF%94%E5%88%97%E7%AB%9E%E6%8A%80%E6%96%B0.png',
            '朱马蓝色协进': 'https://suttergov.github.io/%E6%9C%B1%E9%A9%AC%E8%93%9D%E8%89%B2%E5%8D%8F%E8%BF%9B.png',
            '伊斯特伍德竞技': 'https://suttergov.github.io/%E4%BC%8A%E6%96%AF%E7%89%B9%E4%BC%8D%E5%BE%B7%E4%BF%B1%E4%B9%90%E9%83%A8.png',
            '比斯恰捍卫者': 'https://suttergov.github.io/%E6%AF%94%E6%96%AF%E6%81%B0%E6%8D%8D%E5%8D%AB%E8%80%85.png',
            '新利雅得胜利': 'https://suttergov.github.io/%E6%99%AE%E6%8B%89%E5%B8%82%E6%B0%91.png',
            '南比斯恰城市': 'https://suttergov.github.io/%E5%8D%97%E6%AF%94%E6%96%AF%E6%81%B0%E5%9F%8E%E5%B8%82.png',
            '岱州东岳': 'https://suttergov.github.io/%E8%89%B2%E6%B8%A9%E5%B2%B1%E5%B7%9E%E4%B8%9C%E5%B2%B3.png',
            '新利雅得新月': 'https://fclogo.top/_next/image?url=https%3A%2F%2Fcdn.sanity.io%2Fimages%2F11hmdf08%2Fproduction%2F8b173e002d366de185a0b51b67e71d230f63b72e-800x800.png%3Fw%3D800%26fm%3Dwebp%26q%3D80&w=828&q=75',
            '马雷克海岸线': 'https://free.boltp.com/2026/02/17/6994906fb09c8.webp',
            '伊斯特伍德海岸线': 'https://free.boltp.com/2026/02/18/6995d0f5765c8.webp',
            '瓦巴萨朱城市': 'https://suttergov.github.io/%E7%93%A6%E5%B7%B4%E8%90%A8%E6%9C%B1%E8%89%BE%E5%A5%A5%E7%BA%B3%E5%B0%94.png',
            '瓦巴萨朱树鸦B': 'https://suttergov.github.io/%E7%93%A6%E5%B7%B4%E8%90%A8%E6%9C%B1%E6%A0%91%E9%B8%A6.png',
            '三宝敦乐邦战士': 'https://suttergov.github.io/%E7%BB%B4%E5%B0%94%E5%9B%BE%E9%92%A2%E7%AE%A1.png',
            '首都-东木联合B': 'https://suttergov.github.io/%E5%93%88%E5%8D%A1%E6%8B%89%E6%89%98%E7%89%B9%E5%8D%A111.png',
            '首都B': 'https://suttergov.github.io/%E5%93%88%E5%8D%A1%E6%8B%89%E6%89%98%E7%89%B9%E5%8D%A111.png',
            '比列地平线': 'https://fclogo.top/_next/image?url=https%3A%2F%2Fcdn.sanity.io%2Fimages%2F11hmdf08%2Fproduction%2F2d2c10be4e5d9a91aada5021b9b551ebd88f3bdc-800x800.png%3Fw%3D800%26fm%3Dwebp%26q%3D80&w=828&q=75',
            '新法鲁大里斯本联盟': 'https://suttergov.github.io/%E6%96%B0%E6%B3%95%E9%B2%81%E6%96%B0.png',
            '新法鲁联盟': 'https://suttergov.github.io/%E6%96%B0%E6%B3%95%E9%B2%81%E6%96%B0.png',
            '新利雅得阿尔希拉尔': 'https://fclogo.top/_next/image?url=https%3A%2F%2Fcdn.sanity.io%2Fimages%2F11hmdf08%2Fproduction%2F8b173e002d366de185a0b51b67e71d230f63b72e-800x800.png%3Fw%3D800%26fm%3Dwebp%26q%3D80&w=828&q=75',
            '加西亚国青队': 'https://suttergov.github.io/1500px-Naval_Flag_of_the_Kingdom_of_France_(Civil_Ensign).svg.png'
        };
        
        const CONFIG = {
            owner: 'SutterGov',
            repo: 'SutterGov.github.io',
            branch: 'main',
            rssPath: 'garciafootball.xml',
            excelUrl: 'https://suttergov.github.io/GarciaDatabase26.xlsx',
            teamHistoryUrl: 'https://suttergov.github.io/%E7%90%83%E9%98%9F%E6%95%B0%E6%8D%AE.txt',
            scheduleUrl: 'https://suttergov.github.io/%E8%B5%9B%E7%A8%8B.txt',
            playerInfoUrl: 'https://suttergov.github.io/%E7%90%83%E5%91%98%E4%BF%A1%E6%81%AF.txt',
            defaultLogo: 'https://free.boltp.com/2026/02/11/698ca73e5a316.webp',
            issuesApi: 'https://api.github.com/repos/SutterGov/SutterGov.github.io/issues',
            commentsApi: (issueNumber) => `https://api.github.com/repos/SutterGov/SutterGov.github.io/issues/${issueNumber}/comments`
        };

        // 登录码配置（基于上传的登录码.txt）
        const LOGIN_CODES = {
            'SAVGFC': { username: '首都守护者足球俱乐部', type: '球队', avatar: 'https://suttergov.github.io/%E5%93%88%E5%8D%A1%E6%8B%89%E6%89%98%E7%89%B9%E5%8D%A111.png' },
            'SEMARANG': { username: '三宝敦队官方', type: '球队', avatar: 'https://suttergov.github.io/%E4%B8%89%E5%AE%9D%E6%95%A6.png' },
            'DPEAGLES': { username: '东平雄鹰足球俱乐部', type: '球队', avatar: 'https://suttergov.github.io/%E4%B8%9C%E5%B9%B3%E9%9B%84%E9%B9%B0.png' },
            'QUEENS': { username: 'TheUnited-女王镇联合足球俱乐部官方', type: '球队', avatar: 'https://suttergov.github.io/%E4%BC%8A%E4%B8%BD%E8%8E%8E%E7%99%BD%E8%81%94%E5%90%88.png' },
            'TEKMAUFC': { username: '泰克马联合官方', type: '球队', avatar: 'https://suttergov.github.io/%E4%BC%8A%E6%96%AF%E7%89%B9%E4%BC%8D%E5%BE%B7%E8%81%94%E5%90%88%E6%96%B02.png' },
            'HAJADEEN': { username: '哈贾丹太平洋人俱乐部', type: '球队', avatar: 'https://suttergov.github.io/%E5%93%88%E8%B4%BE%E4%B8%B9%E5%A4%AA%E5%B9%B3%E6%B4%8B%E4%BA%BA.png' },
            'CNLFC': { username: '坎布尔新吕伐登足球俱乐部', type: '球队', avatar: 'https://suttergov.github.io/%E5%9D%8E%E5%B8%83%E5%B0%94%E6%96%B0%E5%90%95%E4%BC%90%E7%99%BB.png' },
            'SEAGULL': { username: '奥顿兰海鸥男足', type: '球队', avatar: 'https://suttergov.github.io/%E5%A5%A5%E9%A1%BF%E5%85%B0%E6%B5%B7%E6%B8%AF.png' },
            'EASTWOOD': { username: '东木市职业足球俱乐部', type: '球队', avatar: 'https://suttergov.github.io/%E5%AD%94%E6%81%A9%E5%BA%A6%E5%8D%A2FC.png' },
            'LAANA': { username: 'LA\'ANAFC79-拉阿纳队', type: '球队', avatar: 'https://suttergov.github.io/%E6%8B%89%E9%98%BF%E7%BA%B3%E5%9F%8E%E5%B8%82%E7%AB%9E%E6%8A%80.png' },
            'SBOTOP': { username: '斯波托普城市足球俱乐部', type: '球队', avatar: 'https://suttergov.github.io/%E6%96%AF%E6%B3%A2%E6%89%98%E6%99%AE%E5%9F%8E%E5%B8%82.png' },
            'XINNANCHENG': { username: '新南城足球俱乐部', type: '球队', avatar: 'https://suttergov.github.io/%E6%96%B0%E6%B3%B0%E6%96%B03.png' },
            'HILAL': { username: 'ALHILAL加西亚新月队', type: '球队', avatar: 'https://fclogo.top/_next/image?url=https%3A%2F%2Fcdn.sanity.io%2Fimages%2F11hmdf08%2Fproduction%2F8b173e002d366de185a0b51b67e71d230f63b72e-800x800.png%3Fw%3D800%26fm%3Dwebp%26q%3D80&w=828&q=75' },
            'RFFC': { username: '奥顿兰富力R&F', type: '球队', avatar: 'https://fclogo.top/_next/image?url=https%3A%2F%2Fcdn.sanity.io%2Fimages%2F11hmdf08%2Fproduction%2F054ad4196adacff7c6d42d35764c892cf950ef0f-800x800.png%3Fw%3D800%26fm%3Dwebp%26q%3D80&w=828&q=75' },
            'DAHWAHA': { username: '新达华哈海岸官方', type: '球队', avatar: 'https://suttergov.github.io/%E6%96%B0%E8%BE%BE%E5%8D%8E%E5%93%88%E6%B5%B7%E5%B2%B8.png' },
            'CAGOUS': { username: '瓦巴萨朱树鸦CAGOUSFC', type: '球队', avatar: 'https://suttergov.github.io/%E7%93%A6%E5%B7%B4%E8%90%A8%E6%9C%B1%E6%A0%91%E9%B8%A6.png' },
            'ROYALS': { username: '皇家萨乌萨乌足球俱乐部', type: '球队', avatar: 'https://suttergov.github.io/%E7%9A%87%E5%AE%B6%E8%90%A8%E4%B9%8C%E8%90%A8%E4%B9%8C.png' },
            'MURAJA': { username: '穆拉哈西部队', type: '球队', avatar: 'https://suttergov.github.io/%E7%A9%86%E6%8B%89%E5%93%88%E8%A5%BF%E9%83%A8.png' },
            'LBJ': { username: '三宝敦乐邦战士足球俱乐部', type: '球队', avatar: 'https://suttergov.github.io/%E7%BB%B4%E5%B0%94%E5%9B%BE%E9%92%A2%E7%AE%A1.png' },
            'DAIZHOU': { username: '色温岱州东岳俱乐部', type: '球队', avatar: 'https://suttergov.github.io/%E8%89%B2%E6%B8%A9%E5%B2%B1%E5%B7%9E%E4%B8%9C%E5%B2%B3.png' },
            'BFFC': { username: '巴峰足球俱乐部', type: '球队', avatar: 'https://suttergov.github.io/%E8%90%A8%E4%B9%8C%E8%90%A8%E4%B9%8C%E6%96%B0.png' },
            'NORWICH': { username: '诺维奇港NorwichPortFC', type: '球队', avatar: 'https://suttergov.github.io/%E8%AF%BA%E7%BB%B4%E5%A5%87%E6%B8%AF%E6%96%B0.png' },
            'ROVERS': { username: 'RoversOfficial流浪者队官方', type: '球队', avatar: 'https://suttergov.github.io/%E9%98%BF%E5%B0%94%E7%89%B9%E5%BC%97%E9%9B%B7%E5%A5%87%E6%B5%81%E6%B5%AA%E8%80%85.png' },
            'USP': { username: '南太平洋大学色温校区', type: '球队', avatar: 'https://suttergov.github.io/%E5%8D%97%E5%A4%AA%E5%A4%A7%E6%96%B0%E6%B3%B0.png' },
            'MAREK': { username: '马雷克青春之城足球俱乐部', type: '球队', avatar: 'https://suttergov.github.io/%E9%A9%AC%E9%9B%B7%E5%85%8B%E6%96%B0.png' },
            'LAXI': { username: '拉西弗谢', type: '个人', avatar: 'https://www.pesmaster.com/efootball-2022/graphics/players/Variation2022/52870242240935_.png' },
            'MAHAOYU': { username: '马浩宇', type: '个人', avatar: 'https://www.pesmaster.com/efootball-2022/graphics/players/Variation2022/52887690550188_.png' },
            'CARLO': { username: '卡罗', type: '个人', avatar: 'https://www.pesmaster.com/efootball-2022/graphics/players/Variation2022/52875610863799_.png' },
            'JUDE': { username: '裘德·乔克雷斯', type: '个人', avatar: 'https://www.pesmaster.com/efootball-2022/graphics/players/Variation2022/52892253943504_.png' },
            'MEDIA': { username: 'GACFA加西亚足协', type: '媒体', avatar: 'https://fclogo.top/_next/image?url=https%3A%2F%2Fcdn.sanity.io%2Fimages%2F11hmdf08%2Fproduction%2Fc97e5b70a494eb39da0152ef031bda998e49b455-800x800.png%3Fw%3D800%26fm%3Dwebp%26q%3D80&w=828&q=75', isMediaGroup: true }
        };

        // 媒体子账号配置
        const MEDIA_ACCOUNTS = [
            { username: '足球市场网', type: '媒体', avatar: 'https://cdn.brandfetch.io/footmercato.net/fallback/lettermark/theme/dark/h/256/w/256/icon?c=1bfwsmEH20zzEfSNTed' },
            { username: '队报', type: '媒体', avatar: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTOiDuzVeBrpk8XzlT--IPXX67Vj6MRxBzTYw&s' },
            { username: 'DavidOrnstein', type: '媒体', avatar: 'https://free.boltp.com/2026/02/22/699a745282a0f.webp' },
            { username: 'AlfredoPedulla', type: '媒体', avatar: 'https://icdn.football-italia.net/wp-content/uploads/2025/06/Alfredo_Pedulla_HeadShot.jpg' },
            { username: 'Bild.de', type: '媒体', avatar: 'https://free.boltp.com/2026/02/22/699a74526ef2f.webp' },
            { username: '直播吧', type: '媒体', avatar: 'https://free.boltp.com/2026/02/22/699a745285af4.webp' },
            { username: '进球网', type: '媒体', avatar: 'https://free.boltp.com/2026/02/22/699a7452679d9.webp' },
            { username: '新吕伐登时报', type: '媒体', avatar: 'https://bpic.51yuansu.com/pic3/cover/03/53/87/65d9fb19dfa35_260.jpg?x-oss-process=image/resize,w_260/sharpen,100' },
            { username: 'NikoloSchira', type: '媒体', avatar: 'https://elitefootballcenter.com/wp-content/uploads/2025/10/nicolo_schira.jpg' },
            { username: 'DiMarzio', type: '媒体', avatar: 'https://gianlucadimarzio.com/wp-content/themes/victoria-child/img/gdm-twitter.png' },
            { username: 'FabrizioRomano', type: '媒体', avatar: 'https://free.boltp.com/2026/02/22/699a745275df3.webp' },
            { username: '加西亚邮报', type: '媒体', avatar: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT7A2UlVPRErxcM3xCJNLkCyAfPUUAGI1sKuw&s' },
            { username: 'ESPN', type: '媒体', avatar: 'https://cdn.iconscout.com/icon/free/png-256/free-espn-logo-icon-svg-download-png-461787.png' },
            { username: '大巴姆岛先驱者早报', type: '媒体', avatar: 'https://d3g9pb5nvr3u7.cloudfront.net/sites/529657a5bc4626126841af46/2078558977/256.png' },
            { username: '泰克马广播网', type: '媒体', avatar: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTnFfUS6rne2qcqcXn7LoXCnjZUFMwAnJs1ZQ&s' },
            { username: '马雷克晚旗报', type: '媒体', avatar: 'https://weshipyou.com/_next/static/media/we-ship-you-logo.e8e4ea74.png' },
            { username: '比列趋势电讯报', type: '媒体', avatar: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQgiLqXK1a6T4yNxtVZ8ftWJR8tSWo3TJWt-A&s' },
            { username: '穆拉哈体育图片报', type: '媒体', avatar: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRR5z_UIup_BW25Km2jiDRVeX8GGtMu-h6DBg&s' },
            { username: '群岛标准早报', type: '媒体', avatar: 'https://cdn.brandfetch.io/efe.com/fallback/lettermark/theme/dark/h/256/w/256/icon?c=1bfwsmEH20zzEfSNTed' }
        ];

        const EXTERNAL_DBS = {
            searchfm: { url: 'https://www.searchfm.cn/', name: '搜猪网' },
            kdocs: { url: 'https://www.kdocs.cn/l/cjkq8pzp9Jqy', name: 'FM26球员信息表' },
            fminside: { url: 'https://fminside.net/players', name: 'FMINSIDE' }
        };

        let currentTag = 'all', currentTab = 'home', rssData = [], teamData = [], playersData = [];
        let currentTeam = null, currentCoaches = [], isRefreshing = false;
        let touchStartY = 0, touchCurrentY = 0, isPulling = false;
        const PULL_THRESHOLD = 80;
        let searchHistory = [], currentSearchTab = 'all';
        let searchHotWords = ['三宝敦', '泰克马联合', '转会', '战报', '大同拜仁', '哈贾丹'];
        let teamHistoryData = {};
        let scheduleData = [];
        let playerSort = 'ca-desc';
        let playerFilterSeason = 'all';
        let playerFilterNation = 'all';
        let playerPage = 1;
        const PLAYERS_PER_PAGE = 30;
        let standingsData = [];
        let isLoadingTeamHistory = false;
        let freeAgents = [], retiredPlayers = [], transferredPlayers = [];
        let currentPKPlayer = null;
        let pkPlayer2 = null;
        let giscusLoaded = false;
        let playerExtraData = {};
        
        // 广场相关状态
        let currentUser = null; // 当前登录用户
        let githubToken = ''; // GitHub Token
        let squarePosts = []; // 广场帖子列表
        let selectedImages = []; // 待上传的图片
        let currentCommentPost = null; // 当前评论的帖子
        let isSquarePulling = false; // 广场下拉刷新状态
        let squareTouchStartY = 0;
        let squareTouchCurrentY = 0;

        // 页面历史栈管理
        let pageHistory = [];
        let isPopState = false;

        const LEAGUE_ORDER = {
            '加超联': 1,
            '加甲联': 2,
            '加乙联': 3,
            '加冠联': 4,
            '足协杯': 5,
            '联赛杯': 6
        };

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            initBackButtonHandler();
            loadPlayerExtraData();
            loadSquarePosts(); // 加载广场帖子
            checkLoginStatus(); // 检查登录状态
            initSquarePullToRefresh(); // 初始化广场下拉刷新
        });

        // 初始化广场下拉刷新
        function initSquarePullToRefresh() {
            const feed = document.getElementById('squareFeed');
            if (!feed) return;

            feed.addEventListener('touchstart', (e) => {
                if (feed.scrollTop === 0 && !isRefreshing) {
                    squareTouchStartY = e.touches[0].clientY;
                    isSquarePulling = true;
                }
            }, { passive: true });

            feed.addEventListener('touchmove', (e) => {
                if (!isSquarePulling || isRefreshing) return;
                
                squareTouchCurrentY = e.touches[0].clientY;
                const diff = squareTouchCurrentY - squareTouchStartY;
                
                if (diff > 0) {
                    e.preventDefault();
                    const pullDistance = Math.min(diff * 0.5, 120);
                    const indicator = document.getElementById('squarePullIndicator');
                    if (indicator) indicator.style.transform = `translateY(${pullDistance}px)`;
                    
                    const text = document.querySelector('.square-pull-text');
                    if (text) {
                        if (pullDistance > PULL_THRESHOLD) {
                            text.textContent = '释放刷新';
                        } else {
                            text.textContent = '下拉刷新';
                        }
                    }
                }
            }, { passive: false });

            feed.addEventListener('touchend', () => {
                if (!isSquarePulling || isRefreshing) return;
                
                const diff = squareTouchCurrentY - squareTouchStartY;
                
                if (diff > PULL_THRESHOLD) {
                    startSquareRefresh();
                } else {
                    resetSquarePullIndicator();
                }
                
                isSquarePulling = false;
                squareTouchStartY = 0;
                squareTouchCurrentY = 0;
            });
        }

        function startSquareRefresh() {
            isRefreshing = true;
            const indicator = document.getElementById('squarePullIndicator');
            const spinner = document.querySelector('.square-pull-spinner');
            const text = document.querySelector('.square-pull-text');
            
            if (spinner) spinner.classList.remove('hidden');
            if (text) text.textContent = '刷新中...';
            if (indicator) indicator.style.transform = `translateY(60px)`;
            
            loadSquarePosts().then(() => {
                showRefreshToast('已刷新');
            }).catch(err => {
                showErrorToast('刷新失败');
            }).finally(() => {
                setTimeout(() => {
                    resetSquarePullIndicator();
                    isRefreshing = false;
                }, 500);
            });
        }

        function resetSquarePullIndicator() {
            const indicator = document.getElementById('squarePullIndicator');
            const spinner = document.querySelector('.square-pull-spinner');
            const text = document.querySelector('.square-pull-text');
            
            if (indicator) {
                indicator.style.transition = 'transform 0.3s';
                indicator.style.transform = 'translateY(0)';
            }
            if (spinner) spinner.classList.add('hidden');
            if (text) text.textContent = '下拉刷新';
            
            setTimeout(() => {
                if (indicator) indicator.style.transition = '';
            }, 300);
        }

        // 登录相关函数
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('square_user');
            const savedToken = localStorage.getItem('github_token');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                githubToken = savedToken || '';
                updateLoginUI();
            }
        }

        function openLoginModal() {
            document.getElementById('loginModal').classList.add('show');
            // 如果已登录，显示切换账号选项
            if (currentUser) {
                renderLoggedInModal();
            }
        }

        function renderLoggedInModal() {
            const isMedia = currentUser.isMediaGroup || currentUser.type === '媒体';
            let html = `
                <div class="login-close" onclick="closeLoginModal()"><i class="fas fa-times"></i></div>
                <div class="text-center mb-6">
                    <img src="${currentUser.avatar}" class="w-20 h-20 rounded-full mx-auto mb-3 object-cover border-4 border-emerald-100 dark:border-emerald-900">
                    <p class="font-bold text-lg dark:text-gray-100">${currentUser.username}</p>
                    <span class="user-type-badge user-type-${currentUser.type === '球队' ? 'team' : currentUser.type === '个人' ? 'personal' : 'media'}">${currentUser.type}</span>
                    ${currentUser.loginCode ? `<p class="text-xs text-gray-400 mt-1">登录码: ${currentUser.loginCode}</p>` : ''}
                </div>
            `;
            
            if (isMedia) {
                html += `<button class="login-btn mb-3" onclick="showSwitchAccountModal()"><i class="fas fa-exchange-alt mr-2"></i>切换媒体账号</button>`;
            }
            
            html += `
                <button class="login-btn mb-3 bg-blue-500" onclick="showTokenInput()"><i class="fas fa-key mr-2"></i>重新输入Token</button>
                <button class="login-btn bg-gray-500" onclick="logout()"><i class="fas fa-sign-out-alt mr-2"></i>退出登录</button>
            `;
            
            document.querySelector('.login-content').innerHTML = html;
        }

        function closeLoginModal(event) {
            if (event && event.target !== event.currentTarget && !event.target.closest('.login-close')) return;
            document.getElementById('loginModal').classList.remove('show');
            // 重置登录框内容
            setTimeout(() => {
                if (!currentUser) {
                    resetLoginModalContent();
                }
            }, 300);
        }

        function resetLoginModalContent() {
            document.querySelector('.login-content').innerHTML = `
                <div class="login-close" onclick="closeLoginModal()"><i class="fas fa-times"></i></div>
                <h2 class="login-title">登录广场</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4 text-center">请输入您的登录码</p>
                <input type="text" id="loginCodeInput" class="login-input" placeholder="例如：XXXXXX" maxlength="20">
                
                <div class="token-section">
                    <div class="token-label">
                        <i class="fab fa-github mr-1"></i> GitHub Token (用于发帖和评论)
                    </div>
                    <input type="password" id="githubTokenInput" class="token-input" placeholder="ghp_xxxxxxxxxxxx">
                    <p class="text-xs text-gray-400 mt-2">Token 仅存储在本地，用于调用 GitHub API 发布内容</p>
                </div>
                
                <button class="login-btn" onclick="handleLogin()">登录</button>
                
                <div class="mt-4 text-xs text-gray-400 text-center">
                    <p>可用测试账号：</p>
                    <p class="mt-1">XXXXXX</p>
                </div>
            `;
        }

        function showTokenInput() {
            const newToken = prompt('请输入新的 GitHub Token:');
            if (newToken && newToken.trim()) {
                githubToken = newToken.trim();
                localStorage.setItem('github_token', githubToken);
                showRefreshToast('Token 已更新');
                closeLoginModal();
            }
        }

        function showSwitchAccountModal() {
            const modal = document.getElementById('switchAccountModal');
            const list = document.getElementById('switchAccountList');
            
            list.innerHTML = MEDIA_ACCOUNTS.map((account, index) => `
                <div class="switch-account-item ${currentUser.username === account.username ? 'active' : ''}" onclick="switchToMediaAccount(${index})">
                    <img src="${account.avatar}" alt="${account.username}">
                    <div class="switch-account-info">
                        <div class="switch-account-name">${account.username}</div>
                        <div class="switch-account-type">${account.type}</div>
                    </div>
                    ${currentUser.username === account.username ? '<i class="fas fa-check text-emerald-500"></i>' : ''}
                </div>
            `).join('');
            
            modal.classList.add('show');
        }

        function closeSwitchAccountModal(event) {
            if (event && event.target !== event.currentTarget && !event.target.closest('.switch-account-content')) return;
            document.getElementById('switchAccountModal').classList.remove('show');
        }

        function switchToMediaAccount(index) {
            const account = MEDIA_ACCOUNTS[index];
            if (account) {
                currentUser = { ...account, loginCode: 'MEDIA', type: '媒体', isMediaGroup: true };
                localStorage.setItem('square_user', JSON.stringify(currentUser));
                updateLoginUI();
                closeSwitchAccountModal();
                showRefreshToast(`已切换至: ${account.username}`);
                loadSquarePosts(); // 刷新以显示新用户的帖子
            }
        }

        function handleLogin() {
            const code = document.getElementById('loginCodeInput').value.toUpperCase().trim();
            const token = document.getElementById('githubTokenInput').value.trim();
            
            if (!code) {
                showErrorToast('请输入登录码');
                return;
            }
            
            if (LOGIN_CODES[code]) {
                const userInfo = LOGIN_CODES[code];
                currentUser = { ...userInfo, loginCode: code };
                githubToken = token;
                
                localStorage.setItem('square_user', JSON.stringify(currentUser));
                if (token) localStorage.setItem('github_token', token);
                
                updateLoginUI();
                closeLoginModal();
                showRefreshToast(`欢迎，${userInfo.username}！`);
            } else {
                showErrorToast('无效的登录码');
            }
        }

        function logout() {
            currentUser = null;
            githubToken = '';
            localStorage.removeItem('square_user');
            localStorage.removeItem('github_token');
            updateLoginUI();
            closeLoginModal();
            showRefreshToast('已退出登录');
            resetLoginModalContent();
        }

        function updateLoginUI() {
            const userSection = document.getElementById('squareUserSection');
            const postInput = document.getElementById('postInputSection');
            const menuDropdown = document.getElementById('userMenuDropdown');
            
            if (currentUser) {
                userSection.innerHTML = `
                    <img src="${currentUser.avatar}" alt="${currentUser.username}" class="square-user-avatar" onclick="toggleUserMenu(event)">
                `;
                postInput.classList.remove('hidden');
                document.getElementById('postUserAvatar').src = currentUser.avatar;
                
                // 点击外部关闭菜单
                document.addEventListener('click', closeUserMenuOutside);
            } else {
                userSection.innerHTML = `<button class="square-login-btn" onclick="openLoginModal()">登录</button>`;
                postInput.classList.add('hidden');
                if (menuDropdown) menuDropdown.classList.remove('show');
            }
        }

        function toggleUserMenu(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('userMenuDropdown');
            dropdown.classList.toggle('show');
        }

        function closeUserMenuOutside(event) {
            const dropdown = document.getElementById('userMenuDropdown');
            const avatar = document.querySelector('.square-user-avatar');
            if (dropdown && !dropdown.contains(event.target) && event.target !== avatar) {
                dropdown.classList.remove('show');
            }
        }

        function openUserProfileFromMenu() {
            closeUserMenuOutside({ target: document.body });
            openUserProfile(currentUser.username);
        }

        // 广场功能函数
        async function loadSquarePosts() {
            try {
                // 从GitHub Issues获取标记为"广场"的帖子
                const response = await fetch(`${CONFIG.issuesApi}?labels=广场&state=open&per_page=30&sort=created&direction=desc`, {
                    headers: githubToken ? { 'Authorization': `token ${githubToken}` } : {}
                });
                
                if (!response.ok) throw new Error('加载失败');
                
                const issues = await response.json();
                squarePosts = issues.map(issue => {
                    // 解析issue body中的用户信息
                    let userInfo = {};
                    let content = issue.body || '';
                    let images = [];
                    
                    try {
                        // 尝试解析JSON格式的body
                        const parsed = JSON.parse(content);
                        if (parsed.userInfo && parsed.content) {
                            userInfo = parsed.userInfo;
                            content = parsed.content;
                            images = parsed.images || [];
                        }
                    } catch (e) {
                        // 如果不是JSON，尝试从body中提取用户信息（旧格式兼容）
                        const userMatch = content.match(/<!--user:(.*?)-->/);
                        if (userMatch) {
                            try {
                                userInfo = JSON.parse(userMatch[1]);
                                content = content.replace(/<!--user:.*?-->/, '').trim();
                            } catch (err) {}
                        }
                        // 提取图片
                        const imgMatches = content.match(/!\[.*?\]\((.*?)\)/g) || [];
                        images = imgMatches.map(img => img.match(/\((.*?)\)/)[1]);
                        content = content.replace(/!\[.*?\]\(.*?\)/g, '').trim();
                    }
                    
                    return {
                        id: issue.number,
                        userInfo: userInfo,
                        content: content,
                        images: images,
                        createdAt: issue.created_at,
                        likes: issue.reactions && issue.reactions['+1'] ? issue.reactions['+1'] : 0,
                        comments: issue.comments,
                        liked: issue.reactions && issue.reactions.user && issue.reactions.user['+1'],
                        author: issue.user.login
                    };
                });
                
                renderSquareFeed();
            } catch (error) {
                console.error('加载广场帖子失败:', error);
                document.getElementById('squareFeed').innerHTML = `
                    <div class="p-8 text-center text-gray-400">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                        <p>加载失败，请稍后重试</p>
                        <button onclick="loadSquarePosts()" class="mt-4 px-4 py-2 bg-emerald-600 text-white rounded-lg">重试</button>
                    </div>
                `;
            }
        }

        function renderSquareFeed() {
            const feed = document.getElementById('squareFeed');
            if (!squarePosts.length) {
                feed.innerHTML = `
                    <div class="p-8 text-center text-gray-400">
                        <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
                        <p>暂无帖子，快来发表第一条吧！</p>
                    </div>
                `;
                return;
            }
            
            feed.innerHTML = squarePosts.map(post => {
                const timeStr = formatTime(post.createdAt);
                const userTypeClass = post.userInfo.type === '球队' ? 'user-type-team' : post.userInfo.type === '个人' ? 'user-type-personal' : 'user-type-media';
                const imagesHtml = renderPostImages(post.images);
                const displayName = post.userInfo.username || '未知用户';
                const handle = '@' + displayName.replace(/\s+/g, '');
                
                return `
                    <div class="square-post fade-in" data-post-id="${post.id}">
                        <div class="square-post-user">
                            <img src="${post.userInfo.avatar || CONFIG.defaultLogo}" alt="" class="square-post-avatar-small" onclick="openUserProfile('${post.userInfo.username}')">
                            <div class="square-post-info">
                                <div class="square-post-name-row">
                                    <span class="square-post-username" onclick="openUserProfile('${post.userInfo.username}')">${displayName}</span>
                                    <span class="user-type-badge ${userTypeClass}">${post.userInfo.type || '用户'}</span>
                                    <span class="square-post-handle">${handle}</span>
                                    <span class="square-post-dot">·</span>
                                    <span class="square-post-time">${timeStr}</span>
                                </div>
                                <div class="square-post-content" onclick="openPostDetail(${post.id})">${escapeHtml(post.content)}</div>
                                ${imagesHtml}
                                <div class="square-post-actions-bar">
                                    <button class="square-action-btn comment" onclick="event.stopPropagation(); openComments(${post.id})">
                                        <i class="far fa-comment"></i>
                                        <span class="square-action-count">${post.comments || 0}</span>
                                    </button>
                                    <button class="square-action-btn repost" onclick="event.stopPropagation(); repost(${post.id})">
                                        <i class="fas fa-retweet"></i>
                                        <span class="square-action-count">0</span>
                                    </button>
                                    <button class="square-action-btn like ${post.liked ? 'liked' : ''}" onclick="event.stopPropagation(); toggleLike(${post.id})">
                                        <i class="${post.liked ? 'fas' : 'far'} fa-heart"></i>
                                        <span class="square-action-count">${post.likes || 0}</span>
                                    </button>
                                    <button class="square-action-btn share" onclick="event.stopPropagation(); sharePost(${post.id})">
                                        <i class="fas fa-share-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPostImages(images) {
            if (!images || !images.length) return '';
            
            const gridClass = images.length === 1 ? 'grid-1' : images.length === 2 ? 'grid-2' : images.length === 3 ? 'grid-3' : 'grid-4';
            
            return `
                <div class="square-post-images ${gridClass}">
                    ${images.map((img, idx) => `
                        <img src="${img}" alt="" class="square-post-image" onclick="event.stopPropagation(); previewImage('${img}')">
                    `).join('')}
                </div>
            `;
        }

        function openPostDetail(postId) {
            // 可以在这里实现帖子详情页
            openComments(postId);
        }

        // 发帖功能
        async function submitPost() {
            const textarea = document.getElementById('postTextarea');
            const content = textarea.value.trim();
            
            if (!content && !selectedImages.length) {
                showErrorToast('请输入内容或添加图片');
                return;
            }
            
            if (!currentUser) {
                showErrorToast('请先登录');
                openLoginModal();
                return;
            }
            
            if (!githubToken) {
                showErrorToast('请输入GitHub Token才能发帖');
                openLoginModal();
                return;
            }
            
            const submitBtn = document.getElementById('postSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '发布中...';
            
            try {
                // 上传图片到GitHub（如果有的话）
                const uploadedImages = [];
                for (const image of selectedImages) {
                    const imageUrl = await uploadImageToGitHub(image);
                    if (imageUrl) uploadedImages.push(imageUrl);
                }
                
                // 构造帖子数据
                const postData = {
                    userInfo: currentUser,
                    content: content,
                    images: uploadedImages,
                    timestamp: new Date().toISOString()
                };
                
                // 创建GitHub Issue
                const response = await fetch(CONFIG.issuesApi, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: `[广场] ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`,
                        body: JSON.stringify(postData),
                        labels: ['广场']
                    })
                });
                
                if (!response.ok) throw new Error('发布失败');
                
                // 清空输入
                textarea.value = '';
                selectedImages = [];
                updateImagePreview();
                
                showRefreshToast('发布成功！');
                loadSquarePosts(); // 刷新列表
                
            } catch (error) {
                console.error('发帖失败:', error);
                showErrorToast('发布失败，请检查Token是否正确');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '发布';
            }
        }

        async function uploadImageToGitHub(file) {
            // 这里应该实现图片上传到GitHub仓库的逻辑
            // 简化起见，使用base64存储在issue中或上传到图床
            // 实际项目中建议使用专门的图床或GitHub Contents API
            
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // 返回base64数据（实际使用时应上传到服务器）
                    resolve(e.target.result);
                };
                reader.readAsDataURL(file);
            });
        }

        function handleImageSelect(event) {
            const files = Array.from(event.target.files);
            if (files.length + selectedImages.length > 9) {
                showErrorToast('最多选择9张图片');
                return;
            }
            selectedImages = [...selectedImages, ...files];
            updateImagePreview();
        }

        function updateImagePreview() {
            const container = document.getElementById('imagePreviewContainer');
            container.innerHTML = selectedImages.map((file, idx) => `
                <div class="relative">
                    <img src="${URL.createObjectURL(file)}" class="w-20 h-20 object-cover rounded-lg">
                    <button onclick="removeImage(${idx})" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
            
            const textarea = document.getElementById('postTextarea');
            document.getElementById('postSubmitBtn').disabled = !textarea.value.trim() && !selectedImages.length;
        }

        function removeImage(index) {
            selectedImages.splice(index, 1);
            updateImagePreview();
        }

        function insertEmoji() {
            const emojis = ['😀', '😂', '🥳', '⚽', '🏆', '👍', '❤️', '🔥', '👏', '🎉'];
            const textarea = document.getElementById('postTextarea');
            const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            textarea.value += randomEmoji;
            textarea.focus();
            // 触发input事件更新按钮状态
            textarea.dispatchEvent(new Event('input'));
        }

        // 点赞功能
        async function toggleLike(postId) {
            if (!githubToken) {
                showErrorToast('请登录后点赞');
                openLoginModal();
                return;
            }
            
            try {
                // 使用GitHub Reactions API
                const response = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/issues/${postId}/reactions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.squirrel-girl-preview+json'
                    },
                    body: JSON.stringify({
                        content: 'heart'
                    })
                });
                
                if (response.ok) {
                    showRefreshToast('点赞成功！');
                    loadSquarePosts(); // 刷新
                } else {
                    throw new Error('点赞失败');
                }
            } catch (error) {
                showErrorToast('点赞失败，请重试');
            }
        }

        // 转发功能
        function repost(postId) {
            showErrorToast('转发功能开发中...');
        }

        // 评论功能
        async function openComments(postId) {
            currentCommentPost = postId;
            const modal = document.getElementById('commentModal');
            const list = document.getElementById('commentList');
            
            modal.classList.add('show');
            
            // 加载评论
            list.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin"></i></div>';
            
            try {
                const response = await fetch(CONFIG.commentsApi(postId));
                if (!response.ok) throw new Error('加载评论失败');
                
                const comments = await response.json();
                
                if (!comments.length) {
                    list.innerHTML = '<div class="text-center text-gray-400 py-8">暂无评论，快来抢沙发！</div>';
                } else {
                    list.innerHTML = comments.map(comment => {
                        // 尝试解析评论中的用户信息
                        let userInfo = {};
                        let content = comment.body;
                        let createdAt = comment.created_at;
                        try {
                            const parsed = JSON.parse(content);
                            if (parsed.userInfo) {
                                userInfo = parsed.userInfo;
                                content = parsed.content;
                            }
                        } catch (e) {}
                        
                        const timeStr = formatTime(createdAt);
                        
                        return `
                            <div class="comment-item">
                                <img src="${userInfo.avatar || comment.user.avatar_url}" class="comment-avatar">
                                <div class="comment-body">
                                    <div class="comment-username">${userInfo.username || comment.user.login}</div>
                                    <div class="comment-meta">${timeStr}</div>
                                    <div class="comment-text">${escapeHtml(content)}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                list.innerHTML = '<div class="text-center text-red-400 py-8">加载失败</div>';
            }
        }

        function closeCommentModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('commentModal').classList.remove('show');
            currentCommentPost = null;
        }

        function handleCommentKeypress(event) {
            if (event.key === 'Enter') {
                submitComment();
            }
        }

        async function submitComment() {
            const input = document.getElementById('commentInput');
            const content = input.value.trim();
            
            if (!content) return;
            if (!githubToken) {
                showErrorToast('请输入Token后才能评论');
                return;
            }
            
            const submitBtn = document.querySelector('.comment-submit');
            submitBtn.disabled = true;
            
            try {
                const commentData = {
                    userInfo: currentUser,
                    content: content
                };
                
                const response = await fetch(CONFIG.commentsApi(currentCommentPost), {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        body: JSON.stringify(commentData)
                    })
                });
                
                if (response.ok) {
                    input.value = '';
                    openComments(currentCommentPost); // 刷新评论列表
                    loadSquarePosts(); // 刷新帖子列表（更新评论数）
                } else {
                    throw new Error('评论失败');
                }
            } catch (error) {
                showErrorToast('评论失败，请检查Token');
            } finally {
                submitBtn.disabled = false;
            }
        }

        // 用户主页
        function openUserProfile(username) {
            // 查找用户信息
            let userInfo = null;
            
            // 从登录码中查找
            for (const code in LOGIN_CODES) {
                if (LOGIN_CODES[code].username === username) {
                    userInfo = LOGIN_CODES[code];
                    break;
                }
            }
            
            // 从媒体账号中查找
            if (!userInfo) {
                const media = MEDIA_ACCOUNTS.find(m => m.username === username);
                if (media) userInfo = media;
            }
            
            // 从帖子中查找
            if (!userInfo) {
                const post = squarePosts.find(p => p.userInfo.username === username);
                if (post) userInfo = post.userInfo;
            }
            
            if (!userInfo) return;
            
            const page = document.getElementById('profilePage');
            document.getElementById('profileUsername').textContent = username;
            document.getElementById('profileAvatar').src = userInfo.avatar || CONFIG.defaultLogo;
            document.getElementById('profileName').textContent = username;
            document.getElementById('profileHandle').textContent = '@' + username.replace(/\s+/g, '');
            
            const typeBadge = document.getElementById('profileType');
            typeBadge.textContent = userInfo.type || '用户';
            typeBadge.className = `user-type-badge user-type-${userInfo.type === '球队' ? 'team' : userInfo.type === '个人' ? 'personal' : 'media'}`;
            
            document.getElementById('profileJoinDate').textContent = '· 2024年加入';
            
            // 统计用户帖子
            const userPosts = squarePosts.filter(p => p.userInfo.username === username);
            document.getElementById('profilePostCount').textContent = `${userPosts.length} 帖子`;
            
            // 假数据
            document.getElementById('profileFollowing').textContent = Math.floor(Math.random() * 100);
            document.getElementById('profileFollowers').textContent = Math.floor(Math.random() * 500);
            
            // 显示用户帖子
            const postsList = document.getElementById('profilePostsList');
            if (!userPosts.length) {
                postsList.innerHTML = '<div class="p-8 text-center text-gray-400">暂无帖子</div>';
            } else {
                postsList.innerHTML = userPosts.map(post => {
                    const timeStr = formatTime(post.createdAt);
                    const imagesHtml = renderPostImages(post.images);
                    return `
                        <div class="square-post">
                            <div class="square-post-user">
                                <img src="${post.userInfo.avatar || CONFIG.defaultLogo}" class="square-post-avatar-small">
                                <div class="square-post-info">
                                    <div class="square-post-name-row">
                                        <span class="square-post-username">${post.userInfo.username}</span>
                                        <span class="square-post-time">${timeStr}</span>
                                    </div>
                                    <div class="square-post-content">${escapeHtml(post.content)}</div>
                                    ${imagesHtml}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            page.classList.add('show');
            document.body.style.overflow = 'hidden';
            
            pushPageState('profile');
        }

        function closeProfilePage() {
            document.getElementById('profilePage').classList.remove('show');
            document.body.style.overflow = '';
        }

        function sharePost(postId) {
            const post = squarePosts.find(p => p.id === postId);
            if (post && navigator.share) {
                navigator.share({
                    title: `${post.userInfo.username}的帖子`,
                    text: post.content.substring(0, 100),
                    url: window.location.href
                });
            } else if (post) {
                navigator.clipboard.writeText(post.content);
                showRefreshToast('内容已复制');
            }
        }

        function previewImage(src) {
            document.getElementById('previewImage').src = src;
            document.getElementById('imagePreviewModal').classList.add('show');
        }

        function closeImagePreview() {
            document.getElementById('imagePreviewModal').classList.remove('show');
        }

        // 搜索功能增强
        function performSearch(keyword) {
            const container = document.getElementById('searchContent');
            if (!container) return;
            
            const lowerKeyword = keyword.toLowerCase();
            
            const matchedTeams = teamData.filter(t => 
                (t.name && t.name.toLowerCase().includes(lowerKeyword)) || 
                (t.stadium && t.stadium.toLowerCase().includes(lowerKeyword))
            );
            
            const matchedPlayers = playersData.filter(p => 
                (p.name && p.name.toLowerCase().includes(lowerKeyword)) ||
                (p.team && p.team.toLowerCase().includes(lowerKeyword)) ||
                (p.position && p.position.toLowerCase().includes(lowerKeyword))
            );
            
            const matchedNews = rssData.filter(n => 
                (n.title && n.title.toLowerCase().includes(lowerKeyword)) || 
                (n.description && n.description.toLowerCase().includes(lowerKeyword))
            );
            
            // 搜索广场帖子
            const matchedPosts = squarePosts.filter(p => 
                (p.content && p.content.toLowerCase().includes(lowerKeyword)) ||
                (p.userInfo.username && p.userInfo.username.toLowerCase().includes(lowerKeyword))
            );
            
            let html = '';
            let hasResult = false;
            const tabs = currentSearchTab === 'all' ? ['team', 'player', 'news', 'square'] : [currentSearchTab];
            
            tabs.forEach(type => {
                if (type === 'team' && matchedTeams.length > 0) {
                    hasResult = true;
                    html += `
                        <div class="mb-4">
                            <span class="search-section-title">球队 (${matchedTeams.length})</span>
                            ${matchedTeams.map(t => `
                                <div class="search-result-item" onclick="closeSearch(); openTeamDetail(${t.id})">
                                    <div class="team-logo-container team-logo-small bg-gray-100 dark:bg-gray-800 rounded p-1">
                                        <img src="${getTeamLogo(t.name)}" alt="${t.name || ''}" onerror="this.src='${CONFIG.defaultLogo}'">
                                    </div>
                                    <div class="flex-1">
                                        <div class="font-bold dark:text-gray-100">${highlightText(t.name || '', keyword)}</div>
                                        <div class="text-xs text-gray-500">${t.stadium || ''}</div>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-300"></i>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                if (type === 'player' && matchedPlayers.length > 0) {
                    hasResult = true;
                    html += `
                        <div class="mb-4">
                            <span class="search-section-title">球员 (${matchedPlayers.length})</span>
                            ${matchedPlayers.slice(0, 10).map(p => `
                                <div class="search-result-item" onclick="closeSearch(); openPlayerDetail(${p.id})">
                                    <div class="w-10 h-10 rounded-full bg-emerald-100 dark:bg-emerald-900 flex items-center justify-center text-emerald-600 dark:text-emerald-400 font-bold">
                                        ${p.name ? p.name.charAt(0) : '?'}
                                    </div>
                                    <div class="flex-1">
                                        <div class="font-bold dark:text-gray-100">${highlightText(p.name || '', keyword)}</div>
                                        <div class="text-xs text-gray-500">${p.team || ''} · ${p.positionName || ''} · CA${p.ca || 0}</div>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-300"></i>
                                </div>
                            `).join('')}
                            ${matchedPlayers.length > 10 ? `<div class="text-center text-xs text-gray-400 py-2">还有${matchedPlayers.length - 10}位球员</div>` : ''}
                        </div>
                    `;
                }
                
                if (type === 'news' && matchedNews.length > 0) {
                    hasResult = true;
                    html += `
                        <div class="mb-4">
                            <span class="search-section-title">新闻 (${matchedNews.length})</span>
                            ${matchedNews.slice(0, 5).map(n => `
                                <div class="search-result-item" onclick="closeSearch(); openArticleById('${n.id}')">
                                    <div class="flex-1">
                                        <div class="font-bold text-sm dark:text-gray-100 line-clamp-2">${highlightText(n.title || '', keyword)}</div>
                                        <div class="text-xs text-gray-500 mt-1">${formatTime(n.pubDate)}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                if (type === 'square' && matchedPosts.length > 0) {
                    hasResult = true;
                    html += `
                        <div class="mb-4">
                            <span class="search-section-title">广场 (${matchedPosts.length})</span>
                            ${matchedPosts.slice(0, 5).map(p => `
                                <div class="search-result-item" onclick="closeSearch(); switchTab('discussion')">
                                    <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center text-blue-600 dark:text-blue-400 font-bold">
                                        ${p.userInfo.username ? p.userInfo.username.charAt(0) : '?'}
                                    </div>
                                    <div class="flex-1">
                                        <div class="font-bold text-sm dark:text-gray-100 line-clamp-2">${highlightText(p.userInfo.username || '', keyword)}</div>
                                        <div class="text-xs text-gray-500 line-clamp-1">${highlightText(p.content || '', keyword)}</div>
                                        <div class="text-xs text-gray-400 mt-1">${formatTime(p.createdAt)}</div>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-300"></i>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            });
            
            if (!hasResult) {
                html = `
                    <div class="text-center text-gray-400 py-12">
                        <i class="fas fa-search text-4xl mb-3 opacity-30"></i>
                        <p>未找到"${keyword}"相关结果</p>
                        <p class="text-xs mt-2">试试搜索球队名、球员名、新闻关键词或广场内容</p>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // 保留所有原有的其他功能函数...
        // [此处包含所有原有的球队、球员、RSS等功能代码，保持完全不变]
        
        function initBackButtonHandler() {
            window.addEventListener('popstate', function(event) {
                isPopState = true;
                handleBackButton();
                isPopState = false;
            });

            history.replaceState({ page: 'home' }, '', location.href);
        }

        function pushPageState(pageName, data = {}) {
            const state = { page: pageName, data: data, timestamp: Date.now() };
            pageHistory.push(state);
            history.pushState(state, '', location.href);
        }

        function handleBackButton() {
            const searchPage = document.getElementById('searchPage');
            if (searchPage && searchPage.classList.contains('show')) {
                closeSearch();
                return;
            }

            const articlePage = document.getElementById('articlePage');
            if (articlePage && articlePage.classList.contains('show')) {
                closeArticle();
                return;
            }

            const pkResultPage = document.getElementById('pkResultPage');
            if (pkResultPage && pkResultPage.classList.contains('show')) {
                closePKResult();
                return;
            }

            const pkSelectModal = document.getElementById('pkSelectModal');
            if (pkSelectModal && pkSelectModal.classList.contains('show')) {
                closePKSelectModal();
                return;
            }

            const playerDetailPage = document.getElementById('playerDetailPage');
            if (playerDetailPage && !playerDetailPage.classList.contains('hidden')) {
                backToTeamDetail();
                return;
            }

            const coachDetailPage = document.getElementById('coachDetailPage');
            if (coachDetailPage && !coachDetailPage.classList.contains('hidden')) {
                backToTeamDetailFromCoach();
                return;
            }

            const teamDetailPage = document.getElementById('teamDetailPage');
            if (teamDetailPage && !teamDetailPage.classList.contains('hidden')) {
                backToTeamList();
                return;
            }

            const specialPlayersPage = document.getElementById('specialPlayersPage');
            if (specialPlayersPage && !specialPlayersPage.classList.contains('hidden')) {
                closeSpecialPlayersPage();
                return;
            }

            const profilePage = document.getElementById('profilePage');
            if (profilePage && profilePage.classList.contains('show')) {
                closeProfilePage();
                return;
            }

            const loginModal = document.getElementById('loginModal');
            if (loginModal && loginModal.classList.contains('show')) {
                closeLoginModal();
                return;
            }

            const commentModal = document.getElementById('commentModal');
            if (commentModal && commentModal.classList.contains('show')) {
                closeCommentModal();
                return;
            }

            if (currentTab !== 'home') {
                switchTab('home');
                return;
            }

            if (pageHistory.length <= 1) {
                return;
            }

            pageHistory.pop();
            if (pageHistory.length > 0) {
                const prevState = pageHistory[pageHistory.length - 1];
                if (prevState.page === 'home') {
                    switchTab('home');
                } else if (prevState.page === 'team') {
                    switchTab('team');
                } else if (prevState.page === 'transfer') {
                    switchTab('transfer');
                } else if (prevState.page === 'data') {
                    switchTab('data');
                } else if (prevState.page === 'discussion') {
                    switchTab('discussion');
                }
            }
        }

        function initApp() {
            try {
                const cached = localStorage.getItem('rss_cache');
                if (cached) {
                    try {
                        const { data } = JSON.parse(cached);
                        rssData = data || [];
                        renderNews();
                        updateSyncStatus('cached');
                    } catch (e) {
                        console.error('解析缓存失败:', e);
                        showEmptyState();
                    }
                } else {
                    showEmptyState();
                }
                
                const savedHistory = localStorage.getItem('search_history');
                if (savedHistory) {
                    try {
                        searchHistory = JSON.parse(savedHistory);
                    } catch (e) {
                        searchHistory = [];
                    }
                }
                
                const savedTeamHistory = localStorage.getItem('team_history_cache');
                if (savedTeamHistory) {
                    try {
                        teamHistoryData = JSON.parse(savedTeamHistory);
                    } catch (e) {
                        teamHistoryData = {};
                    }
                }
                
                const savedSchedule = localStorage.getItem('schedule_cache');
                if (savedSchedule) {
                    try {
                        scheduleData = JSON.parse(savedSchedule);
                    } catch (e) {
                        scheduleData = [];
                    }
                }

                updateClock();
                setInterval(updateClock, 1000);
                
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                }
                
                initPullToRefresh();
                
                switchTab('home');
                
                setTimeout(() => {
                    loadTeamHistoryData().catch(err => console.log('球队历史数据预加载失败:', err));
                }, 1000);
            } catch (error) {
                console.error('初始化失败:', error);
                showErrorToast('应用初始化失败，请刷新页面重试');
            }
        }

        function showErrorToast(message) {
            const toast = document.getElementById('errorToast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function getLeagueSortOrder(leagueName) {
            for (const key in LEAGUE_ORDER) {
                if (leagueName && leagueName.includes(key)) {
                    return LEAGUE_ORDER[key];
                }
            }
            return 999;
        }

        function openExternalDB(dbKey) {
            const db = EXTERNAL_DBS[dbKey];
            if (db && db.url) {
                window.open(db.url, '_blank');
            }
        }

        function openSearch() {
            const overlay = document.getElementById('searchOverlay');
            const page = document.getElementById('searchPage');
            const input = document.getElementById('searchInput');
            
            if (overlay) overlay.classList.add('show');
            if (page) page.classList.add('show');
            
            pushPageState('search');
            
            renderSearchInitial();
            
            setTimeout(() => {
                if (input) input.focus();
            }, 100);
        }

        function closeSearch() {
            const overlay = document.getElementById('searchOverlay');
            const page = document.getElementById('searchPage');
            
            if (overlay) overlay.classList.remove('show');
            if (page) page.classList.remove('show');
        }

        function handleSearchInput(value) {
            const clearBtn = document.getElementById('searchClear');
            if (value) {
                if (clearBtn) clearBtn.classList.add('show');
                performSearch(value);
            } else {
                if (clearBtn) clearBtn.classList.remove('show');
                renderSearchInitial();
            }
        }

        function handleSearchKeyup(event) {
            if (event.key === 'Enter') {
                const value = event.target.value;
                if (value) {
                    addSearchHistory(value);
                    performSearch(value);
                }
            }
        }

        function clearSearch() {
            const input = document.getElementById('searchInput');
            const clearBtn = document.getElementById('searchClear');
            
            if (input) {
                input.value = '';
                input.focus();
            }
            if (clearBtn) clearBtn.classList.remove('show');
            renderSearchInitial();
        }

        function addSearchHistory(keyword) {
            if (!keyword || searchHistory.includes(keyword)) return;
            searchHistory.unshift(keyword);
            if (searchHistory.length > 10) searchHistory.pop();
            localStorage.setItem('search_history', JSON.stringify(searchHistory));
        }

        function removeSearchHistory(keyword, event) {
            if (event) event.stopPropagation();
            searchHistory = searchHistory.filter(h => h !== keyword);
            localStorage.setItem('search_history', JSON.stringify(searchHistory));
            renderSearchInitial();
        }

        function clearAllHistory() {
            searchHistory = [];
            localStorage.removeItem('search_history');
            renderSearchInitial();
        }

        function switchSearchTab(tab) {
            currentSearchTab = tab;
            document.querySelectorAll('.search-tab').forEach(el => {
                el.classList.toggle('active', el.dataset.tab === tab);
            });
            const value = document.getElementById('searchInput')?.value;
            if (value) performSearch(value);
        }
        
        function renderSearchInitial() {
            const container = document.getElementById('searchContent');
            if (!container) return;
            
            let html = '';
            
            if (searchHistory && searchHistory.length > 0) {
                html += `
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-3">
                            <span class="search-section-title" style="margin-bottom: 0;">搜索历史</span>
                            <span class="text-xs text-gray-400 cursor-pointer" onclick="clearAllHistory()">清空</span>
                        </div>
                        <div>
                            ${searchHistory.map(h => `
                                <div class="search-history-item" onclick="quickSearch('${h}')">
                                    <div class="flex items-center gap-3">
                                        <i class="fas fa-history text-gray-400"></i>
                                        <span class="text-sm dark:text-gray-200">${h}</span>
                                    </div>
                                    <i class="fas fa-times text-gray-400 text-xs" onclick="removeSearchHistory('${h}', event)"></i>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            html += `
                <div>
                    <span class="search-section-title">热门搜索</span>
                    <div class="flex flex-wrap">
                        ${searchHotWords.map((word, idx) => `
                            <div class="search-hot-item" onclick="quickSearch('${word}')">
                                <span class="${idx < 3 ? 'text-red-500 font-bold' : 'text-gray-600 dark:text-gray-300'}">${idx + 1}</span>
                                <span class="dark:text-gray-200">${word}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function quickSearch(keyword) {
            const input = document.getElementById('searchInput');
            const clearBtn = document.getElementById('searchClear');
            
            if (input) input.value = keyword;
            if (clearBtn) clearBtn.classList.add('show');
            addSearchHistory(keyword);
            performSearch(keyword);
        }
        
        function openArticleById(id) {
            const post = rssData.find(p => p.id == id);
            if (post) openArticle(post);
        }

        function showEmptyState() {
            const newsFeed = document.getElementById('newsFeed');
            if (newsFeed) {
                newsFeed.innerHTML = `
                    <div class="p-8 text-center text-gray-400 dark:text-gray-500 mt-10">
                        <div class="text-4xl mb-3">📡</div>
                        <p class="mb-2">暂无数据</p>
                        <p class="text-xs mb-4">下拉刷新或点击首页按钮获取最新内容</p>
                        <button onclick="loadRSS()" class="px-6 py-2 bg-emerald-600 text-white rounded-lg text-sm hover:bg-emerald-700 transition">立即刷新</button>
                    </div>
                `;
            }
        }

        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const clockEl = document.getElementById('clock');
            if (clockEl) clockEl.textContent = `${hours}:${minutes}`;
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
        }

        function initPullToRefresh() {
            const container = document.getElementById('refreshContainer');
            if (!container) return;
            
            const indicator = document.getElementById('pullIndicator');
            
            container.addEventListener('touchstart', (e) => {
                if (window.scrollY === 0 && !isRefreshing && currentTab === 'home') {
                    touchStartY = e.touches[0].clientY;
                    isPulling = true;
                }
            }, { passive: true });
            
            container.addEventListener('touchmove', (e) => {
                if (!isPulling || isRefreshing || currentTab !== 'home') return;
                
                touchCurrentY = e.touches[0].clientY;
                const diff = touchCurrentY - touchStartY;
                
                if (diff > 0) {
                    e.preventDefault();
                    const pullDistance = Math.min(diff * 0.5, 120);
                    if (indicator) indicator.style.transform = `translateY(${pullDistance}px)`;
                    
                    const text = document.getElementById('pullText');
                    if (text) {
                        if (pullDistance > PULL_THRESHOLD) {
                            text.innerHTML = '<i class="fas fa-arrow-up mr-1"></i> 释放刷新';
                        } else {
                            text.innerHTML = '<i class="fas fa-arrow-down mr-1"></i> 下拉刷新';
                        }
                    }
                }
            }, { passive: false });
            
            container.addEventListener('touchend', () => {
                if (!isPulling || isRefreshing) return;
                
                const diff = touchCurrentY - touchStartY;
                
                if (diff > PULL_THRESHOLD && !isRefreshing) {
                    startRefresh();
                } else {
                    resetPullIndicator();
                }
                
                isPulling = false;
                touchStartY = 0;
                touchCurrentY = 0;
            });
        }

        function startRefresh() {
            isRefreshing = true;
            const indicator = document.getElementById('pullIndicator');
            const spinner = document.getElementById('pullSpinner');
            const text = document.getElementById('pullText');
            
            if (spinner) spinner.classList.remove('hidden');
            if (text) text.innerHTML = '<span class="ml-2">刷新中...</span>';
            if (indicator) indicator.style.transform = `translateY(60px)`;
            
            Promise.all([
                loadRSS().catch(e => console.error('RSS刷新失败:', e)),
                loadTeamHistoryData().catch(e => console.error('历史数据刷新失败:', e)),
                loadPlayerExtraData().catch(e => console.error('球员信息刷新失败:', e)),
                loadSquarePosts().catch(e => console.error('广场刷新失败:', e))
            ]).then(() => {
                showRefreshToast();
            }).finally(() => {
                setTimeout(() => {
                    resetPullIndicator();
                    isRefreshing = false;
                }, 500);
            });
        }

        function resetPullIndicator() {
            const indicator = document.getElementById('pullIndicator');
            const spinner = document.getElementById('pullSpinner');
            const text = document.getElementById('pullText');
            
            if (indicator) {
                indicator.style.transition = 'transform 0.3s';
                indicator.style.transform = 'translateY(0)';
            }
            if (spinner) spinner.classList.add('hidden');
            if (text) text.innerHTML = '<i class="fas fa-arrow-down mr-1"></i> 下拉刷新';
            
            setTimeout(() => {
                if (indicator) indicator.style.transition = '';
            }, 300);
        }

        function showRefreshToast(message) {
            const toast = document.getElementById('refreshToast');
            if (toast) {
                if (message) toast.innerHTML = `<i class="fas fa-check-circle mr-1"></i> ${message}`;
                else toast.innerHTML = '<i class="fas fa-check-circle mr-1"></i> 已更新';
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 2000);
            }
        }

        async function loadRSS() {
            updateSyncStatus('syncing');
            
            try {
                const githubUrl = `https://raw.githubusercontent.com/${CONFIG.owner}/${CONFIG.repo}/${CONFIG.branch}/${CONFIG.rssPath}?t=${new Date().getTime()}`;
                
                let response;
                try {
                    response = await fetch(githubUrl, {
                        method: 'GET',
                        headers: { 'Accept': 'application/xml, text/xml, */*' },
                        signal: AbortSignal.timeout(10000)
                    });
                } catch (e) {
                    console.log('GitHub请求失败，尝试代理');
                }

                if (!response || !response.ok) {
                    const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://sutterfootball.freeflarum.com/rss/t/garciafootball');
                    response = await fetch(proxyUrl, { signal: AbortSignal.timeout(10000) });
                }

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const xmlText = await response.text();
                if (!xmlText.includes('<?xml') && !xmlText.includes('<rss')) {
                    throw new Error('返回内容不是有效的 RSS');
                }

                const items = parseRSS(xmlText);
                if (!items || items.length === 0) throw new Error('RSS 解析结果为空');
                
                rssData = items;
                renderNews();
                updateSyncStatus('success', items.length);
                
                localStorage.setItem('rss_cache', JSON.stringify({
                    data: items,
                    time: new Date().toISOString()
                }));

            } catch (error) {
                console.error('RSS 加载失败:', error);
                const cached = localStorage.getItem('rss_cache');
                if (cached) {
                    try {
                        const { data, time } = JSON.parse(cached);
                        rssData = data;
                        renderNews();
                        updateSyncStatus('cached', data.length, time);
                    } catch (e) {
                        showEmptyState();
                    }
                } else {
                    showEmptyState();
                }
            }
        }

        function parseRSS(xmlText) {
            const parser = new DOMParser();
            const xml = parser.parseFromString(xmlText, 'text/xml');
            const parseError = xml.querySelector('parsererror');
            if (parseError) throw new Error('XML 解析错误');

            const items = xml.querySelectorAll('item');
            
            return Array.from(items).map((item, index) => {
                let title = item.querySelector('title')?.textContent || '无标题';
                title = title.replace(/<!\[CDATA\[(.*?)\]\]>/s, '$1').trim();
                
                const link = item.querySelector('link')?.textContent || '';
                
                let description = item.querySelector('description')?.textContent || '';
                description = description.replace(/<!\[CDATA\[(.*?)\]\]>/s, '$1').trim();
                
                let content = item.querySelector('content\\:encoded')?.textContent || 
                             item.querySelector('encoded')?.textContent || 
                             description;
                content = content.replace(/<!\[CDATA\[(.*?)\]\]>/s, '$1').trim();
                
                const pubDate = item.querySelector('pubDate')?.textContent || 
                               item.querySelector('dc\\:date')?.textContent || 
                               new Date().toISOString();
                
                const author = item.querySelector('author')?.textContent || 
                              item.querySelector('dc\\:creator')?.textContent || 
                              item.querySelector('creator')?.textContent || 
                              '加西亚足球APP';
                
                const categories = Array.from(item.querySelectorAll('category')).map(c => c.textContent);
                const category = categories[0] || detectCategory(title);
                
                const id = item.querySelector('guid')?.textContent || 
                          item.querySelector('link')?.textContent || 
                          index;
                
                const imgMatch = content.match(/<img[^>]+src=["']([^"']+)["']/i);
                const image = imgMatch ? imgMatch[1] : getDefaultImage(category, index);
                
                return { 
                    id, 
                    title, 
                    link, 
                    description: stripHtml(description).substring(0, 200) + '...', 
                    content, 
                    pubDate, 
                    author, 
                    category, 
                    image, 
                    comments: Math.floor(Math.random() * 100), 
                    views: Math.floor(Math.random() * 1000) + 100 
                };
            });
        }

        function detectCategory(title) {
            if (!title) return 'news';
            const lower = title.toLowerCase();
            if (lower.includes('战报') || lower.includes('vs') || lower.includes('-') || lower.includes('比赛')) return 'match';
            if (lower.includes('转会') || lower.includes('签约') || lower.includes('续约') || lower.includes('加盟')) return 'transfer';
            if (lower.includes('公告') || lower.includes('官方') || lower.includes('通知')) return 'official';
            if (lower.includes('分析') || lower.includes('战术') || lower.includes('数据')) return 'analysis';
            return 'news';
        }

        function getDefaultImage(category, seed) {
            const images = {
                match: 'https://images.unsplash.com/photo-1574629810360-7efbbe195018?w=400&h=300&fit=crop',
                transfer: 'https://images.unsplash.com/photo-1522778119026-d647f0565c6a?w=400&h=300&fit=crop',
                official: 'https://images.unsplash.com/photo-1556056504-5c7696c4c28d?w=400&h=300&fit=crop',
                analysis: 'https://images.unsplash.com/photo-1517927033932-b3d18e61fb3a?w=400&h=300&fit=crop',
                news: 'https://images.unsplash.com/photo-1489944440615-453fc2b6a9a9?w=400&h=300&fit=crop'
            };
            return images[category] || images.news;
        }

        function updateSyncStatus(status, count, cacheTime) {
            const el = document.getElementById('syncStatus');
            if (!el) return;
            
            const now = new Date();
            const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            
            switch(status) {
                case 'syncing':
                    el.innerHTML = '<i class="fas fa-sync-alt animate-spin mr-1"></i>更新中';
                    el.className = 'text-emerald-600 dark:text-emerald-400 text-[10px] mr-2';
                    break;
                case 'success':
                    el.innerHTML = `<i class="fas fa-check mr-1"></i>${count}条 ${timeStr}`;
                    el.className = 'text-emerald-600 dark:text-emerald-400 text-[10px] mr-2';
                    break;
                case 'cached':
                    const cacheDate = cacheTime ? new Date(cacheTime) : new Date();
                    const cacheTimeStr = `${String(cacheDate.getHours()).padStart(2,'0')}:${String(cacheDate.getMinutes()).padStart(2,'0')}`;
                    el.innerHTML = `<i class="fas fa-clock mr-1"></i>缓存 ${cacheTimeStr}`;
                    el.className = 'text-amber-600 dark:text-amber-400 text-[10px] mr-2';
                    break;
            }
        }

        function filterByTag(tag) {
            currentTag = tag;
            
            document.querySelectorAll('.tag-btn').forEach(btn => {
                btn.classList.remove('tag-active', 'text-emerald-600', 'dark:text-emerald-400');
                btn.classList.add('text-gray-600', 'dark:text-gray-400');
                if (btn.dataset.tag === tag) {
                    btn.classList.add('tag-active', 'text-emerald-600', 'dark:text-emerald-400');
                    btn.classList.remove('text-gray-600', 'dark:text-gray-400');
                }
            });
            
            renderNews();
        }

        function detectTeamsInNews(title, description) {
            const teams = [];
            const text = ((title || '') + ' ' + (description || '')).toLowerCase();
            
            for (const teamName in TEAM_LOGOS) {
                if (text.includes(teamName.toLowerCase())) {
                    teams.push(teamName);
                }
            }
            
            return teams;
        }

        function renderNews() {
            const feed = document.getElementById('newsFeed');
            if (!feed) return;
            
            feed.innerHTML = '';
            
            if (!rssData || rssData.length === 0) {
                showEmptyState();
                return;
            }
            
            const filtered = currentTag === 'all' ? rssData : rssData.filter(p => p.category === currentTag);
            
            if (!filtered || filtered.length === 0) {
                feed.innerHTML = `
                    <div class="p-8 text-center text-gray-400 dark:text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-3"></i>
                        <p>暂无相关文章</p>
                    </div>
                `;
                return;
            }
            
            filtered.forEach((post, index) => {
                const card = document.createElement('div');
                card.className = 'news-card bg-white dark:bg-dark-surface p-4 flex gap-4 cursor-pointer fade-in';
                card.style.animationDelay = `${index * 0.05}s`;
                card.onclick = () => openArticle(post);
                
                const tagColors = {
                    match: 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300',
                    transfer: 'bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300',
                    official: 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300',
                    analysis: 'bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-300',
                    news: 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'
                };
                
                const tagNames = { match: '战报', transfer: '转会', official: '公告', analysis: '分析', news: '新闻' };
                
                const tagClass = tagColors[post.category] || tagColors.news;
                const tagName = tagNames[post.category] || '新闻';
                
                const relatedTeams = detectTeamsInNews(post.title, post.description);
                let teamTagsHtml = '';
                if (relatedTeams.length > 0) {
                    teamTagsHtml = `
                        <div class="flex flex-wrap gap-2 mt-2">
                            ${relatedTeams.map(team => `
                                <span class="news-team-tag" onclick="event.stopPropagation(); goToTeamByName('${team}')">
                                    <img src="${getTeamLogo(team)}" alt="${team}" onerror="this.src='${CONFIG.defaultLogo}'">
                                    ${team}
                                </span>
                            `).join('')}
                        </div>
                    `;
                }
                
                card.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <h2 class="text-base font-bold text-gray-900 dark:text-gray-100 leading-snug mb-2 line-clamp-2">${escapeHtml(post.title)}</h2>
                        <p class="text-sm text-gray-500 dark:text-gray-400 line-clamp-2 mb-3 leading-relaxed">${escapeHtml(post.description)}</p>
                        <div class="flex items-center text-xs text-gray-400 dark:text-gray-500 gap-3">
                            <span class="${tagClass} px-2 py-0.5 rounded font-medium">${tagName}</span>
                            <span class="flex items-center gap-1"><i class="far fa-comment-alt"></i>${post.comments || 0}</span>
                            <span>${formatTime(post.pubDate)}</span>
                        </div>
                        ${teamTagsHtml}
                    </div>
                    <div class="w-24 h-20 flex-shrink-0 rounded-lg overflow-hidden bg-gray-200 dark:bg-gray-700">
                        <img src="${post.image}" alt="" class="w-full h-full object-cover" loading="lazy" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                    </div>
                `;
                
                feed.appendChild(card);
            });
        }

        function goToTeamByName(teamName) {
            if (!teamName) return;
            const team = teamData.find(t => t.name === teamName);
            if (team) {
                switchTab('team');
                setTimeout(() => openTeamDetail(team.id), 100);
            } else {
                showErrorToast('球队数据尚未加载，请先访问球队页面');
            }
        }

        function openArticle(post) {
            if (!post) return;
            const page = document.getElementById('articlePage');
            const content = document.getElementById('articleContent');
            
            if (!page || !content) return;
            
            const tagNames = { match: '比赛战报', transfer: '转会动态', official: '官方公告', analysis: '战术分析', news: '新闻报道' };
            
            const relatedTeams = detectTeamsInNews(post.title, post.description);
            let teamTagsHtml = '';
            if (relatedTeams.length > 0) {
                teamTagsHtml = `
                    <div class="flex flex-wrap gap-2 mt-4 pt-4 border-t border-gray-200 dark:border-dark-border">
                        <span class="text-sm text-gray-500 dark:text-gray-400 mr-2">相关球队：</span>
                        ${relatedTeams.map(team => `
                            <span class="news-team-tag" onclick="event.stopPropagation(); goToTeamByName('${team}')">
                                <img src="${getTeamLogo(team)}" alt="${team}" onerror="this.src='${CONFIG.defaultLogo}'">
                                ${team}
                            </span>
                        `).join('')}
                    </div>
                `;
            }
            
            content.innerHTML = `
                <div class="mb-4">
                    <span class="inline-block px-2 py-1 bg-emerald-100 dark:bg-emerald-900 text-emerald-700 dark:text-emerald-300 text-xs rounded mb-2 font-medium">
                        ${tagNames[post.category] || '新闻'}
                    </span>
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100 leading-tight mb-3">${escapeHtml(post.title)}</h1>
                    <div class="flex items-center justify-between text-sm text-gray-500 dark:text-gray-400 border-b border-gray-200 dark:border-dark-border pb-4">
                        <div class="flex items-center gap-2">
                            <span class="font-medium text-gray-700 dark:text-gray-300">${escapeHtml(post.author)}</span>
                            <span>•</span>
                            <span>${formatTime(post.pubDate)}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="flex items-center gap-1"><i class="far fa-eye"></i>${post.views || 0}</span>
                            <span class="flex items-center gap-1"><i class="far fa-comment"></i>${post.comments || 0}</span>
                        </div>
                    </div>
                </div>
                <div class="prose dark:prose-invert max-w-none text-gray-700 dark:text-gray-300 leading-relaxed text-base">
                    ${post.content || ''}
                </div>
                ${teamTagsHtml}
            `;
            
            page.classList.add('show');
            document.body.style.overflow = 'hidden';
            
            pushPageState('article', { id: post.id });
        }

        function closeArticle() {
            const page = document.getElementById('articlePage');
            if (page) page.classList.remove('show');
            document.body.style.overflow = '';
        }

        function shareArticle() {
            const title = document.querySelector('#articleContent h1')?.textContent || '加西亚足球APP';
            if (navigator.share) {
                navigator.share({ title: title, text: '来自加西亚足球APP', url: window.location.href });
            } else {
                navigator.clipboard.writeText(window.location.href).then(() => alert('链接已复制到剪贴板'));
            }
        }

        function getTeamLogo(teamName) {
            if (!teamName) return CONFIG.defaultLogo;
            if (teamName === '首都东木联合B') {
                return TEAM_LOGOS['首都-东木联合B'] || CONFIG.defaultLogo;
            }
            return TEAM_LOGOS[teamName] || CONFIG.defaultLogo;
        }
        
        function getPositionCategory(position) {
            if (!position) return 'MF';
            
            const posList = position.split(/[,，]/).map(p => p.trim());
            const firstPos = posList[0];
            
            if (firstPos.includes('门将') || firstPos.includes('守门')) return 'GK';
            if (firstPos.includes('后卫') || firstPos.endsWith('卫')) return 'DF';
            if (firstPos.includes('前锋') || firstPos.includes('中锋') || firstPos.includes('影锋') || firstPos.includes('边锋') || firstPos.endsWith('锋')) return 'FW';
            if (firstPos.includes('中场') || firstPos.includes('前卫') || firstPos.includes('后腰') || firstPos.includes('前腰') || firstPos.includes('中前卫') || firstPos.includes('组织') || firstPos.includes('进攻') || firstPos.endsWith('场') || firstPos.endsWith('腰')) return 'MF';
            
            return 'MF';
        }
        
        function getPositionColorClass(pos) {
            const map = { 'GK': 'position-gk', 'DF': 'position-df', 'MF': 'position-mf', 'FW': 'position-fw' };
            return map[pos] || 'position-mf';
        }
        
        function parseCoaches(coachStr) {
            if (!coachStr) return [];
            return coachStr.split(/[、,，/]/).map(c => c.trim()).filter(c => c);
        }
        
        function formatNumberRaw(num) {
            if (!num) return '0';
            return num.toString();
        }
        
        async function loadTeamData() {
            const teamList = document.getElementById('teamList');
            if (!teamList) return;
            
            teamList.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-emerald-600"></i><p class="text-sm text-gray-500 mt-2">加载球队数据...</p></div>';
            
            try {
                const response = await fetch(CONFIG.excelUrl, { signal: AbortSignal.timeout(15000) });
                if (!response.ok) throw new Error('无法加载数据文件');
                
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                
                if (!workbook || !workbook.SheetNames || workbook.SheetNames.length === 0) {
                    throw new Error('Excel文件为空或格式错误');
                }
                
                const teamSheetName = workbook.SheetNames.find(name => name.includes('球队')) || workbook.SheetNames[1] || workbook.SheetNames[0];
                const teamSheet = workbook.Sheets[teamSheetName];
                if (!teamSheet) throw new Error('找不到球队工作表');
                
                const teamJson = XLSX.utils.sheet_to_json(teamSheet, { header: 1 });
                if (!teamJson || teamJson.length === 0) throw new Error('球队数据为空');
                
                const playerSheetName = workbook.SheetNames.find(name => name.includes('球员')) || workbook.SheetNames[0];
                const playerSheet = workbook.Sheets[playerSheetName];
                if (!playerSheet) throw new Error('找不到球员工作表');
                
                const playerJson = XLSX.utils.sheet_to_json(playerSheet, { header: 1 });
                if (!playerJson || playerJson.length === 0) throw new Error('球员数据为空');
                
                const teamHeaders = teamJson[0] || [];
                teamData = [];
                for (let i = 1; i < teamJson.length; i++) {
                    const row = teamJson[i];
                    if (!row || !row[0]) continue;
                    
                    const teamObj = {};
                    teamHeaders.forEach((header, idx) => {
                        if (header) teamObj[header] = row[idx];
                    });
                    
                    teamData.push({
                        id: i - 1,
                        name: teamObj['球队名'] || '',
                        manager: teamObj['玩家'] || '',
                        coach: teamObj['教练组'] || '',
                        stadium: teamObj['主场'] || '',
                        capacity: teamObj['座席数'] || 0,
                        avgAttendance: teamObj['场均上座'] || 0,
                        occupancyRate: teamObj['上座率'] || 0,
                        revenue: teamObj['收入'] || 0,
                        funds: teamObj['球队资金'] || 0,
                        sponsor1: teamObj['赞助商1'] || '',
                        sponsor2: teamObj['赞助商2'] || '',
                        youth: teamObj['青训'] || '',
                        other: teamObj['其他'] || ''
                    });
                }
                
                const playerHeaders = playerJson[0] || [];
                playersData = [];
                freeAgents = [];
                retiredPlayers = [];
                transferredPlayers = [];
                
                for (let i = 1; i < playerJson.length; i++) {
                    const row = playerJson[i];
                    if (!row || !row[0]) continue;
                    
                    const playerObj = {};
                    playerHeaders.forEach((header, idx) => {
                        if (header) playerObj[header] = row[idx];
                    });
                    
                    const position = playerObj['位置'] || '';
                    const mainPos = getPositionCategory(position);
                    const posList = position.split(/[,،，、/]/).map(p => p.trim()).filter(p => p);
                    
                    const player = {
                        id: i - 1,
                        name: playerObj['球员名称'] || '',
                        age: playerObj['年龄'] || 0,
                        nation: playerObj['国家/地区籍'] || '',
                        height: playerObj['身高'] || 0,
                        weight: playerObj['体重'] || 0,
                        ca: playerObj['CA'] || 0,
                        pa: playerObj['PA'] || 0,
                        position: position,
                        mainPosition: mainPos,
                        positionName: posList[0] || '未知',
                        allPositions: posList,
                        wage: playerObj['年薪'] || 0,
                        team: playerObj['所在球队'] || '',
                        contractEnd: playerObj['合约到期'] || '',
                        clause: playerObj['违约金'] || '',
                        contractType: playerObj['合同类型'] || '',
                        contractNote: playerObj['合同备注'] || ''
                    };
                    
                    playersData.push(player);
                    
                    const team = player.team || '';
                    if (team.includes('自由') || team.includes('unattached') || team.includes('Unattached')) {
                        freeAgents.push(player);
                    } else if (team.includes('退役') || team.includes('retired') || team.includes('Retired')) {
                        retiredPlayers.push(player);
                    } else if (team.includes('转出') || team.includes('transferred') || team.includes('Transferred') || team.includes('离队')) {
                        transferredPlayers.push(player);
                    }
                }
                
                updateSpecialPlayerCounts();
                
                if (Object.keys(teamHistoryData).length === 0 && !isLoadingTeamHistory) {
                    await loadTeamHistoryData().catch(e => console.error('加载历史数据失败:', e));
                }
                
                renderTeamList();
                
            } catch (error) {
                console.error('加载球队数据失败:', error);
                if (teamList) {
                    teamList.innerHTML = `
                        <div class="text-center text-red-500 py-8">
                            <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                            <p class="text-sm">加载失败: ${error.message}</p>
                            <button onclick="loadTeamData()" class="mt-4 px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm">重试</button>
                        </div>
                    `;
                }
            }
        }
        
        function updateSpecialPlayerCounts() {
            const freeEl = document.getElementById('freeAgentCount');
            const retiredEl = document.getElementById('retiredCount');
            const transferredEl = document.getElementById('transferredCount');
            
            if (freeEl) freeEl.textContent = `${freeAgents.length} 位球员`;
            if (retiredEl) retiredEl.textContent = `${retiredPlayers.length} 位球员`;
            if (transferredEl) transferredEl.textContent = `${transferredPlayers.length} 位球员`;
        }
        
        function showSpecialPlayers(type) {
            const page = document.getElementById('specialPlayersPage');
            const title = document.getElementById('specialPlayersTitle');
            const list = document.getElementById('specialPlayersList');
            
            if (!page || !title || !list) return;
            
            let players = [];
            let titleText = '';
            
            switch(type) {
                case 'free':
                    players = freeAgents;
                    titleText = '自由球员';
                    break;
                case 'retired':
                    players = retiredPlayers;
                    titleText = '已退役球员';
                    break;
                case 'transferred':
                    players = transferredPlayers;
                    titleText = '已转出球员';
                    break;
            }
            
            title.textContent = titleText;
            
            if (!players || players.length === 0) {
                list.innerHTML = `
                    <div class="bg-white dark:bg-dark-surface rounded-lg p-8 text-center text-gray-400">
                        <i class="fas fa-user-slash text-4xl mb-3"></i>
                        <p>暂无${titleText}</p>
                    </div>
                `;
            } else {
                players.sort((a, b) => (b.ca || 0) - (a.ca || 0));
                
                list.innerHTML = `
                    <div class="bg-white dark:bg-dark-surface rounded-lg overflow-hidden">
                        ${players.map((player, idx) => `
                            <div onclick="openPlayerDetail(${player.id})" class="player-card flex items-center gap-3 p-4 ${idx !== players.length - 1 ? 'border-b border-gray-100 dark:border-dark-border' : ''} cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-sm dark:text-gray-100">${player.name || ''}</span>
                                        <span class="position-badge ${getPositionColorClass(player.mainPosition)}">${player.positionName || ''}</span>
                                    </div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                                        ${player.age || 0}岁 · ${player.nation || ''} · 原球队：${player.team || ''}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-bold text-emerald-600">${player.ca || 0}</div>
                                    <div class="text-xs text-gray-400">CA</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            page.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            pushPageState('specialPlayers', { type: type });
        }
        
        function closeSpecialPlayersPage() {
            const page = document.getElementById('specialPlayersPage');
            if (page) page.classList.add('hidden');
            document.body.style.overflow = '';
        }
        
        function renderTeamList() {
            const container = document.getElementById('teamList');
            if (!container) return;
            
            if (!teamData || teamData.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">暂无球队数据</div>';
                return;
            }
            
            container.innerHTML = teamData.map((team, idx) => `
                <div onclick="openTeamDetail(${team.id})" class="bg-white dark:bg-dark-surface rounded-lg p-4 flex items-center gap-4 shadow-sm cursor-pointer active:scale-95 transition-transform">
                    <div class="team-logo-container team-logo-list bg-gray-50 dark:bg-gray-800 rounded-lg p-1">
                        <img src="${getTeamLogo(team.name)}" alt="${team.name || ''}" onerror="this.src='${CONFIG.defaultLogo}'">
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <h3 class="font-bold text-lg dark:text-gray-100 truncate">${team.name || ''}</h3>
                        </div>
                        <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
                            <span class="truncate">${team.stadium || ''}</span>
                        </div>
                        <div class="flex items-center gap-3 mt-1 text-xs text-gray-400">
                            <span>资金: ${formatNumber(team.funds)}万</span>
                            <span>上座: ${formatNumber(team.avgAttendance)}</span>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 dark:text-gray-600"></i>
                </div>
            `).join('');
        }
        
        function formatNumber(num) {
            if (!num) return '0';
            if (num >= 10000) return (num / 10000).toFixed(1) + '亿';
            if (num >= 1000) return (num / 1000).toFixed(1) + '千万';
            return num.toString();
        }
        
        async function openTeamDetail(teamId) {
            if (teamData.length === 0) {
                showErrorToast('球队数据尚未加载');
                return;
            }
            
            currentTeam = teamData.find(t => t.id === teamId);
            if (!currentTeam) {
                showErrorToast('未找到球队信息');
                return;
            }
            
            const statsContent = document.getElementById('statsContent');
            if (statsContent) {
                statsContent.innerHTML = `
                    <div class="data-loading">
                        <div class="data-loading-spinner"></div>
                        <p>加载球队历史数据...</p>
                    </div>
                `;
            }
            
            if (Object.keys(teamHistoryData).length === 0 && !isLoadingTeamHistory) {
                console.log('历史数据为空，重新加载...');
                await loadTeamHistoryData().catch(e => console.error('加载历史数据失败:', e));
            }
            
            let historyData = getTeamHistoryData(currentTeam.name);
            
            if (!historyData) {
                const normalizedName = normalizeTeamName(currentTeam.name);
                for (const key in teamHistoryData) {
                    if (normalizeTeamName(key) === normalizedName) {
                        console.log('模糊匹配成功:', currentTeam.name, '->', key);
                        historyData = teamHistoryData[key];
                        break;
                    }
                }
            }
            
            console.log('打开球队详情:', currentTeam.name, '历史数据:', historyData ? '有' : '无');
            
            currentCoaches = parseCoaches(currentTeam.coach);
            const headCoach = currentCoaches[0] || '暂无';
            
            const teamPlayers = playersData.filter(p => p.team === currentTeam.name);
            const totalWages = teamPlayers.reduce((sum, p) => sum + (parseFloat(p.wage) || 0), 0);
            const projectedFunds = (parseFloat(currentTeam.funds) || 0) - totalWages;
            
            let avgCA = 0, avgPA = 0, avgAge = 0;
            if (teamPlayers.length > 0) {
                const totalCA = teamPlayers.reduce((sum, p) => sum + (parseFloat(p.ca) || 0), 0);
                const totalPA = teamPlayers.reduce((sum, p) => sum + (parseFloat(p.pa) || 0), 0);
                const totalAge = teamPlayers.reduce((sum, p) => sum + (parseFloat(p.age) || 0), 0);
                avgCA = (totalCA / teamPlayers.length).toFixed(1);
                avgPA = (totalPA / teamPlayers.length).toFixed(1);
                avgAge = (totalAge / teamPlayers.length).toFixed(1);
            }
            
            const nameEl = document.getElementById('teamDetailName');
            const nameEnEl = document.getElementById('teamDetailNameEn');
            const coachEl = document.getElementById('teamDetailCoach');
            const fundsEl = document.getElementById('teamDetailFunds');
            const attendanceEl = document.getElementById('teamDetailAttendance');
            const occupancyEl = document.getElementById('teamDetailOccupancy');
            const capacityEl = document.getElementById('teamDetailCapacity');
            const wagesEl = document.getElementById('teamDetailWages');
            const projectedEl = document.getElementById('teamDetailProjected');
            const avgCAEl = document.getElementById('teamDetailAvgCA');
            const avgPAEl = document.getElementById('teamDetailAvgPA');
            const avgAgeEl = document.getElementById('teamDetailAvgAge');
            const warningEl = document.getElementById('financialWarning');
            const logoEl = document.getElementById('teamDetailLogo');
            const coachCardEl = document.getElementById('coachCard');
            
            if (nameEl) nameEl.textContent = currentTeam.name || '';
            if (nameEnEl) nameEnEl.textContent = currentTeam.stadium || '';
            if (coachEl) coachEl.textContent = headCoach;
            
            if (fundsEl) fundsEl.textContent = formatNumberRaw(currentTeam.funds);
            if (attendanceEl) attendanceEl.textContent = formatNumberRaw(currentTeam.avgAttendance);
            if (occupancyEl) occupancyEl.textContent = ((currentTeam.occupancyRate || 0) * 100).toFixed(1) + '%';
            if (capacityEl) capacityEl.textContent = formatNumberRaw(currentTeam.capacity);
            
            if (wagesEl) wagesEl.textContent = formatNumberRaw(totalWages);
            if (projectedEl) projectedEl.textContent = formatNumberRaw(projectedFunds);
            
            if (avgCAEl) avgCAEl.textContent = avgCA > 0 ? avgCA : '--';
            if (avgPAEl) avgPAEl.textContent = avgPA > 0 ? avgPA : '--';
            if (avgAgeEl) avgAgeEl.textContent = avgAge > 0 ? avgAge : '--';
            
            if (warningEl) {
                if (projectedFunds < 0) {
                    warningEl.classList.remove('hidden');
                } else {
                    warningEl.classList.add('hidden');
                }
            }
            
            if (logoEl) logoEl.src = getTeamLogo(currentTeam.name);
            
            if (coachCardEl) {
                coachCardEl.innerHTML = `
                    <div class="font-bold dark:text-gray-100 text-lg">${headCoach}</div>
                    <div class="text-sm text-gray-500">主教练</div>
                `;
            }
            
            renderSquad();
            renderTeamNews();
            renderTeamStats();
            
            switchTeamTab('squad');
            
            const detailPage = document.getElementById('teamDetailPage');
            if (detailPage) {
                detailPage.classList.remove('hidden');
            }
            document.body.style.overflow = 'hidden';
            
            pushPageState('teamDetail', { teamId: teamId });
        }
        
        function normalizeTeamName(name) {
            if (!name) return '';
            return name.toLowerCase()
                .replace(/[\s\-\_\(\)（）\[\]]/g, '')
                .replace(/fc|俱乐部|队|城/g, '');
        }
        
        function renderTeamStats() {
            const container = document.getElementById('statsContent');
            if (!container || !currentTeam) return;
            
            let historyData = getTeamHistoryData(currentTeam.name);
            
            if (!historyData) {
                const normalizedName = normalizeTeamName(currentTeam.name);
                for (const key in teamHistoryData) {
                    if (normalizeTeamName(key) === normalizedName) {
                        historyData = teamHistoryData[key];
                        break;
                    }
                }
            }
            
            let html = '';
            
            html += `
                <div class="data-section">
                    <div class="data-section-title">球队资料</div>
                    <div class="info-row">
                        <span class="info-label">赞助商1</span>
                        <span class="info-value">${currentTeam.sponsor1 || '暂无'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">赞助商2</span>
                        <span class="info-value">${currentTeam.sponsor2 || '暂无'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">青训级别</span>
                        <span class="info-value">${currentTeam.youth || '暂无'}</span>
                    </div>
                    ${currentTeam.youth ? calculateYouthRankHtml(currentTeam.youth) : ''}
                </div>
            `;
            
            if (historyData) {
                if (historyData.nameChanges && historyData.nameChanges.trim()) {
                    html += `
                        <div class="data-section">
                            <div class="data-section-title">球队变迁</div>
                            <div class="change-text text-sm leading-relaxed">${historyData.nameChanges}</div>
                        </div>
                    `;
                }
                
                if (historyData.rankings && Object.keys(historyData.rankings).length > 0) {
                    const sortedRankings = Object.entries(historyData.rankings)
                        .sort((a, b) => {
                            const numA = parseInt(a[0].replace(/[^0-9]/g, ''));
                            const numB = parseInt(b[0].replace(/[^0-9]/g, ''));
                            return numA - numB;
                        });
                    
                    html += `
                        <div class="data-section">
                            <div class="data-section-title">近年联赛排名</div>
                            <div class="ranking-chart-container">
                                <canvas id="rankingChart"></canvas>
                            </div>
                        </div>
                    `;
                    
                    requestAnimationFrame(() => {
                        setTimeout(() => drawRankingChart(sortedRankings), 100);
                    });
                }
                
                if (historyData.topScorers && historyData.topScorers.length > 0) {
                    html += `
                        <div class="data-section">
                            <div class="data-section-title">历史射手榜</div>
                            <div>
                                ${historyData.topScorers.map((scorer, idx) => `
                                    <div class="scorer-item">
                                        <div class="flex items-center gap-3">
                                            <span class="w-6 text-center text-xs font-bold ${idx < 3 ? 'text-emerald-600' : 'text-gray-400'}">${idx + 1}</span>
                                            <span class="text-sm font-medium flex-1">${scorer.name || ''}</span>
                                        </div>
                                        <span class="text-sm font-bold text-emerald-600">${scorer.goals || 0}球</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                if (historyData.honors && historyData.honors.length > 0) {
                    const honorStats = {};
                    historyData.honors.forEach(h => {
                        if (h.rank === '冠军') {
                            const key = h.competition;
                            if (!honorStats[key]) {
                                honorStats[key] = { count: 0, seasons: [] };
                            }
                            honorStats[key].count++;
                            if (h.season) honorStats[key].seasons.push(h.season);
                        }
                    });
                    
                    const honorWallHtml = Object.entries(honorStats).length > 0 ? `
                        <div class="honor-wall">
                            ${Object.entries(honorStats).map(([competition, data]) => `
                                <div class="honor-tile">
                                    <div class="honor-icon">🏆</div>
                                    <div class="honor-count">${data.count}</div>
                                    <div class="honor-name">${competition}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '';
                    
                    html += `
                        <div class="data-section">
                            <div class="data-section-title">球队荣誉</div>
                            ${honorWallHtml}
                            <div class="mt-4 space-y-2">
                                ${historyData.honors.map(honor => {
                                    let badgeClass = 'honor-badge';
                                    if (honor.rank === '亚军') badgeClass += ' second';
                                    else if (honor.rank === '季军') badgeClass += ' third';
                                    
                                    return `
                                        <div class="honor-item">
                                            ${honor.rank ? `<span class="${badgeClass}">${honor.rank}</span>` : ''}
                                            <span class="text-sm flex-1">${honor.competition || ''}</span>
                                            ${honor.season ? `<span class="text-xs text-gray-500">${honor.season}</span>` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            
            if (!historyData || (!historyData.nameChanges && !Object.keys(historyData.rankings || {}).length && !historyData.topScorers?.length && !historyData.honors?.length)) {
                if (!html.includes('data-section')) {
                    html = `
                        <div class="bg-white dark:bg-dark-surface rounded-lg p-8 text-center text-gray-400 m-4">
                            <i class="fas fa-chart-bar text-4xl mb-3"></i>
                            <p>暂无历史数据</p>
                            <p class="text-xs mt-2">该球队可能没有在 txt 文件中记录历史数据</p>
                            <button onclick="forceReloadTeamHistory()" class="mt-4 px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm">强制刷新数据</button>
                        </div>
                    `;
                }
            }
            
            container.innerHTML = html;
        }
        
        function calculateYouthRankHtml(currentYouthLevel) {
            if (!currentYouthLevel || !teamData || teamData.length === 0) return '';
            
            const parseYouthValue = (youth) => {
                if (!youth) return 0;
                const numMatch = youth.toString().match(/\d+/);
                if (numMatch) return parseInt(numMatch[0]);
                const youthStr = youth.toString().toUpperCase();
                if (youthStr.includes('A')) return 100;
                if (youthStr.includes('B')) return 80;
                if (youthStr.includes('C')) return 60;
                if (youthStr.includes('D')) return 40;
                return 0;
            };
            
            const currentValue = parseYouthValue(currentYouthLevel);
            
            let rank = 1;
            teamData.forEach(team => {
                if (team.id !== currentTeam.id) {
                    const teamValue = parseYouthValue(team.youth);
                    if (teamValue > currentValue) {
                        rank++;
                    }
                }
            });
            
            const totalTeams = teamData.length;
            
            return `
                <div class="youth-rank-box">
                    <span class="youth-rank-label">全联赛青训排名</span>
                    <span class="youth-rank-value">第 ${rank} / ${totalTeams} 名</span>
                </div>
            `;
        }
        
        async function forceReloadTeamHistory() {
            const container = document.getElementById('statsContent');
            if (container) {
                container.innerHTML = `
                    <div class="data-loading">
                        <div class="data-loading-spinner"></div>
                        <p>正在重新加载数据...</p>
                    </div>
                `;
            }
            
            teamHistoryData = {};
            await loadTeamHistoryData();
            renderTeamStats();
        }
        
        function drawRankingChart(rankings) {
            const canvas = document.getElementById('rankingChart');
            if (!canvas) return;
            
            const container = canvas.parentElement;
            const dpr = window.devicePixelRatio || 1;
            const rect = container.getBoundingClientRect();
            
            if (!rect || rect.width === 0 || rect.height === 0) return;
            
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);
            
            const width = rect.width;
            const height = rect.height;
            
            ctx.clearRect(0, 0, width, height);
            
            if (!rankings || rankings.length === 0) return;
            
            const data = rankings.map(r => r[1] ? r[1].rank : 0);
            const labels = rankings.map(r => r[1] ? r[1].season : '');
            
            if (data.length === 0) return;
            
            const padding = { top: 30, right: 30, bottom: 30, left: 40 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            
            const maxRank = Math.max(...data, 20);
            const minRank = 1;
            
            ctx.strokeStyle = document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb';
            ctx.lineWidth = 1;
            
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();
                
                const rankValue = Math.round(maxRank - (maxRank - minRank) * (i / 5));
                ctx.fillStyle = document.documentElement.classList.contains('dark') ? '#9ca3af' : '#6b7280';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(rankValue.toString(), padding.left - 5, y + 3);
            }
            
            if (data.length > 1) {
                ctx.strokeStyle = '#f97316';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                data.forEach((rank, idx) => {
                    const x = padding.left + (chartWidth / (data.length - 1)) * idx;
                    const y = padding.top + ((rank - minRank) / (maxRank - minRank)) * chartHeight;
                    
                    if (idx === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                
                ctx.stroke();
            }
            
            data.forEach((rank, idx) => {
                const x = padding.left + (chartWidth / Math.max(data.length - 1, 1)) * idx;
                const y = padding.top + ((rank - minRank) / (maxRank - minRank)) * chartHeight;
                
                ctx.fillStyle = '#f97316';
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(x, y, 2, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = document.documentElement.classList.contains('dark') ? '#fff' : '#1f2937';
                ctx.font = 'bold 12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(rank.toString(), x, y - 10);
                
                ctx.fillStyle = document.documentElement.classList.contains('dark') ? '#9ca3af' : '#6b7280';
                ctx.font = '10px sans-serif';
                ctx.fillText(labels[idx] || '', x, height - 10);
            });
        }
        
        function renderTeamNews() {
            const container = document.getElementById('teamNewsList');
            if (!container || !currentTeam) return;
            
            const teamNews = rssData.filter(post => {
                const text = ((post.title || '') + ' ' + (post.description || '')).toLowerCase();
                return text.includes((currentTeam.name || '').toLowerCase());
            });
            
            if (teamNews.length === 0) {
                container.innerHTML = `
                    <div class="bg-white dark:bg-dark-surface rounded-lg p-8 text-center text-gray-400">
                        <i class="fas fa-newspaper text-4xl mb-2"></i>
                        <p>暂无相关动态</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = teamNews.map((post, idx) => {
                const tagColors = {
                    match: 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300',
                    transfer: 'bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300',
                    official: 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300',
                    analysis: 'bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-300',
                    news: 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'
                };
                const tagNames = { match: '战报', transfer: '转会', official: '公告', analysis: '分析', news: '新闻' };
                const tagClass = tagColors[post.category] || tagColors.news;
                const tagName = tagNames[post.category] || '新闻';
                
                return `
                    <div onclick="openArticleFromTeam('${post.id}')" class="bg-white dark:bg-dark-surface rounded-lg p-4 shadow-sm cursor-pointer active:scale-95 transition-transform">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="${tagClass} px-2 py-0.5 rounded text-xs font-medium">${tagName}</span>
                            <span class="text-xs text-gray-400">${formatTime(post.pubDate)}</span>
                        </div>
                        <h4 class="font-bold text-sm dark:text-gray-100 line-clamp-2">${escapeHtml(post.title)}</h4>
                        <p class="text-xs text-gray-500 dark:text-gray-400 line-clamp-2 mt-1">${escapeHtml(post.description)}</p>
                    </div>
                `;
            }).join('');
        }
        
        function openArticleFromTeam(postId) {
            const post = rssData.find(p => String(p.id) === String(postId));
            if (post) {
                openArticle(post);
            } else {
                console.error('未找到新闻:', postId);
            }
        }
        
        function openCoachDetail() {
            const container = document.getElementById('coachList');
            if (!container) return;
            
            if (!currentCoaches || currentCoaches.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">暂无教练信息</div>';
            } else {
                container.innerHTML = currentCoaches.map((coach, idx) => `
                    <div class="coach-list-item">
                        <div class="coach-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="coach-info">
                            <div class="coach-name">${coach || ''}</div>
                            <div class="coach-record">随机数 ${Math.floor(Math.random() * 30 + 40)}%</div>
                        </div>
                        <div class="coach-duration">
                            <div class="${idx === 0 ? 'coach-current' : ''}">${idx === 0 ? '主教练' : '助理教练'}</div>
                            <div style="font-size: 11px; color: #999; margin-top: 2px;">
                                ${idx === 0 ? '现任教练组成员' : '现任教练组成员'}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            const coachPage = document.getElementById('coachDetailPage');
            if (coachPage) coachPage.classList.remove('hidden');
            
            pushPageState('coachDetail');
        }
        
        function backToTeamDetailFromCoach() {
            const coachPage = document.getElementById('coachDetailPage');
            if (coachPage) coachPage.classList.add('hidden');
        }
        
        function renderSquad() {
            const container = document.getElementById('playersList');
            if (!container || !currentTeam) return;
            
            const teamPlayers = playersData.filter(p => p.team === currentTeam.name);
            
            if (!teamPlayers || teamPlayers.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">暂无球员数据</div>';
                return;
            }
            
            const positionOrder = ['GK', 'DF', 'MF', 'FW'];
            const positionTitles = {'GK': '门将', 'DF': '后卫', 'MF': '中场', 'FW': '前锋'};
            
            container.innerHTML = positionOrder.map(pos => {
                const posPlayers = teamPlayers.filter(p => p.mainPosition === pos);
                if (!posPlayers || posPlayers.length === 0) return '';
                
                return `
                    <div class="mb-4">
                        <h3 class="text-sm font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wider">${positionTitles[pos]} (${posPlayers.length}人)</h3>
                        <div class="bg-white dark:bg-dark-surface rounded-lg overflow-hidden shadow-sm">
                            ${posPlayers.map((player, idx) => `
                                <div onclick="openPlayerDetail(${player.id})" class="player-card flex items-center gap-3 p-3 ${idx !== posPlayers.length - 1 ? 'border-b border-gray-100 dark:border-dark-border' : ''} cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2">
                                            <span class="font-bold text-sm dark:text-gray-100">${player.name || ''}</span>
                                            <span class="position-badge ${getPositionColorClass(pos)}">${player.positionName || ''}</span>
                                        </div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                                            ${player.age || 0}岁 · ${player.nation || ''} · 年薪${player.wage || 0}万
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold text-emerald-600">${player.ca || 0}</div>
                                        <div class="text-xs text-gray-400">CA</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function switchTeamTab(tab) {
            document.querySelectorAll('.team-tab').forEach(btn => {
                if (btn.dataset.tab === tab) {
                    btn.classList.add('tab-active');
                    btn.classList.remove('text-gray-500', 'dark:text-gray-400');
                } else {
                    btn.classList.remove('tab-active');
                    btn.classList.add('text-gray-500', 'dark:text-gray-400');
                }
            });
            
            ['squad', 'stats', 'news'].forEach(t => {
                const el = document.getElementById(t + 'Content');
                if (el) el.classList.toggle('hidden', t !== tab);
            });
            
            if (tab === 'stats') {
                setTimeout(() => {
                    const historyData = getTeamHistoryData(currentTeam.name) || 
                        Object.entries(teamHistoryData).find(([key]) => normalizeTeamName(key) === normalizeTeamName(currentTeam.name))?.[1];
                    
                    if (historyData && historyData.rankings && Object.keys(historyData.rankings).length > 0) {
                        const sortedRankings = Object.entries(historyData.rankings)
                            .sort((a, b) => {
                                const numA = parseInt(a[0].replace(/[^0-9]/g, ''));
                                const numB = parseInt(b[0].replace(/[^0-9]/g, ''));
                                return numA - numB;
                            });
                        drawRankingChart(sortedRankings);
                    }
                }, 50);
            }
        }
        
        function backToTeamList() {
            const detailPage = document.getElementById('teamDetailPage');
            const coachPage = document.getElementById('coachDetailPage');
            if (detailPage) detailPage.classList.add('hidden');
            if (coachPage) coachPage.classList.add('hidden');
            document.body.style.overflow = '';
            currentTeam = null;
            currentCoaches = [];
        }
        
        function shareTeam() {
            if (navigator.share && currentTeam) {
                navigator.share({
                    title: currentTeam.name || '',
                    text: `查看${currentTeam.name || ''}的详细资料`,
                    url: window.location.href
                });
            }
        }
        
        function openPlayerDetail(playerId) {
            const player = playersData.find(p => p.id === playerId);
            if (!player) return;
            
            currentPKPlayer = player;
            
            const initialEl = document.getElementById('playerInitial');
            const positionEl = document.getElementById('playerDetailPosition');
            const nameEl = document.getElementById('playerDetailName');
            const teamEl = document.getElementById('playerDetailTeam');
            const ratingEl = document.getElementById('playerDetailRating');
            const caEl = document.getElementById('playerDetailCA');
            const paEl = document.getElementById('playerDetailPA');
            const ageEl = document.getElementById('playerDetailAge');
            const nationEl = document.getElementById('playerDetailNation');
            const heightEl = document.getElementById('playerDetailHeight');
            const weightEl = document.getElementById('playerDetailWeight');
            const team2El = document.getElementById('playerDetailTeam2');
            const contractEl = document.getElementById('playerDetailContract');
            const wageEl = document.getElementById('playerDetailWage');
            const clauseEl = document.getElementById('playerDetailClause');
            const positionsEl = document.getElementById('playerAllPositions');
            
            if (initialEl) initialEl.textContent = player.name ? player.name.charAt(0) : '';
            if (positionEl) {
                positionEl.textContent = player.positionName || '';
                positionEl.className = 'position-badge ' + getPositionColorClass(player.mainPosition);
            }
            if (nameEl) nameEl.textContent = player.name || '';
            if (teamEl) teamEl.textContent = player.team || '';
            
            const rating = Math.min(10, ((player.ca || 0) / 200) * 10).toFixed(1);
            if (ratingEl) ratingEl.textContent = rating;
            
            if (caEl) caEl.textContent = player.ca || 0;
            if (paEl) paEl.textContent = player.pa || 0;
            if (ageEl) ageEl.textContent = (player.age || 0) + '岁';
            if (nationEl) nationEl.textContent = player.nation || '';
            if (heightEl) heightEl.textContent = (player.height || 0) + 'cm';
            if (weightEl) weightEl.textContent = (player.weight || 0) + 'kg';
            if (team2El) team2El.textContent = player.team || '';
            if (contractEl) contractEl.textContent = player.contractEnd || '未到期';
            if (wageEl) wageEl.textContent = (player.wage || 0) + '万';
            if (clauseEl) clauseEl.textContent = player.clause ? player.clause + '万' : '无';
            
            if (positionsEl) {
                positionsEl.innerHTML = (player.allPositions || []).map((pos, idx) => {
                    const posCat = getPositionCategory(pos);
                    return `<span class="position-badge ${getPositionColorClass(posCat)}">${pos}</span>`;
                }).join('');
            }
            
            // 渲染额外信息（性格、强弱项、伤病记录）
            renderPlayerExtraInfo(player.name);
            
            const detailPage = document.getElementById('playerDetailPage');
            if (detailPage) detailPage.classList.remove('hidden');
            
            pushPageState('playerDetail', { playerId: playerId });
        }
        
        function startPK() {
            if (!currentPKPlayer) return;
            const modal = document.getElementById('pkSelectModal');
            if (modal) modal.classList.add('show');
            renderPKSelectList();
            
            pushPageState('pkSelect');
        }
        
        function renderPKSelectList(filterText = '') {
            const container = document.getElementById('pkSelectList');
            if (!container) return;
            
            let candidates = playersData
                .filter(p => p.id !== currentPKPlayer.id)
                .sort((a, b) => (b.ca || 0) - (a.ca || 0))
                .slice(0, 50);
            
            if (filterText) {
                const lower = filterText.toLowerCase();
                candidates = playersData.filter(p => 
                    p.id !== currentPKPlayer.id && 
                    p.name && p.name.toLowerCase().includes(lower)
                );
            }
            
            container.innerHTML = candidates.map(player => `
                <div class="pk-select-item" onclick="selectPKPlayer(${player.id})">
                    <div class="pk-select-avatar">${player.name ? player.name.charAt(0) : '?'}</div>
                    <div class="flex-1">
                        <div class="font-medium text-sm dark:text-gray-100">${player.name || ''}</div>
                        <div class="text-xs text-gray-500">${player.team || ''} · CA${player.ca || 0} · ${player.positionName || ''}</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </div>
            `).join('');
        }
        
        function filterPKPlayers(text) {
            renderPKSelectList(text);
        }
        
        function selectPKPlayer(playerId) {
            pkPlayer2 = playersData.find(p => p.id === playerId);
            if (!pkPlayer2) return;
            
            closePKSelectModal();
            showPKResult();
        }
        
        function closePKSelectModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('pkSelectModal');
            if (modal) modal.classList.remove('show');
        }
        
        function showPKResult() {
            const page = document.getElementById('pkResultPage');
            const header1 = document.getElementById('pkPlayer1Header');
            const header2 = document.getElementById('pkPlayer2Header');
            const content = document.getElementById('pkComparisonContent');
            
            if (!page || !header1 || !header2 || !content) return;
            
            header1.innerHTML = `
                <div class="pk-player-avatar">${currentPKPlayer.name ? currentPKPlayer.name.charAt(0) : '?'}</div>
                <div>
                    <div class="font-bold text-lg">${currentPKPlayer.name || ''}</div>
                    <div class="text-sm opacity-80">${currentPKPlayer.team || ''}</div>
                    <div class="text-xs opacity-60 mt-1">CA: ${currentPKPlayer.ca || 0} | PA: ${currentPKPlayer.pa || 0}</div>
                </div>
            `;
            
            header2.innerHTML = `
                <div class="pk-player-avatar">${pkPlayer2.name ? pkPlayer2.name.charAt(0) : '?'}</div>
                <div>
                    <div class="font-bold text-lg">${pkPlayer2.name || ''}</div>
                    <div class="text-sm opacity-80">${pkPlayer2.team || ''}</div>
                    <div class="text-xs opacity-60 mt-1">CA: ${pkPlayer2.ca || 0} | PA: ${pkPlayer2.pa || 0}</div>
                </div>
            `;
            
            const comparisons = [
                { name: '当前能力(CA)', key: 'ca', max: 200 },
                { name: '潜力(PA)', key: 'pa', max: 200 },
                { name: '年龄', key: 'age', max: 40, reverse: true },
                { name: '身高', key: 'height', max: 210 },
                { name: '体重', key: 'weight', max: 100 },
                { name: '年薪', key: 'wage', max: 50 }
            ];
            
            content.innerHTML = comparisons.map(stat => {
                const val1 = parseFloat(currentPKPlayer[stat.key]) || 0;
                const val2 = parseFloat(pkPlayer2[stat.key]) || 0;
                
                let winner = '';
                if (stat.reverse) {
                    winner = val1 < val2 ? 'left' : (val2 < val1 ? 'right' : 'equal');
                } else {
                    winner = val1 > val2 ? 'left' : (val2 > val1 ? 'right' : 'equal');
                }
                
                const percent1 = Math.min(100, (val1 / stat.max) * 100);
                const percent2 = Math.min(100, (val2 / stat.max) * 100);
                
                const class1 = winner === 'left' ? 'pk-winner' : (winner === 'equal' ? 'pk-equal' : 'pk-loser');
                const class2 = winner === 'right' ? 'pk-winner' : (winner === 'equal' ? 'pk-equal' : 'pk-loser');
                
                return `
                    <div class="pk-comparison-row">
                        <div class="pk-stat-value ${class1}">${val1}</div>
                        <div class="pk-stat-bar-container">
                            <div class="pk-stat-bar">
                                <div class="pk-stat-bar-fill left" style="width: ${percent1}%; float: right; margin-right: 50%; border-radius: 4px 0 0 4px;"></div>
                            </div>
                            <div class="pk-stat-name">${stat.name}</div>
                            <div class="pk-stat-bar">
                                <div class="pk-stat-bar-fill right" style="width: ${percent2}%; border-radius: 0 4px 4px 0;"></div>
                            </div>
                        </div>
                        <div class="pk-stat-value ${class2}">${val2}</div>
                    </div>
                `;
            }).join('') + `
                <div class="mt-4 bg-white dark:bg-dark-surface rounded-lg p-4">
                    <h4 class="font-bold mb-3 dark:text-gray-100">位置对比</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-sm text-gray-500 mb-1">${currentPKPlayer.name || ''}</div>
                            <div class="flex flex-wrap gap-1">
                                ${(currentPKPlayer.allPositions || []).map(pos => `<span class="position-badge ${getPositionColorClass(getPositionCategory(pos))} text-xs">${pos}</span>`).join('')}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-500 mb-1">${pkPlayer2.name || ''}</div>
                            <div class="flex flex-wrap gap-1 justify-end">
                                ${(pkPlayer2.allPositions || []).map(pos => `<span class="position-badge ${getPositionColorClass(getPositionCategory(pos))} text-xs">${pos}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            page.classList.add('show');
            document.body.style.overflow = 'hidden';
            
            pushPageState('pkResult');
        }
        
        function closePKResult() {
            const page = document.getElementById('pkResultPage');
            if (page) page.classList.remove('show');
            document.body.style.overflow = '';
        }
        
        function sharePKResult() {
            if (navigator.share) {
                navigator.share({
                    title: '球员对比',
                    text: `${currentPKPlayer.name || ''} vs ${pkPlayer2.name || ''}`,
                    url: window.location.href
                });
            } else {
                alert('对比结果已生成！');
            }
        }
        
        function backToTeamDetail() {
            const detailPage = document.getElementById('playerDetailPage');
            if (detailPage) detailPage.classList.add('hidden');
        }
        
        function sharePlayer() {
            const playerName = document.getElementById('playerDetailName')?.textContent || '';
            if (navigator.share) {
                navigator.share({
                    title: playerName,
                    text: `查看${playerName}的详细资料`,
                    url: window.location.href
                });
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            
            document.querySelectorAll('.bottom-nav-item').forEach(btn => {
                btn.classList.remove('active', 'text-emerald-600', 'dark:text-emerald-400');
                btn.classList.add('text-gray-400', 'dark:text-gray-500');
                if (btn.dataset.tab === tab) {
                    btn.classList.add('active', 'text-emerald-600', 'dark:text-emerald-400');
                    btn.classList.remove('text-gray-400', 'dark:text-gray-500');
                }
            });
            
            const newsFeed = document.getElementById('newsFeed');
            const teamPage = document.getElementById('teamPage');
            const transferPage = document.getElementById('transferPage');
            const dataPage = document.getElementById('dataPage');
            const discussionPage = document.getElementById('discussionPage');
            const homeTabs = document.getElementById('homeTabs');
            const pullIndicator = document.getElementById('pullIndicator');
            const mainHeader = document.getElementById('mainHeader');
            
            if (newsFeed) newsFeed.classList.add('hidden');
            if (teamPage) teamPage.classList.add('hidden');
            if (transferPage) transferPage.classList.add('hidden');
            if (dataPage) dataPage.classList.add('hidden');
            if (discussionPage) discussionPage.classList.add('hidden');
            if (homeTabs) homeTabs.classList.add('hidden');
            if (pullIndicator) pullIndicator.classList.add('hidden');
            
            if (tab === 'home') {
                if (newsFeed) newsFeed.classList.remove('hidden');
                if (homeTabs) homeTabs.classList.remove('hidden');
                if (pullIndicator) pullIndicator.classList.remove('hidden');
                if (mainHeader) mainHeader.classList.remove('hidden');
                loadRSS().catch(e => console.error('加载RSS失败:', e));
            } else if (tab === 'team') {
                if (teamPage) teamPage.classList.remove('hidden');
                if (mainHeader) mainHeader.classList.remove('hidden');
                if (teamData.length === 0) {
                    loadTeamData().catch(e => console.error('加载球队数据失败:', e));
                }
            } else if (tab === 'transfer') {
                if (transferPage) transferPage.classList.remove('hidden');
                if (mainHeader) mainHeader.classList.remove('hidden');
                const iframe = document.getElementById('transferIframe');
                if (iframe && !iframe.src) {
                    iframe.src = 'https://suttergov.github.io/transfermarkt.html';
                }
            } else if (tab === 'data') {
                if (dataPage) dataPage.classList.remove('hidden');
                if (mainHeader) mainHeader.classList.remove('hidden');
            } else if (tab === 'discussion') {
                if (discussionPage) discussionPage.classList.remove('hidden');
                // 广场页面有自己的header，隐藏主header避免重复
                if (mainHeader) mainHeader.classList.add('hidden');
                loadSquarePosts();
            }
            
            if (!isPopState) {
                pushPageState(tab);
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function stripHtml(html) {
            if (!html) return '';
            const tmp = document.createElement('div');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }

        function formatTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = (now - date) / 1000;
            
            if (diff < 60) return '刚刚';
            if (diff < 3600) return `${Math.floor(diff/60)}分钟前`;
            if (diff < 86400) return `${Math.floor(diff/3600)}小时前`;
            if (diff < 604800) return `${Math.floor(diff/86400)}天前`;
            return date.toLocaleDateString('zh-CN', {month: 'short', day: 'numeric'});
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeArticle();
                backToTeamDetail();
                backToTeamList();
                closeSearch();
                closePKSelectModal();
                closePKResult();
                closeSpecialPlayersPage();
                closeProfilePage();
                closeLoginModal();
                closeCommentModal();
                closeImagePreview();
                closeSwitchAccountModal();
            }
        });
        
        window.addEventListener('resize', () => {
            if (currentTeam) {
                const statsContent = document.getElementById('statsContent');
                if (statsContent && !statsContent.classList.contains('hidden')) {
                    const historyData = getTeamHistoryData(currentTeam.name);
                    if (historyData && historyData.rankings) {
                        const sortedRankings = Object.entries(historyData.rankings)
                            .sort((a, b) => {
                                const numA = parseInt(a[0].replace(/[^0-9]/g, ''));
                                const numB = parseInt(b[0].replace(/[^0-9]/g, ''));
                                return numA - numB;
                            });
                        drawRankingChart(sortedRankings);
                    }
                }
            }
        });

        async function loadTeamHistoryData() {
            if (isLoadingTeamHistory) return;
            isLoadingTeamHistory = true;
            
            try {
                console.log('开始加载球队历史数据...');
                const response = await fetch(CONFIG.teamHistoryUrl + '?t=' + new Date().getTime(), {
                    signal: AbortSignal.timeout(10000)
                });
                
                if (!response.ok) throw new Error('无法加载历史数据: ' + response.status);
                
                const text = await response.text();
                console.log('获取到历史数据文本长度:', text.length);
                
                parseTeamHistoryData(text);
                localStorage.setItem('team_history_cache', JSON.stringify(teamHistoryData));
                console.log('解析完成，球队数量:', Object.keys(teamHistoryData).length);
                
            } catch (error) {
                console.error('加载球队历史数据失败:', error);
                const savedTeamHistory = localStorage.getItem('team_history_cache');
                if (savedTeamHistory) {
                    try {
                        teamHistoryData = JSON.parse(savedTeamHistory);
                    } catch (e) {
                        teamHistoryData = {};
                    }
                }
            } finally {
                isLoadingTeamHistory = false;
            }
        }

        function parseTeamHistoryData(text) {
            const normalizedText = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            const lines = normalizedText.split('\n');
            let currentTeamName = null;
            let currentSection = null;
            let currentScorerBuffer = [];
            
            teamHistoryData = {};
            
            lines.forEach((line, index) => {
                line = line.trim();
                if (!line) return;
                
                if (line.startsWith('==') && line.endsWith('==')) {
                    if (currentTeamName && currentScorerBuffer.length > 0 && teamHistoryData[currentTeamName]) {
                        teamHistoryData[currentTeamName].topScorers = [...currentScorerBuffer];
                        currentScorerBuffer = [];
                    }
                    
                    currentTeamName = line.slice(2, -2).trim();
                    if (currentTeamName && !teamHistoryData[currentTeamName]) {
                        teamHistoryData[currentTeamName] = {
                            nameChanges: '',
                            rankings: {},
                            topScorers: [],
                            honors: []
                        };
                    }
                    currentSection = null;
                    console.log('解析到球队:', currentTeamName);
                } else if (currentTeamName && teamHistoryData[currentTeamName]) {
                    if (line.startsWith('=') && line.endsWith('=') && !line.startsWith('==')) {
                        if (currentSection === 'scorers' && currentScorerBuffer.length > 0) {
                            teamHistoryData[currentTeamName].topScorers = [...currentScorerBuffer];
                            currentScorerBuffer = [];
                        }
                        
                        const sectionName = line.slice(1, -1).trim();
                        if (sectionName.includes('变迁') || sectionName.includes('历史') || sectionName === '球队变迁') {
                            currentSection = 'changes';
                        } else if (sectionName.includes('排名') || sectionName === '近年联赛排名') {
                            currentSection = 'rankings';
                        } else if (sectionName.includes('射手') || sectionName === '历史射手榜') {
                            currentSection = 'scorers';
                        } else if (sectionName.includes('荣誉') || sectionName === '球队荣誉') {
                            currentSection = 'honors';
                        } else {
                            currentSection = null;
                        }
                    } else if (currentSection === 'changes') {
                        teamHistoryData[currentTeamName].nameChanges += line + '<br>';
                    } else if (currentSection === 'rankings') {
                        const match = line.match(/(S\d+)[:：]\s*(\d+)/);
                        if (match) {
                            teamHistoryData[currentTeamName].rankings[match[1]] = {
                                season: match[1],
                                rank: parseInt(match[2])
                            };
                        }
                    } else if (currentSection === 'scorers') {
                        const parts = line.split(/\s+/);
                        if (parts.length >= 2) {
                            const goals = parseInt(parts[parts.length - 1]);
                            const name = parts.slice(0, parts.length - 1).join(' ');
                            if (!isNaN(goals) && name) {
                                currentScorerBuffer.push({
                                    name: name,
                                    goals: goals
                                });
                            }
                        }
                    } else if (currentSection === 'honors') {
                        const honorMatch = line.match(/^(.+?)\s+(冠军|亚军|季军)\s*(S\d+)?$/);
                        if (honorMatch) {
                            teamHistoryData[currentTeamName].honors.push({
                                competition: honorMatch[1].trim(),
                                rank: honorMatch[2],
                                season: honorMatch[3] || ''
                            });
                        } else {
                            const simpleMatch = line.match(/^(.+?)\s+(冠军|亚军|季军)$/);
                            if (simpleMatch) {
                                teamHistoryData[currentTeamName].honors.push({
                                    competition: simpleMatch[1].trim(),
                                    rank: simpleMatch[2],
                                    season: ''
                                });
                            }
                        }
                    }
                }
            });
            
            if (currentTeamName && currentScorerBuffer.length > 0 && teamHistoryData[currentTeamName]) {
                teamHistoryData[currentTeamName].topScorers = [...currentScorerBuffer];
            }
        }

        function getTeamHistoryData(teamName) {
            if (!teamName) return null;
            if (teamHistoryData[teamName]) {
                return teamHistoryData[teamName];
            }
            
            const normalizedInput = normalizeTeamName(teamName);
            for (const key in teamHistoryData) {
                if (normalizeTeamName(key) === normalizedInput) {
                    return teamHistoryData[key];
                }
            }
            
            return null;
        }

        // 新增：加载球员额外信息（性格、强弱项、伤病记录）
        async function loadPlayerExtraData() {
            const cached = localStorage.getItem('player_extra_data');
            const cacheTime = localStorage.getItem('player_extra_data_time');
            const now = Date.now();
            
            // 1小时缓存
            if (cached && cacheTime && (now - parseInt(cacheTime) < 3600000)) {
                playerExtraData = JSON.parse(cached);
                console.log('使用缓存的球员额外信息');
                return;
            }
            
            try {
                const response = await fetch(CONFIG.playerInfoUrl + '?t=' + now);
                if (!response.ok) throw new Error('无法加载球员信息');
                
                const text = await response.text();
                playerExtraData = parsePlayerInfoText(text);
                
                localStorage.setItem('player_extra_data', JSON.stringify(playerExtraData));
                localStorage.setItem('player_extra_data_time', now.toString());
                console.log('已加载并缓存球员额外信息，共', Object.keys(playerExtraData).length, '人');
            } catch (error) {
                console.error('加载球员额外信息失败:', error);
                if (cached) {
                    playerExtraData = JSON.parse(cached);
                }
            }
        }

        // 新增：解析球员信息文本
        function parsePlayerInfoText(text) {
            const data = {};
            const lines = text.split('\n');
            let currentPlayer = null;
            let currentField = null;
            
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                
                // 匹配球员名 ==球员名==
                const playerMatch = line.match(/^==(.+)==$/);
                if (playerMatch) {
                    currentPlayer = playerMatch[1].trim();
                    data[currentPlayer] = {};
                    currentField = null;
                    return;
                }
                
                // 匹配字段 =字段名=
                const fieldMatch = line.match(/^=(.+)=/);
                if (fieldMatch) {
                    currentField = fieldMatch[1].trim();
                    if (currentPlayer) {
                        data[currentPlayer][currentField] = [];
                    }
                    return;
                }
                
                // 普通内容行
                if (currentPlayer && currentField) {
                    data[currentPlayer][currentField].push(line);
                }
            });
            
            // 将数组转为字符串
            Object.keys(data).forEach(player => {
                Object.keys(data[player]).forEach(field => {
                    data[player][field] = data[player][field].join('\n');
                });
            });
            
            return data;
        }

        // 新增：渲染球员额外信息
        function renderPlayerExtraInfo(playerName) {
            const extraInfo = playerExtraData[playerName];
            const container = document.getElementById('playerExtraInfo');
            const personalitySection = document.getElementById('playerPersonalitySection');
            const personalityEl = document.getElementById('playerPersonality');
            const traitsSection = document.getElementById('playerTraitsSection');
            const traitsEl = document.getElementById('playerTraits');
            const strengthsEl = document.getElementById('playerStrengths');
            const weaknessesEl = document.getElementById('playerWeaknesses');
            const injurySection = document.getElementById('playerInjurySection');
            const injuryList = document.getElementById('playerInjuryList');
            
            if (!extraInfo) {
                container.classList.add('hidden');
                injurySection.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            
            // 性格
            if (extraInfo['球员性格']) {
                personalitySection.classList.remove('hidden');
                const personalities = extraInfo['球员性格'].split(/[、,，]/).filter(p => p.trim());
                personalityEl.innerHTML = personalities.map(p => 
                    `<span class="trait-tag personality">${p.trim()}</span>`
                ).join('');
            } else {
                personalitySection.classList.add('hidden');
            }
            
            // 强项弱项使用示意图中的样式
            let hasTraits = false;
            
            // 技术特点（如果有）
            if (extraInfo['技术特点']) {
                hasTraits = true;
                const traits = extraInfo['技术特点'].split(/[、,，]/).filter(t => t.trim());
                traitsEl.innerHTML = traits.map(t => 
                    `<span class="trait-tag style">${t.trim()}</span>`
                ).join('');
            } else {
                traitsEl.innerHTML = '';
            }
            
            // 强项 - 红色标签
            if (extraInfo['球员强项']) {
                hasTraits = true;
                const strengths = extraInfo['球员强项'].split(/[、,，]/).filter(s => s.trim());
                strengthsEl.innerHTML = strengths.map(s => 
                    `<span class="trait-tag strength"><i class="fas fa-arrow-up mr-1"></i>${s.trim()}</span>`
                ).join('');
            } else {
                strengthsEl.innerHTML = '';
            }
            
            // 弱项 - 蓝色标签
            if (extraInfo['球员弱项']) {
                hasTraits = true;
                const weaknesses = extraInfo['球员弱项'].split(/[、,，]/).filter(w => w.trim());
                weaknessesEl.innerHTML = weaknesses.map(w => 
                    `<span class="trait-tag weakness"><i class="fas fa-arrow-down mr-1"></i>${w.trim()}</span>`
                ).join('');
            } else {
                weaknessesEl.innerHTML = '';
            }
            
            if (!hasTraits) {
                traitsSection.classList.add('hidden');
            } else {
                traitsSection.classList.remove('hidden');
            }
            
            // 伤病记录 - 表格形式
            if (extraInfo['伤病记录']) {
                injurySection.classList.remove('hidden');
                const injuries = parseInjuries(extraInfo['伤病记录']);
                if (injuries.length > 0) {
                    injuryList.innerHTML = injuries.map(inj => `
                        <tr>
                            <td class="px-3 py-3">
                                <span class="injury-badge">
                                    <i class="fas fa-band-aid text-xs"></i>
                                    ${inj.type}
                                </span>
                            </td>
                            <td class="px-3 py-3 text-center injury-time">
                                <i class="far fa-clock mr-1"></i>
                                ${inj.time}
                            </td>
                            <td class="px-3 py-3 text-right text-gray-500 dark:text-gray-400 text-xs">
                                ${inj.season || ''}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    injuryList.innerHTML = '<tr><td colspan="3" class="px-3 py-4 text-center text-gray-400">暂无详细记录</td></tr>';
                }
            } else {
                injurySection.classList.add('hidden');
            }
        }

        // 新增：解析伤病记录
        function parseInjuries(injuryText) {
            const injuries = [];
            const lines = injuryText.split('\n');
            
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                
                // 格式：第四赛季 腘绳肌撕裂 修养时间：12天
                const match = line.match(/^(.+?)\s+(.+?)\s+修养时间[：:]\s*(.+)$/);
                if (match) {
                    injuries.push({
                        season: match[1].trim(),
                        type: match[2].trim(),
                        time: match[3].trim()
                    });
                } else {
                    // 简单格式，直接显示整行
                    injuries.push({
                        season: '',
                        type: line,
                        time: '-'
                    });
                }
            });
            
            return injuries;
        }

        // 文本域自动调整
        document.getElementById('postTextarea')?.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
            document.getElementById('postSubmitBtn').disabled = !this.value.trim() && !selectedImages.length;
        });

        // 高亮搜索文本
        function highlightText(text, keyword) {
            if (!keyword) return text;
            const regex = new RegExp(`(${keyword})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }
    </script>
</body>
</html>
